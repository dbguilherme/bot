import{UIString as t,Color as e,ls as s,ObjectWrapper as i}from"../common/common.js";import{NumberUtilities as n}from"../platform/platform.js";import{Geometry as r,Widget as o,UIUtils as a,Utils as h,Icon as l,KeyboardShortcut as d,GlassPane as c}from"../ui/ui.js";import{TextUtils as u}from"../text_utils/text_utils.js";import{GetStylesheet as _}from"../component_helpers/component_helpers.js";import*as p from"../third_party/lit-html/lit-html.js";class m{constructor(t,e,s,i,n){this.width=t,this.height=e,this.marginTop=s,this.radius=i,this.linearLine=n}static drawVelocityChart(t,e,s){const i=f;let n=["M",0,i];let r=t.evaluateAt(0);for(let e=1/40;e<1.025;e+=1/40){const o=t.evaluateAt(e);let a=(o.y-r.y)/(o.x-r.x);const h=r.x*(1-e)+o.x*e;a=Math.tanh(a/1.5),n=n.concat(["L",(h*s).toFixed(2),(i-a*i).toFixed(2)]),r=o}n=n.concat(["L",s.toFixed(2),i,"Z"]),e.setAttribute("d",n.join(" "))}curveWidth(){return this.width-2*this.radius}curveHeight(){return this.height-2*this.radius-2*this.marginTop}_drawLine(t,e,s,i,n,r){const o=t.createSVGChild("line",e);o.setAttribute("x1",s+this.radius),o.setAttribute("y1",i+this.radius+this.marginTop),o.setAttribute("x2",n+this.radius),o.setAttribute("y2",r+this.radius+this.marginTop)}_drawControlPoints(t,e,s,i,n){this._drawLine(t,"bezier-control-line",e,s,i,n);const r=t.createSVGChild("circle","bezier-control-circle");r.setAttribute("cx",i+this.radius),r.setAttribute("cy",n+this.radius+this.marginTop),r.setAttribute("r",this.radius)}drawCurve(t,e){if(!t)return;const s=this.curveWidth(),i=this.curveHeight();e.setAttribute("width",this.width),e.setAttribute("height",this.height),e.removeChildren();const n=e.createSVGChild("g");this.linearLine&&this._drawLine(n,"linear-line",0,i,s,0);const o=n.createSVGChild("path","bezier-path"),a=[new r.Point(t.controlPoints[0].x*s+this.radius,(1-t.controlPoints[0].y)*i+this.radius+this.marginTop),new r.Point(t.controlPoints[1].x*s+this.radius,(1-t.controlPoints[1].y)*i+this.radius+this.marginTop),new r.Point(s+this.radius,this.marginTop+this.radius)];o.setAttribute("d","M"+this.radius+","+(i+this.radius+this.marginTop)+" C"+a.join(" ")),this._drawControlPoints(n,0,i,t.controlPoints[0].x*s,(1-t.controlPoints[0].y)*i),this._drawControlPoints(n,s,0,t.controlPoints[1].x*s,(1-t.controlPoints[1].y)*i)}}const f=26;var v=Object.freeze({__proto__:null,BezierUI:m,Height:f});class S extends o.VBox{constructor(){super(!0),this.registerRequiredCSS("inline_editor/bezierEditor.css"),this.contentElement.tabIndex=0,this.setDefaultFocusedElement(this.contentElement),this._previewElement=this.contentElement.createChild("div","bezier-preview-container"),this._previewElement.createChild("div","bezier-preview-animation"),this._previewElement.addEventListener("click",this._startPreviewAnimation.bind(this)),this._previewOnion=this.contentElement.createChild("div","bezier-preview-onion"),this._previewOnion.addEventListener("click",this._startPreviewAnimation.bind(this)),this._outerContainer=this.contentElement.createChild("div","bezier-container"),this._presetsContainer=this._outerContainer.createChild("div","bezier-presets"),this._presetUI=new m(40,40,0,2,!1),this._presetCategories=[];for(let t=0;t<w.length;t++)this._presetCategories[t]=this._createCategory(w[t]),this._presetsContainer.appendChild(this._presetCategories[t].icon);this._curveUI=new m(150,250,50,7,!0),this._curve=this._outerContainer.createSVGChild("svg","bezier-curve"),a.installDragHandle(this._curve,this._dragStart.bind(this),this._dragMove.bind(this),this._dragEnd.bind(this),"default"),this._header=this.contentElement.createChild("div","bezier-header");const t=this._createPresetModifyIcon(this._header,"bezier-preset-minus","M 12 6 L 8 10 L 12 14"),e=this._createPresetModifyIcon(this._header,"bezier-preset-plus","M 8 6 L 12 10 L 8 14");t.addEventListener("click",this._presetModifyClicked.bind(this,!1)),e.addEventListener("click",this._presetModifyClicked.bind(this,!0)),this._label=this._header.createChild("span","source-code bezier-display-value")}setBezier(t){t&&(this._bezier=t,this._updateUI())}bezier(){return this._bezier}wasShown(){this._unselectPresets();for(const t of this._presetCategories)for(let e=0;e<t.presets.length;e++)this._bezier.asCSSText()===t.presets[e].value&&(t.presetIndex=e,this._presetCategorySelected(t));this._updateUI(),this._startPreviewAnimation()}_onchange(){this._updateUI(),this.dispatchEventToListeners(C.BezierChanged,this._bezier.asCSSText())}_updateUI(){const e=this._selectedCategory?this._selectedCategory.presets[this._selectedCategory.presetIndex].name:this._bezier.asCSSText().replace(/\s(-\d\.\d)/g,"$1");this._label.textContent=t.UIString(e),this._curveUI.drawCurve(this._bezier,this._curve),this._previewOnion.removeChildren()}_dragStart(t){this._mouseDownPosition=new r.Point(t.x,t.y);const e=this._curveUI;this._controlPosition=new r.Point(n.clamp((t.offsetX-e.radius)/e.curveWidth(),0,1),(e.curveHeight()+e.marginTop+e.radius-t.offsetY)/e.curveHeight());const s=this._controlPosition.distanceTo(this._bezier.controlPoints[0])<this._controlPosition.distanceTo(this._bezier.controlPoints[1]);return this._selectedPoint=s?0:1,this._bezier.controlPoints[this._selectedPoint]=this._controlPosition,this._unselectPresets(),this._onchange(),t.consume(!0),!0}_updateControlPosition(t,e){const s=(t-this._mouseDownPosition.x)/this._curveUI.curveWidth(),i=(e-this._mouseDownPosition.y)/this._curveUI.curveHeight(),o=new r.Point(n.clamp(this._controlPosition.x+s,0,1),this._controlPosition.y-i);this._bezier.controlPoints[this._selectedPoint]=o}_dragMove(t){this._updateControlPosition(t.x,t.y),this._onchange()}_dragEnd(t){this._updateControlPosition(t.x,t.y),this._onchange(),this._startPreviewAnimation()}_createCategory(t){const e=document.createElement("div");e.classList.add("bezier-preset-category");const s=e.createSVGChild("svg","bezier-preset monospace"),i={presets:t,presetIndex:0,icon:e};return this._presetUI.drawCurve(r.CubicBezier.parse(i.presets[0].value),s),s.addEventListener("click",this._presetCategorySelected.bind(this,i)),i}_createPresetModifyIcon(t,e,s){const i=t.createSVGChild("svg","bezier-preset-modify "+e);i.setAttribute("width",20),i.setAttribute("height",20);return i.createSVGChild("path").setAttribute("d",s),i}_unselectPresets(){for(const t of this._presetCategories)t.icon.classList.remove("bezier-preset-selected");delete this._selectedCategory,this._header.classList.remove("bezier-header-active")}_presetCategorySelected(t,e){this._selectedCategory!==t&&(this._unselectPresets(),this._header.classList.add("bezier-header-active"),this._selectedCategory=t,this._selectedCategory.icon.classList.add("bezier-preset-selected"),this.setBezier(r.CubicBezier.parse(t.presets[t.presetIndex].value)),this._onchange(),this._startPreviewAnimation(),e&&e.consume(!0))}_presetModifyClicked(t,e){if(!this._selectedCategory)return;const s=this._selectedCategory.presets.length;this._selectedCategory.presetIndex=(this._selectedCategory.presetIndex+(t?1:-1)+s)%s,this.setBezier(r.CubicBezier.parse(this._selectedCategory.presets[this._selectedCategory.presetIndex].value)),this._onchange(),this._startPreviewAnimation()}_startPreviewAnimation(){this._previewAnimation&&this._previewAnimation.cancel();const t=[{offset:0,transform:"translateX(0px)",easing:this._bezier.asCSSText(),opacity:1},{offset:.9,transform:"translateX(218px)",opacity:1},{offset:1,transform:"translateX(218px)",opacity:0}];this._previewAnimation=this._previewElement.animate(t,1600),this._previewOnion.removeChildren();for(let t=0;t<=20;t++){const e=this._previewOnion.createChild("div","bezier-preview-animation").animate([{transform:"translateX(0px)",easing:this._bezier.asCSSText()},{transform:"translateX(218px)"}],{duration:1600,fill:"forwards"});e.pause(),e.currentTime=1600*t/20}}}const C={BezierChanged:Symbol("BezierChanged")},w=[[{name:"ease-in-out",value:"ease-in-out"},{name:"In Out · Sine",value:"cubic-bezier(0.45, 0.05, 0.55, 0.95)"},{name:"In Out · Quadratic",value:"cubic-bezier(0.46, 0.03, 0.52, 0.96)"},{name:"In Out · Cubic",value:"cubic-bezier(0.65, 0.05, 0.36, 1)"},{name:"Fast Out, Slow In",value:"cubic-bezier(0.4, 0, 0.2, 1)"},{name:"In Out · Back",value:"cubic-bezier(0.68, -0.55, 0.27, 1.55)"}],[{name:"Fast Out, Linear In",value:"cubic-bezier(0.4, 0, 1, 1)"},{name:"ease-in",value:"ease-in"},{name:"In · Sine",value:"cubic-bezier(0.47, 0, 0.75, 0.72)"},{name:"In · Quadratic",value:"cubic-bezier(0.55, 0.09, 0.68, 0.53)"},{name:"In · Cubic",value:"cubic-bezier(0.55, 0.06, 0.68, 0.19)"},{name:"In · Back",value:"cubic-bezier(0.6, -0.28, 0.74, 0.05)"}],[{name:"ease-out",value:"ease-out"},{name:"Out · Sine",value:"cubic-bezier(0.39, 0.58, 0.57, 1)"},{name:"Out · Quadratic",value:"cubic-bezier(0.25, 0.46, 0.45, 0.94)"},{name:"Out · Cubic",value:"cubic-bezier(0.22, 0.61, 0.36, 1)"},{name:"Linear Out, Slow In",value:"cubic-bezier(0, 0, 0.2, 1)"},{name:"Out · Back",value:"cubic-bezier(0.18, 0.89, 0.32, 1.28)"}]];var g=Object.freeze({__proto__:null,BezierEditor:S,Events:C,Presets:w,PresetCategory:void 0});class x extends HTMLSpanElement{constructor(){super();const e=h.createShadowRootWithCoreStyles(this,"inline_editor/colorSwatch.css");this._iconElement=e.createChild("span","color-swatch"),this._iconElement.title=t.UIString("Shift-click to change color format"),this._swatchInner=this._iconElement.createChild("span","color-swatch-inner"),this._swatchInner.addEventListener("dblclick",t=>t.consume(),!1),this._swatchInner.addEventListener("mousedown",t=>t.consume(),!1),this._swatchInner.addEventListener("click",this._handleClick.bind(this),!0),e.createChild("slot"),this._colorValueElement=this.createChild("span")}static create(){return x._constructor||(x._constructor=h.registerCustomElement("span","color-swatch",x)),x._constructor()}static _nextColorFormat(t,s){const i=e.Format;switch(s){case i.Original:return t.hasAlpha()?i.RGBA:i.RGB;case i.RGB:case i.RGBA:return t.hasAlpha()?i.HSLA:i.HSL;case i.HSL:case i.HSLA:return t.nickname()?i.Nickname:t.detectHEXFormat();case i.ShortHEX:return i.HEX;case i.ShortHEXA:return i.HEXA;case i.HEXA:case i.HEX:return i.Original;case i.Nickname:return t.detectHEXFormat();default:return i.RGBA}}color(){return this._color}setColor(t){this._color=t,this._format=this._color.format();const e=this._color.asString(this._format);this.setText(e),this._swatchInner.style.backgroundColor=e}hideText(t){this._colorValueElement.hidden=t}setText(t,e){this._colorValueElement.textContent=t,this._colorValueElement.title=e}format(){return this._format}setFormat(t){this._format=t,this.setText(this._color.asString(this._format))}toggleNextFormat(){let t;do{this._format=x._nextColorFormat(this._color,this._format),t=this._color.asString(this._format)}while(t===this._colorValueElement.textContent);this.setText(t)}iconElement(){return this._iconElement}_handleClick(t){t.shiftKey&&(t.target.parentNode.parentNode.host.toggleNextFormat(),t.consume(!0))}}class b extends HTMLSpanElement{constructor(){super();const t=h.createShadowRootWithCoreStyles(this,"inline_editor/bezierSwatch.css");this._iconElement=l.Icon.create("smallicon-bezier","bezier-swatch-icon"),t.appendChild(this._iconElement),this._textElement=this.createChild("span"),t.createChild("slot")}static create(){return b._constructor||(b._constructor=h.registerCustomElement("span","bezier-swatch",b)),b._constructor()}bezierText(){return this._textElement.textContent}setBezierText(t){this._textElement.textContent=t}hideText(t){this._textElement.hidden=t}iconElement(){return this._iconElement}}class E extends HTMLSpanElement{constructor(){super();const t=h.createShadowRootWithCoreStyles(this,"inline_editor/cssShadowSwatch.css");this._iconElement=l.Icon.create("smallicon-shadow","shadow-swatch-icon"),t.appendChild(this._iconElement),t.createChild("slot"),this._contentElement=this.createChild("span")}static create(){return E._constructor||(E._constructor=h.registerCustomElement("span","css-shadow-swatch",E)),E._constructor()}model(){return this._model}setCSSShadow(t){this._model=t,this._contentElement.removeChildren();const s=u.Utils.splitStringByRegexes(t.asCSSText(),[/inset/g,e.Regex]);for(let e=0;e<s.length;e++){const i=s[e];1===i.regexIndex?(this._colorSwatch||(this._colorSwatch=x.create()),this._colorSwatch.setColor(t.color()),this._contentElement.appendChild(this._colorSwatch)):this._contentElement.appendChild(createTextNode(i.value))}}hideText(t){this._contentElement.hidden=t}iconElement(){return this._iconElement}colorSwatch(){return this._colorSwatch}}var y=Object.freeze({__proto__:null,ColorSwatch:x,BezierSwatch:b,CSSShadowSwatch:E});class I{constructor(t){this._isBoxShadow=t,this._inset=!1,this._offsetX=z.zero(),this._offsetY=z.zero(),this._blurRadius=z.zero(),this._spreadRadius=z.zero(),this._color=e.Color.parse("black"),this._format=[T.OffsetX,T.OffsetY]}static parseTextShadow(t){return I._parseShadow(t,!1)}static parseBoxShadow(t){return I._parseShadow(t,!0)}static _parseShadow(t,s){const i=[],n=u.Utils.splitStringByRegexes(t,[e.Regex,/,/g]);let r=0;for(let e=0;e<n.length;e++)if(1===n[e].regexIndex){const s=n[e];i.push(t.substring(r,s.position)),r=s.position+1}i.push(t.substring(r,t.length));const o=[];for(let t=0;t<i.length;t++){const n=new I(s);n._format=[];let r=!0;const h=[/inset/gi,e.Regex,z.Regex],l=u.Utils.splitStringByRegexes(i[t],h);for(let t=0;t<l.length;t++){const s=l[t];if(-1===s.regexIndex){if(/\S/.test(s.value))return[];r=!0}else{if(!r)return[];if(r=!1,0===s.regexIndex)n._inset=!0,n._format.push(T.Inset);else if(1===s.regexIndex){const t=e.Color.parse(s.value);if(!t)return[];n._color=t,n._format.push(T.Color)}else if(2===s.regexIndex){const t=z.parse(s.value);if(!t)return[];const e=n._format.length>0?n._format[n._format.length-1]:"";e===T.OffsetX?(n._offsetY=t,n._format.push(T.OffsetY)):e===T.OffsetY?(n._blurRadius=t,n._format.push(T.BlurRadius)):e===T.BlurRadius?(n._spreadRadius=t,n._format.push(T.SpreadRadius)):(n._offsetX=t,n._format.push(T.OffsetX))}}}if(a(n,T.OffsetX,1,1)||a(n,T.OffsetY,1,1)||a(n,T.Color,0,1)||a(n,T.BlurRadius,0,1)||a(n,T.Inset,0,s?1:0)||a(n,T.SpreadRadius,0,s?1:0))return[];o.push(n)}return o;function a(t,e,s,i){let n=0;for(let s=0;s<t._format.length;s++)t._format[s]===e&&n++;return n<s||n>i}}setInset(t){this._inset=t,-1===this._format.indexOf(T.Inset)&&this._format.unshift(T.Inset)}setOffsetX(t){this._offsetX=t}setOffsetY(t){this._offsetY=t}setBlurRadius(t){if(this._blurRadius=t,-1===this._format.indexOf(T.BlurRadius)){const t=this._format.indexOf(T.OffsetY);this._format.splice(t+1,0,T.BlurRadius)}}setSpreadRadius(t){if(this._spreadRadius=t,-1===this._format.indexOf(T.SpreadRadius)){this.setBlurRadius(this._blurRadius);const t=this._format.indexOf(T.BlurRadius);this._format.splice(t+1,0,T.SpreadRadius)}}setColor(t){this._color=t,-1===this._format.indexOf(T.Color)&&this._format.push(T.Color)}isBoxShadow(){return this._isBoxShadow}inset(){return this._inset}offsetX(){return this._offsetX}offsetY(){return this._offsetY}blurRadius(){return this._blurRadius}spreadRadius(){return this._spreadRadius}color(){return this._color}asCSSText(){const t=[];for(let e=0;e<this._format.length;e++){const s=this._format[e];s===T.Inset&&this._inset?t.push("inset"):s===T.OffsetX?t.push(this._offsetX.asCSSText()):s===T.OffsetY?t.push(this._offsetY.asCSSText()):s===T.BlurRadius?t.push(this._blurRadius.asCSSText()):s===T.SpreadRadius?t.push(this._spreadRadius.asCSSText()):s===T.Color&&t.push(this._color.asString(this._color.format()))}return t.join(" ")}}const T={Inset:"I",OffsetX:"X",OffsetY:"Y",BlurRadius:"B",SpreadRadius:"S",Color:"C"};class z{constructor(t,e){this.amount=t,this.unit=e}static parse(t){const e=new RegExp("^(?:"+z.Regex.source+")$","i"),s=t.match(e);return s?s.length>2&&s[2]?new z(parseFloat(s[1]),s[2]):z.zero():null}static zero(){return new z(0,"")}asCSSText(){return this.amount+this.unit}}z.Regex=new RegExp("([+-]?(?:[0-9]*[.])?[0-9]+(?:[eE][+-]?[0-9]+)?)(ch|cm|em|ex|in|mm|pc|pt|px|rem|vh|vmax|vmin|vw)|[+-]?(?:0*[.])?0+(?:[eE][+-]?[0-9]+)?","gi");var P=Object.freeze({__proto__:null,CSSShadowModel:I,_Part:T,CSSLength:z});class L extends o.VBox{constructor(){super(!0),this.registerRequiredCSS("inline_editor/cssShadowEditor.css"),this.contentElement.tabIndex=0,this.setDefaultFocusedElement(this.contentElement),this._typeField=this.contentElement.createChild("div","shadow-editor-field shadow-editor-flex-field"),this._typeField.createChild("label","shadow-editor-label").textContent=t.UIString("Type"),this._outsetButton=this._typeField.createChild("button","shadow-editor-button-left"),this._outsetButton.textContent=t.UIString("Outset"),this._outsetButton.addEventListener("click",this._onButtonClick.bind(this),!1),this._insetButton=this._typeField.createChild("button","shadow-editor-button-right"),this._insetButton.textContent=t.UIString("Inset"),this._insetButton.addEventListener("click",this._onButtonClick.bind(this),!1);const e=this.contentElement.createChild("div","shadow-editor-field");this._xInput=this._createTextInput(e,t.UIString("X offset"));const s=this.contentElement.createChild("div","shadow-editor-field");this._yInput=this._createTextInput(s,t.UIString("Y offset")),this._xySlider=e.createChild("canvas","shadow-editor-2D-slider"),this._xySlider.width=88,this._xySlider.height=88,this._xySlider.tabIndex=-1,this._halfCanvasSize=44,this._innerCanvasSize=this._halfCanvasSize-6,a.installDragHandle(this._xySlider,this._dragStart.bind(this),this._dragMove.bind(this),null,"default"),this._xySlider.addEventListener("keydown",this._onCanvasArrowKey.bind(this),!1),this._xySlider.addEventListener("blur",this._onCanvasBlur.bind(this),!1);const i=this.contentElement.createChild("div","shadow-editor-field shadow-editor-flex-field shadow-editor-blur-field");this._blurInput=this._createTextInput(i,t.UIString("Blur")),this._blurSlider=this._createSlider(i),this._spreadField=this.contentElement.createChild("div","shadow-editor-field shadow-editor-flex-field"),this._spreadInput=this._createTextInput(this._spreadField,t.UIString("Spread")),this._spreadSlider=this._createSlider(this._spreadField)}_createTextInput(t,e){const s=t.createChild("label","shadow-editor-label");s.textContent=e,s.setAttribute("for",e);const i=a.createInput("shadow-editor-text-input","text");return t.appendChild(i),i.id=e,i.addEventListener("keydown",this._handleValueModification.bind(this),!1),i.addEventListener("mousewheel",this._handleValueModification.bind(this),!1),i.addEventListener("input",this._onTextInput.bind(this),!1),i.addEventListener("blur",this._onTextBlur.bind(this),!1),i}_createSlider(t){const e=a.createSlider(0,20,-1);return e.addEventListener("input",this._onSliderInput.bind(this),!1),t.appendChild(e),e}wasShown(){this._updateUI()}setModel(t){this._model=t,this._typeField.classList.toggle("hidden",!t.isBoxShadow()),this._spreadField.classList.toggle("hidden",!t.isBoxShadow()),this._updateUI()}_updateUI(){this._updateButtons(),this._xInput.value=this._model.offsetX().asCSSText(),this._yInput.value=this._model.offsetY().asCSSText(),this._blurInput.value=this._model.blurRadius().asCSSText(),this._spreadInput.value=this._model.spreadRadius().asCSSText(),this._blurSlider.value=this._model.blurRadius().amount,this._spreadSlider.value=this._model.spreadRadius().amount,this._updateCanvas(!1)}_updateButtons(){this._insetButton.classList.toggle("enabled",this._model.inset()),this._outsetButton.classList.toggle("enabled",!this._model.inset())}_updateCanvas(t){const e=this._xySlider.getContext("2d");e.clearRect(0,0,this._xySlider.width,this._xySlider.height),e.save(),e.setLineDash([1,1]),e.strokeStyle="rgba(210, 210, 210, 0.8)",e.beginPath(),e.moveTo(this._halfCanvasSize,0),e.lineTo(this._halfCanvasSize,88),e.moveTo(0,this._halfCanvasSize),e.lineTo(88,this._halfCanvasSize),e.stroke(),e.restore();const s=this._sliderThumbPosition();e.save(),e.translate(this._halfCanvasSize,this._halfCanvasSize),e.lineWidth=2,e.strokeStyle="rgba(130, 130, 130, 0.75)",e.beginPath(),e.moveTo(0,0),e.lineTo(s.x,s.y),e.stroke(),t&&(e.beginPath(),e.fillStyle="rgba(66, 133, 244, 0.4)",e.arc(s.x,s.y,8,0,2*Math.PI),e.fill()),e.beginPath(),e.fillStyle="#4285F4",e.arc(s.x,s.y,6,0,2*Math.PI),e.fill(),e.restore()}_onButtonClick(t){const e=t.currentTarget===this._insetButton;e&&this._model.inset()||!e&&!this._model.inset()||(this._model.setInset(e),this._updateButtons(),this.dispatchEventToListeners(O.ShadowChanged,this._model))}_handleValueModification(t){const e=a.createReplacementString(t.currentTarget.value,t,(function(t,e,s){s.length||(s="px");return t+e+s}));if(!e)return;const s=z.parse(e);s&&(t.currentTarget===this._blurInput&&s.amount<0&&(s.amount=0),t.currentTarget.value=s.asCSSText(),t.currentTarget.selectionStart=0,t.currentTarget.selectionEnd=t.currentTarget.value.length,this._onTextInput(t),t.consume(!0))}_onTextInput(t){this._changedElement=t.currentTarget,this._changedElement.classList.remove("invalid");const e=z.parse(t.currentTarget.value);!e||t.currentTarget===this._blurInput&&e.amount<0||(t.currentTarget===this._xInput?(this._model.setOffsetX(e),this._updateCanvas(!1)):t.currentTarget===this._yInput?(this._model.setOffsetY(e),this._updateCanvas(!1)):t.currentTarget===this._blurInput?(this._model.setBlurRadius(e),this._blurSlider.value=e.amount):t.currentTarget===this._spreadInput&&(this._model.setSpreadRadius(e),this._spreadSlider.value=e.amount),this.dispatchEventToListeners(O.ShadowChanged,this._model))}_onTextBlur(){if(!this._changedElement)return;let t=this._changedElement.value.trim()?z.parse(this._changedElement.value):z.zero();if(t||(t=z.parse(this._changedElement.value+"px")),!t)return this._changedElement.classList.add("invalid"),void(this._changedElement=null);this._changedElement===this._xInput?(this._model.setOffsetX(t),this._xInput.value=t.asCSSText(),this._updateCanvas(!1)):this._changedElement===this._yInput?(this._model.setOffsetY(t),this._yInput.value=t.asCSSText(),this._updateCanvas(!1)):this._changedElement===this._blurInput?(t.amount<0&&(t=z.zero()),this._model.setBlurRadius(t),this._blurInput.value=t.asCSSText(),this._blurSlider.value=t.amount):this._changedElement===this._spreadInput&&(this._model.setSpreadRadius(t),this._spreadInput.value=t.asCSSText(),this._spreadSlider.value=t.amount),this._changedElement=null,this.dispatchEventToListeners(O.ShadowChanged,this._model)}_onSliderInput(t){t.currentTarget===this._blurSlider?(this._model.setBlurRadius(new z(this._blurSlider.value,this._model.blurRadius().unit||"px")),this._blurInput.value=this._model.blurRadius().asCSSText(),this._blurInput.classList.remove("invalid")):t.currentTarget===this._spreadSlider&&(this._model.setSpreadRadius(new z(this._spreadSlider.value,this._model.spreadRadius().unit||"px")),this._spreadInput.value=this._model.spreadRadius().asCSSText(),this._spreadInput.classList.remove("invalid")),this.dispatchEventToListeners(O.ShadowChanged,this._model)}_dragStart(t){this._xySlider.focus(),this._updateCanvas(!0),this._canvasOrigin=new r.Point(this._xySlider.totalOffsetLeft()+this._halfCanvasSize,this._xySlider.totalOffsetTop()+this._halfCanvasSize);const e=new r.Point(t.x-this._canvasOrigin.x,t.y-this._canvasOrigin.y),s=this._sliderThumbPosition();return e.distanceTo(s)>=6&&this._dragMove(t),!0}_dragMove(t){let e=new r.Point(t.x-this._canvasOrigin.x,t.y-this._canvasOrigin.y);t.shiftKey&&(e=this._snapToClosestDirection(e));const s=this._constrainPoint(e,this._innerCanvasSize),i=Math.round(s.x/this._innerCanvasSize*20),n=Math.round(s.y/this._innerCanvasSize*20);t.shiftKey?(this._model.setOffsetX(new z(i,this._model.offsetX().unit||"px")),this._model.setOffsetY(new z(n,this._model.offsetY().unit||"px"))):(t.altKey||this._model.setOffsetX(new z(i,this._model.offsetX().unit||"px")),d.KeyboardShortcut.eventHasCtrlOrMeta(t)||this._model.setOffsetY(new z(n,this._model.offsetY().unit||"px"))),this._xInput.value=this._model.offsetX().asCSSText(),this._yInput.value=this._model.offsetY().asCSSText(),this._xInput.classList.remove("invalid"),this._yInput.classList.remove("invalid"),this._updateCanvas(!0),this.dispatchEventToListeners(O.ShadowChanged,this._model)}_onCanvasBlur(){this._updateCanvas(!1)}_onCanvasArrowKey(t){let e=0,s=0;if("ArrowRight"===t.key?e=1:"ArrowLeft"===t.key?e=-1:"ArrowUp"===t.key?s=-1:"ArrowDown"===t.key&&(s=1),e||s){if(t.consume(!0),e){const t=this._model.offsetX(),s=n.clamp(t.amount+e,-20,20);if(s===t.amount)return;this._model.setOffsetX(new z(s,t.unit||"px")),this._xInput.value=this._model.offsetX().asCSSText(),this._xInput.classList.remove("invalid")}if(s){const t=this._model.offsetY(),e=n.clamp(t.amount+s,-20,20);if(e===t.amount)return;this._model.setOffsetY(new z(e,t.unit||"px")),this._yInput.value=this._model.offsetY().asCSSText(),this._yInput.classList.remove("invalid")}this._updateCanvas(!0),this.dispatchEventToListeners(O.ShadowChanged,this._model)}}_constrainPoint(t,e){return Math.abs(t.x)<=e&&Math.abs(t.y)<=e?new r.Point(t.x,t.y):t.scale(e/Math.max(Math.abs(t.x),Math.abs(t.y)))}_snapToClosestDirection(t){let e=Number.MAX_VALUE,s=t;const i=[new r.Point(0,-1),new r.Point(1,-1),new r.Point(1,0),new r.Point(1,1)];for(const n of i){const i=t.projectOn(n),r=t.distanceTo(i);r<e&&(e=r,s=i)}return s}_sliderThumbPosition(){const t=this._model.offsetX().amount/20*this._innerCanvasSize,e=this._model.offsetY().amount/20*this._innerCanvasSize;return this._constrainPoint(new r.Point(t,e),this._innerCanvasSize)}}const O={ShadowChanged:Symbol("ShadowChanged")};var R=Object.freeze({__proto__:null,CSSShadowEditor:L,Events:O});const{render:B,html:k,Directives:A}=p,M=s,X=_.getStyleSheets,F=/(var\()(--[^,)]+)(.*)/;class H extends HTMLElement{constructor(){super(),this.shadow=this.attachShadow({mode:"open"}),this.text="",this.color=null,this.computedValue=null,this.fromFallback=!1,this.onLinkClick=()=>{},this.shadow.adoptedStyleSheets=[...X("inline_editor/colorSwatch.css",{patchThemeSupport:!1})]}set data(t){this.text=t.text,this.computedValue=t.computedValue,this.fromFallback=t.fromFallback,this.onLinkClick=t.onLinkClick,this.computedValue&&(this.color=e.Color.parse(this.computedValue)),this.render()}parseVariableFunctionParts(){const t=this.text.match(F);return t?{pre:t[1],name:t[2],post:t[3]}:null}get variableName(){const t=this.text.match(/--[^,)]+/);return t?t[0]:""}renderLink(t){const e=this.computedValue&&!this.fromFallback,s=A.classMap({"css-var-link":!0,undefined:!e}),i=e?M`Jump to definition`:M`${t} is not defined`,n=e?this.onLinkClick.bind(this,this.variableName):null;return k`<span class="${s}" title="${i}" @mousedown=${n} role="link" tabindex="-1">${t}</span>`}renderColorSwatch(){return this.color?k`<span class="color-swatch read-only">
      <span class="color-swatch-inner" style="background-color:${this.color.asString()};"></span>
    </span>`:""}render(){const t=this.parseVariableFunctionParts();if(!t)return void B("",this.shadow,{eventContext:this});const e=this.renderLink(t.name),s=this.renderColorSwatch();B(k`<style>
      .css-var-link:not(.undefined) {
        cursor: pointer;
        text-decoration: underline;
      }
      </style><span title="${this.computedValue||""}">${s}${t.pre}${e}${t.post}</span>`,this.shadow,{eventContext:this})}}customElements.define("devtools-css-var-swatch",H);class V extends HTMLElement{set data(t){}}var U=Object.freeze({__proto__:null,SwatchRenderData:void 0,CSSVarSwatchClosureInterface:V,createCSSVarSwatch:function(){return document.createElement("devtools-css-var-swatch")}});class Y extends i.ObjectWrapper{constructor(){super(),this._popover=new c.GlassPane,this._popover.registerRequiredCSS("inline_editor/swatchPopover.css"),this._popover.setSizeBehavior(c.SizeBehavior.MeasureContent),this._popover.setMarginBehavior(c.MarginBehavior.Arrow),this._popover.element.addEventListener("mousedown",t=>t.consume(),!1),this._hideProxy=this.hide.bind(this,!0),this._boundOnKeyDown=this._onKeyDown.bind(this),this._boundFocusOut=this._onFocusOut.bind(this),this._isHidden=!0}_onFocusOut(t){this._isHidden||!t.relatedTarget||t.relatedTarget.isSelfOrDescendant(this._view.contentElement)||this._hideProxy()}isShowing(){return this._popover.isShowing()}show(t,e,s){if(this._popover.isShowing()){if(this._anchorElement===e)return;this.hide(!0)}delete this._isHidden,this._anchorElement=e,this._view=t,this._hiddenCallback=s,this.reposition(),t.focus();const i=this._popover.element.ownerDocument;i.addEventListener("mousedown",this._hideProxy,!1),i.defaultView.addEventListener("resize",this._hideProxy,!1),this._view.contentElement.addEventListener("keydown",this._boundOnKeyDown,!1)}reposition(){this._isHidden||(this._view.contentElement.removeEventListener("focusout",this._boundFocusOut,!1),this._view.show(this._popover.contentElement),this._popover.setContentAnchorBox(this._anchorElement.boxInWindow()),this._popover.show(this._anchorElement.ownerDocument),this._view.contentElement.addEventListener("focusout",this._boundFocusOut,!1),this._focusRestorer||(this._focusRestorer=new o.WidgetFocusRestorer(this._view)))}hide(t){if(this._isHidden)return;const e=this._popover.element.ownerDocument;this._isHidden=!0,this._popover.hide(),e.removeEventListener("mousedown",this._hideProxy,!1),e.defaultView.removeEventListener("resize",this._hideProxy,!1),this._hiddenCallback&&this._hiddenCallback.call(null,!!t),this._focusRestorer.restore(),delete this._anchorElement,this._view&&(this._view.detach(),this._view.contentElement.removeEventListener("keydown",this._boundOnKeyDown,!1),this._view.contentElement.removeEventListener("focusout",this._boundFocusOut,!1),delete this._view)}_onKeyDown(t){if("Enter"===t.key)return this.hide(!0),void t.consume(!0);"Escape"===t.key&&(this.hide(!1),t.consume(!0))}}var D=Object.freeze({__proto__:null,SwatchPopoverHelper:Y});export{g as BezierEditor,v as BezierUI,R as CSSShadowEditor,P as CSSShadowModel,U as CSSVarSwatch,y as ColorSwatch,D as SwatchPopoverHelper};
