import{Worker as t,Settings as e,ResourceType as o}from"../common/common.js";import{StringUtilities as r}from"../platform/platform.js";import{ContentProviderBasedProject as n,DebuggerWorkspaceBinding as i,NetworkProject as a,CSSWorkspaceBinding as s}from"../bindings/bindings.js";import{DebuggerModel as c,CSSModel as u}from"../sdk/sdk.js";import{StaticContentProvider as l,TextRange as m}from"../text_utils/text_utils.js";import{Workspace as d}from"../workspace/workspace.js";class p{constructor(){this._taskQueue=[],this._workerTasks=new Map}_createWorker(){const e=new t.WorkerWrapper("formatter_worker_entrypoint");return e.onmessage=this._onWorkerMessage.bind(this,e),e.onerror=this._onWorkerError.bind(this,e),e}_processNextTask(){if(!this._taskQueue.length)return;let t=[...this._workerTasks.keys()].find(t=>!this._workerTasks.get(t));if(!t&&this._workerTasks.size<2&&(t=this._createWorker()),!t)return;const e=this._taskQueue.shift();this._workerTasks.set(t,e),t.postMessage({method:e.method,params:e.params})}_onWorkerMessage(t,e){const o=this._workerTasks.get(t);o.isChunked&&e.data&&!e.data.isLastChunk?o.callback(e.data):(this._workerTasks.set(t,null),this._processNextTask(),o.callback(e.data?e.data:null))}_onWorkerError(t,e){console.error(e);const o=this._workerTasks.get(t);t.terminate(),this._workerTasks.delete(t);const r=this._createWorker();this._workerTasks.set(r,null),this._processNextTask(),o.callback(null)}_runChunkedTask(t,e,o){const r=new h(t,e,(function(t){if(!t)return void o(!0,null);const e=!!t.isLastChunk,r=t.chunk;o(e,r)}),!0);this._taskQueue.push(r),this._processNextTask()}_runTask(t,e){let o;const r=new Promise(t=>{o=t}),n=new h(t,e,o,!1);return this._taskQueue.push(n),this._processNextTask(),r}format(t,e,o){const r={mimeType:t,content:e,indentString:o};return this._runTask("format",r)}javaScriptIdentifiers(t){return this._runTask("javaScriptIdentifiers",{content:t}).then(t=>t||[])}evaluatableJavaScriptSubstring(t){return this._runTask("evaluatableJavaScriptSubstring",{content:t}).then(t=>t||"")}parseCSS(t,e){this._runChunkedTask("parseCSS",{content:t},(function(t,o){e(t,o||[])}))}javaScriptOutline(t,e){this._runChunkedTask("javaScriptOutline",{content:t},(function(t,o){e(t,o||[])}))}outlineForMimetype(t,e,o){switch(e){case"text/html":case"text/javascript":return this.javaScriptOutline(t,(function(t,e){o(t,e.map(t=>({line:t.line,column:t.column,title:t.name,subtitle:t.arguments})))})),!0;case"text/css":return this.parseCSS(t,(function(t,e){o(t,e.map(t=>({line:t.lineNumber,column:t.columnNumber,title:t.selectorText||t.atRule})))})),!0}return!1}findLastExpression(t){return this._runTask("findLastExpression",{content:t})}findLastFunctionCall(t){return this._runTask("findLastFunctionCall",{content:t})}argumentsList(t){return this._runTask("argumentsList",{content:t})}}class h{constructor(t,e,o,r){this.method=t,this.params=e,this.callback=o,this.isChunked=r}}function _(){return Formatter._formatterWorkerPool||(Formatter._formatterWorkerPool=new p),Formatter._formatterWorkerPool}var f=Object.freeze({__proto__:null,FormatterWorkerPool:p,FormatResult:class{constructor(){this.content,this.mapping}},formatterWorkerPool:_,OutlineItem:void 0,FormatMapping:void 0,CSSAtRule:void 0,CSSRule:void 0,TextRange:void 0});class S{}S.format=function(t,e,o,r){t.isDocumentOrScriptOrStyleSheet()?new g(e,o,r):new k(e,o,r)},S.locationToPosition=function(t,e,o){return(e?t[e-1]+1:0)+o},S.positionToLocation=function(t,e){const o=t.upperBound(e-1);let r;return r=o?e-t[o-1]-1:e,[o,r]};class g{constructor(t,e,o){this._mimeType=t,this._originalContent=e.replace(/\r\n?|[\n\u2028\u2029]/g,"\n").replace(/^\uFEFF/,""),this._callback=o,this._initialize()}async _initialize(){const t=_(),o=e.Settings.instance().moduleSetting("textEditorIndent").get(),r=await t.format(this._mimeType,this._originalContent,o);r?this._didFormatContent(r):this._callback(this._originalContent,new C)}_didFormatContent(t){const e=r.findLineEndingIndexes(this._originalContent),o=r.findLineEndingIndexes(t.content),n=new T(e,o,t.mapping);this._callback(t.content,n)}}class k{constructor(t,e,o){o(e,new C)}}class C{originalToFormatted(t,e){return[t,e||0]}formattedToOriginal(t,e){return[t,e||0]}}class T{constructor(t,e,o){this._originalLineEndings=t,this._formattedLineEndings=e,this._mapping=o}originalToFormatted(t,e){const o=S.locationToPosition(this._originalLineEndings,t,e||0),r=this._convertPosition(this._mapping.original,this._mapping.formatted,o||0);return S.positionToLocation(this._formattedLineEndings,r)}formattedToOriginal(t,e){const o=S.locationToPosition(this._formattedLineEndings,t,e||0),r=this._convertPosition(this._mapping.formatted,this._mapping.original,o);return S.positionToLocation(this._originalLineEndings,r||0)}_convertPosition(t,e,o){const r=t.upperBound(o)-1;let n=e[r]+o-t[r];return r<e.length-1&&n>e[r+1]&&(n=e[r+1]),n}}var b=Object.freeze({__proto__:null,FormatterInterface:S,ScriptFormatter:g,FormatterSourceMapping:class{originalToFormatted(t,e){}formattedToOriginal(t,e){}}});class y{constructor(t,e,o){this.originalSourceCode=t,this.formattedSourceCode=e,this.mapping=o}originalPath(){return this.originalSourceCode.project().id()+":"+this.originalSourceCode.url()}static _for(t){return t[y._formatDataSymbol]}}y._formatDataSymbol=Symbol("formatData");let w=null;class L{constructor(){this._projectId="formatter:",this._project=new n.ContentProviderBasedProject(d.WorkspaceImpl.instance(),this._projectId,d.projectTypes.Formatter,"formatter",!0),this._formattedSourceCodes=new Map,this._scriptMapping=new F,this._styleMapping=new v,d.WorkspaceImpl.instance().addEventListener(d.Events.UISourceCodeRemoved,t=>{this._onUISourceCodeRemoved(t)},this)}static instance(){return w||(w=new L),w}async _onUISourceCodeRemoved(t){const e=t.data,o=this._formattedSourceCodes.get(e);o&&o.formatData&&await this._discardFormatData(o.formatData),this._formattedSourceCodes.delete(e)}async discardFormattedUISourceCode(t){const e=y._for(t);return e?(await this._discardFormatData(e),this._formattedSourceCodes.delete(e.originalSourceCode),e.originalSourceCode):null}async _discardFormatData(t){delete t.formattedSourceCode[y._formatDataSymbol],await this._scriptMapping._setSourceMappingEnabled(t,!1),this._styleMapping._setSourceMappingEnabled(t,!1),this._project.removeFile(t.formattedSourceCode.url())}hasFormatted(t){return this._formattedSourceCodes.has(t)}getOriginalUISourceCode(t){const e=t[y._formatDataSymbol];return e?e.originalSourceCode:t}async format(t){const e=this._formattedSourceCodes.get(t);if(e)return e.promise;let o;const r=new Promise(t=>{o=t});this._formattedSourceCodes.set(t,{promise:r,formatData:null});const{content:n}=await t.requestContent();return S.format(t.contentType(),t.mimeType(),n||"",async function(e,n){const i=this._formattedSourceCodes.get(t);if(!i||i.promise!==r)return;let a,s=0,c="";do{a=`${t.url()}:formatted${c}`,c=":"+s++}while(this._project.uiSourceCodeForURL(a));const u=l.StaticContentProvider.fromString(a,t.contentType(),e),d=this._project.createUISourceCode(a,u.contentType()),p=new y(t,d,n);d[y._formatDataSymbol]=p,this._project.addUISourceCodeWithProvider(d,u,null,t.mimeType()),await this._scriptMapping._setSourceMappingEnabled(p,!0),await this._styleMapping._setSourceMappingEnabled(p,!0),i.formatData=p;for(const e of t.allDecorations()){const t=e.range(),o=n.originalToFormatted(t.startLine,t.startColumn),r=n.originalToFormatted(t.endLine,t.endColumn);d.addDecoration(new m.TextRange(o[0],o[1],r[0],r[1]),e.type(),e.data())}o(p)}.bind(this)),r}}class F{constructor(){i.DebuggerWorkspaceBinding.instance().addSourceMapping(this)}rawLocationToUILocation(t){const e=t.script(),o=e&&y._for(e);if(!o)return null;if(e.isInlineScriptWithSourceURL()){const[r,n]=e.toRelativeLocation(t),[i,a]=o.mapping.originalToFormatted(r,n);return o.formattedSourceCode.uiLocation(i,a)}const[r,n]=o.mapping.originalToFormatted(t.lineNumber,t.columnNumber||0);return o.formattedSourceCode.uiLocation(r,n)}uiLocationToRawLocations(t,e,r){const n=y._for(t);if(!n)return[];const[s,u]=n.mapping.formattedToOriginal(e,r);if(n.originalSourceCode.contentType().isScript()){const t=i.DebuggerWorkspaceBinding.instance().uiLocationToRawLocationsForUnformattedJavaScript(n.originalSourceCode,s,u);return console.assert(t.every(t=>t&&!!t.script())),t}if(n.originalSourceCode.contentType()===o.resourceTypes.Document){const t=a.NetworkProject.targetForUISourceCode(n.originalSourceCode),e=t&&t.model(c.DebuggerModel);if(e){const t=e.scriptsForSourceURL(n.originalSourceCode.url()).filter(t=>t.isInlineScript()&&!t.hasSourceURL).map(t=>t.rawLocation(s,u)).filter(t=>!!t);return console.assert(t.every(t=>t&&!!t.script())),t}}return[]}async _setSourceMappingEnabled(t,e){const o=this._scriptsForUISourceCode(t.originalSourceCode);if(!o.length)return;if(e)for(const e of o)e[y._formatDataSymbol]=t;else for(const t of o)delete t[y._formatDataSymbol];const r=o.map(t=>i.DebuggerWorkspaceBinding.instance().updateLocations(t));await Promise.all(r)}_scriptsForUISourceCode(t){if(t.contentType()===o.resourceTypes.Document){const e=a.NetworkProject.targetForUISourceCode(t),o=e&&e.model(c.DebuggerModel);if(o){return o.scriptsForSourceURL(t.url()).filter(t=>t.isInlineScript()&&!t.hasSourceURL)}}if(t.contentType().isScript()){console.assert(!t[y._formatDataSymbol]||t[y._formatDataSymbol]===t);return i.DebuggerWorkspaceBinding.instance().uiLocationToRawLocationsForUnformattedJavaScript(t,0,0).map(t=>t.script()).filter(t=>!!t)}return[]}}class v{constructor(){s.CSSWorkspaceBinding.instance().addSourceMapping(this),this._headersSymbol=Symbol("Formatter.SourceFormatter.StyleMapping._headersSymbol")}rawLocationToUILocation(t){const e=t.header(),o=e&&y._for(e);if(!o)return null;const r=o.mapping.originalToFormatted(t.lineNumber,t.columnNumber||0);return o.formattedSourceCode.uiLocation(r[0],r[1])}uiLocationToRawLocations(t){const e=y._for(t.uiSourceCode);if(!e)return[];const[o,r]=e.mapping.formattedToOriginal(t.lineNumber,t.columnNumber);return e.originalSourceCode[this._headersSymbol].filter(t=>t.containsLocation(o,r)).map(t=>new u.CSSLocation(t,o,r))}async _setSourceMappingEnabled(t,e){const o=t.originalSourceCode,r=this._headersForUISourceCode(o);e?(o[this._headersSymbol]=r,r.forEach(e=>{e[y._formatDataSymbol]=t})):(o[this._headersSymbol]=null,r.forEach(t=>delete t[y._formatDataSymbol]));const n=r.map(t=>s.CSSWorkspaceBinding.instance().updateLocations(t));await Promise.all(n)}_headersForUISourceCode(t){if(t.contentType()===o.resourceTypes.Document){const e=a.NetworkProject.targetForUISourceCode(t),o=e&&e.model(u.CSSModel);if(o)return o.headersForSourceURL(t.url()).filter(t=>t.isInline&&!t.hasSourceURL)}else if(t.contentType().isStyleSheet()){return s.CSSWorkspaceBinding.instance().uiLocationToRawLocations(t.uiLocation(0,0)).map(t=>t.header()).filter(t=>!!t)}return[]}}var D=Object.freeze({__proto__:null,SourceFormatData:y,SourceFormatter:L});export{f as FormatterWorkerPool,b as ScriptFormatter,D as SourceFormatter};
