import{UIString as e,Settings as t,Throttler as i,EventTarget as s,ParsedURL as a,Color as r,ObjectWrapper as n,Revealer as o,ResourceType as d,Console as l}from"../common/common.js";import{DataGrid as c,SortableDataGrid as h}from"../data_grid/data_grid.js";import{NumberUtilities as _,DateUtilities as m,StringUtilities as u,ArrayUtilities as p}from"../platform/platform.js";import{View as g,Toolbar as b,EmptyWidget as v,Widget as S,ReportView as w,UIUtils as f,XLink as y,ActionRegistry as C,SplitWidget as I,ShortcutRegistry as k,ThrottledWidget as E,SettingsUI as T,Icon as L,TextPrompt as R,ARIAUtils as x,Fragment as D,TabbedPane as M,Utils as O,TreeOutline as F,Context as B,ContextMenu as V,Panel as U,ViewManager as N}from"../ui/ui.js";import{SDKModel as P,ResourceTreeModel as A,ServiceWorkerManager as W,SecurityOriginManager as j,RuntimeModel as q,CookieModel as G,ServiceWorkerCacheModel as z,NetworkManager as K,FrameManager as $,OverlayModel as H,NetworkRequest as Q,ChildTargetManager as X,Cookie as J,Resource as Y}from"../sdk/sdk.js";import{InspectorFrontendHost as Z}from"../host/host.js";import{PreviewFactory as ee,ResourceSourceFrame as te,ImageView as ie,FontView as se}from"../source_frame/source_frame.js";import{Linkifier as ae}from"../components/components.js";import{ColorSwatch as re}from"../inline_editor/inline_editor.js";import{FileUtils as ne,NetworkProject as oe}from"../bindings/bindings.js";import{PieChart as de}from"../perf_ui/perf_ui.js";import{NetworkPanel as le,NetworkItemView as ce,RequestHeadersView as he,RequestPreviewView as _e}from"../network/network.js";import{Workspace as me}from"../workspace/workspace.js";import{ObjectPropertiesSection as ue}from"../object_ui/object_ui.js";import{ThrottlingManager as pe}from"../mobile_throttling/mobile_throttling.js";import{RelatedIssue as ge}from"../browser_sdk/browser_sdk.js";import{CookiesTable as be}from"../cookie_table/cookie_table.js";import{StaticContentProvider as ve}from"../text_utils/text_utils.js";class Se extends P.SDKModel{constructor(e){super(e),e.registerApplicationCacheDispatcher(new fe(this)),this._agent=e.applicationCacheAgent(),this._agent.invoke_enable();const t=e.model(A.ResourceTreeModel);if(!t)throw new Error("Target must provide an ResourceTreeModel");t.addEventListener(A.Events.FrameNavigated,this._frameNavigatedCallback,this),t.addEventListener(A.Events.FrameDetached,this._frameDetached,this),this._statuses=new Map,this._manifestURLsByFrame=new Map,this._mainFrameNavigated(),this._onLine=!0}_frameNavigatedCallback(e){this._frameNavigated(e)}async _frameNavigated(e){const t=e.data;if(t.isMainFrame())return void this._mainFrameNavigated();const i=t.id,s=await this._agent.invoke_getManifestForFrame({frameId:i});null===s||s||this._frameManifestRemoved(i)}_frameDetached(e){const t=e.data;this._frameManifestRemoved(t.id)}reset(){this._statuses.clear(),this._manifestURLsByFrame.clear(),this.dispatchEventToListeners(we.FrameManifestsReset)}async _mainFrameNavigated(){const e=await this._agent.invoke_getFramesWithManifests();if(!e.getError())for(const t of e.frameIds)this._frameManifestUpdated(t.frameId,t.manifestURL,t.status)}_frameManifestUpdated(e,t,i){if(i===ye)return void this._frameManifestRemoved(e);if(!t)return;const s=this._manifestURLsByFrame.get(e);s&&t!==s&&this._frameManifestRemoved(e);const a=this._statuses.get(e)!==i;this._statuses.set(e,i),this._manifestURLsByFrame.has(e)||(this._manifestURLsByFrame.set(e,t),this.dispatchEventToListeners(we.FrameManifestAdded,e)),a&&this.dispatchEventToListeners(we.FrameManifestStatusUpdated,e)}_frameManifestRemoved(e){const t=this._manifestURLsByFrame.delete(e);this._statuses.delete(e),t&&this.dispatchEventToListeners(we.FrameManifestRemoved,e)}frameManifestURL(e){return this._manifestURLsByFrame.get(e)||""}frameManifestStatus(e){return this._statuses.get(e)||ye}get onLine(){return this._onLine}_statusUpdated(e,t,i){this._frameManifestUpdated(e,t,i)}async requestApplicationCache(e){const t=await this._agent.invoke_getApplicationCacheForFrame({frameId:e});return t.getError()?null:t.applicationCache}_networkStateUpdated(e){this._onLine=e,this.dispatchEventToListeners(we.NetworkStateChanged,e)}}P.SDKModel.register(Se,P.Capability.DOM,!1);const we={FrameManifestStatusUpdated:Symbol("FrameManifestStatusUpdated"),FrameManifestAdded:Symbol("FrameManifestAdded"),FrameManifestRemoved:Symbol("FrameManifestRemoved"),FrameManifestsReset:Symbol("FrameManifestsReset"),NetworkStateChanged:Symbol("NetworkStateChanged")};class fe{constructor(e){this._applicationCacheModel=e}usesObjectNotation(){return!0}applicationCacheStatusUpdated({frameId:e,manifestURL:t,status:i}){this._applicationCacheModel._statusUpdated(e,t,i)}networkStateUpdated({isNowOnline:e}){this._applicationCacheModel._networkStateUpdated(e)}}const ye=0;var Ce=Object.freeze({__proto__:null,ApplicationCacheModel:Se,Events:we,ApplicationCacheDispatcher:fe,UNCACHED:ye,IDLE:1,CHECKING:2,DOWNLOADING:3,UPDATEREADY:4,OBSOLETE:5});class Ie extends g.SimpleView{constructor(t,i){super(e.UIString("AppCache")),this._model=t,this.element.classList.add("storage-view","table"),this._deleteButton=new b.ToolbarButton(e.UIString("Delete"),"largeicon-delete"),this._deleteButton.setVisible(!1),this._deleteButton.addEventListener(b.ToolbarButton.Events.Click,this._deleteButtonClicked,this),this._connectivityIcon=createElement("span","dt-icon-label"),this._connectivityIcon.style.margin="0 2px 0 5px",this._statusIcon=createElement("span","dt-icon-label"),this._statusIcon.style.margin="0 2px 0 5px",this._frameId=i,this._emptyWidget=new v.EmptyWidget(e.UIString("No Application Cache information available.")),this._emptyWidget.show(this.element),this._markDirty();const s=this._model.frameManifestStatus(i);this.updateStatus(s),this.updateNetworkState(this._model.onLine),this._deleteButton.element.style.display="none"}async toolbarItems(){return[this._deleteButton,new b.ToolbarItem(this._connectivityIcon),new b.ToolbarSeparator,new b.ToolbarItem(this._statusIcon)]}wasShown(){this._maybeUpdate()}willHide(){this._deleteButton.setVisible(!1)}_maybeUpdate(){this.isShowing()&&this._viewDirty&&(this._update(),this._viewDirty=!1)}_markDirty(){this._viewDirty=!0}updateStatus(e){const t=this._status;this._status=e;const i={};i[ye]={type:"smallicon-red-ball",text:"UNCACHED"},i[1]={type:"smallicon-green-ball",text:"IDLE"},i[2]={type:"smallicon-orange-ball",text:"CHECKING"},i[3]={type:"smallicon-orange-ball",text:"DOWNLOADING"},i[4]={type:"smallicon-green-ball",text:"UPDATEREADY"},i[5]={type:"smallicon-red-ball",text:"OBSOLETE"};const s=i[e]||i[ye];this._statusIcon.type=s.type,this._statusIcon.textContent=s.text,!this.isShowing()||1!==this._status||4!==t&&this._resources||this._markDirty(),this._maybeUpdate()}updateNetworkState(t){t?(this._connectivityIcon.type="smallicon-green-ball",this._connectivityIcon.textContent=e.UIString("Online")):(this._connectivityIcon.type="smallicon-red-ball",this._connectivityIcon.textContent=e.UIString("Offline"))}async _update(){const e=await this._model.requestApplicationCache(this._frameId);if(!e||!e.manifestURL)return delete this._manifest,delete this._creationTime,delete this._updateTime,delete this._size,delete this._resources,this._emptyWidget.show(this.element),this._deleteButton.setVisible(!1),void(this._dataGrid&&this._dataGrid.element.classList.add("hidden"));this._manifest=e.manifestURL,this._creationTime=e.creationTime,this._updateTime=e.updateTime,this._size=e.size,this._resources=e.resources,this._dataGrid||this._createDataGrid(),this._populateDataGrid(),this._dataGrid.autoSizeColumns(20,80),this._dataGrid.element.classList.remove("hidden"),this._emptyWidget.detach(),this._deleteButton.setVisible(!0)}_createDataGrid(){const t=[{id:"resource",title:e.UIString("Resource"),sort:c.Order.Ascending,sortable:!0},{id:"type",title:e.UIString("Type"),sortable:!0},{id:"size",title:e.UIString("Size"),align:c.Align.Right,sortable:!0}];this._dataGrid=new c.DataGridImpl({displayName:ls`Application Cache`,columns:t}),this._dataGrid.setStriped(!0),this._dataGrid.asWidget().show(this.element),this._dataGrid.addEventListener(c.Events.SortingChanged,this._populateDataGrid,this)}_populateDataGrid(){const e=this._dataGrid.selectedNode?this._dataGrid.selectedNode.resource:null,t=this._dataGrid.isSortOrderAscending()?1:-1;function i(e,i,s){return t*(i[e]+"").localeCompare(s[e]+"")}let s,a;switch(this._dataGrid.sortColumnId()){case"resource":s=i.bind(null,"url");break;case"type":s=i.bind(null,"type");break;case"size":s=function(e,i,s){return t*(i[e]-s[e])}.bind(null,"size");break;default:i.bind(null,"resource")}this._resources.sort(s),this._dataGrid.rootNode().removeChildren();for(let t=0;t<this._resources.length;++t){const i={},s=this._resources[t];i.resource=s.url,i.type=s.type,i.size=_.bytesToString(s.size);const r=new c.DataGridNode(i);r.resource=s,r.selectable=!0,this._dataGrid.rootNode().appendChild(r),s===e&&(a=r,a.selected=!0)}!a&&this._dataGrid.rootNode().children.length&&(this._dataGrid.rootNode().children[0].selected=!0)}_deleteButtonClicked(e){this._dataGrid&&this._dataGrid.selectedNode&&this._deleteCallback(this._dataGrid.selectedNode)}_deleteCallback(e){}}var ke=Object.freeze({__proto__:null,ApplicationCacheItemsView:Ie});class Ee extends S.VBox{constructor(){super(!0),this.registerRequiredCSS("resources/appManifestView.css"),t.Settings.instance().moduleSetting("colorFormat").addChangeListener(this._updateManifest.bind(this,!0)),this._emptyView=new v.EmptyWidget(e.UIString("No manifest detected")),this._emptyView.appendLink("https://developers.google.com/web/fundamentals/engage-and-retain/web-app-manifest/?utm_source=devtools"),this._emptyView.show(this.contentElement),this._emptyView.hideWidget(),this._reportView=new w.ReportView(e.UIString("App Manifest")),this._reportView.registerRequiredCSS("resources/appManifestView.css"),this._reportView.show(this.contentElement),this._reportView.hideWidget(),this._errorsSection=this._reportView.appendSection(e.UIString("Errors and warnings")),this._installabilitySection=this._reportView.appendSection(e.UIString("Installability")),this._identitySection=this._reportView.appendSection(e.UIString("Identity")),this._presentationSection=this._reportView.appendSection(e.UIString("Presentation")),this._iconsSection=this._reportView.appendSection(e.UIString("Icons"),"report-section-icons"),this._shortcutSections=[],this._nameField=this._identitySection.appendField(e.UIString("Name")),this._shortNameField=this._identitySection.appendField(e.UIString("Short name")),this._startURLField=this._presentationSection.appendField(e.UIString("Start URL"));const s=this._presentationSection.appendField(e.UIString("Theme color"));this._themeColorSwatch=re.ColorSwatch.create(),s.appendChild(this._themeColorSwatch);const a=this._presentationSection.appendField(e.UIString("Background color"));this._backgroundColorSwatch=re.ColorSwatch.create(),a.appendChild(this._backgroundColorSwatch),this._orientationField=this._presentationSection.appendField(e.UIString("Orientation")),this._displayField=this._presentationSection.appendField(e.UIString("Display")),this._throttler=new i.Throttler(1e3),P.TargetManager.instance().observeTargets(this)}targetAdded(e){this._target||(this._target=e,this._resourceTreeModel=e.model(A.ResourceTreeModel),this._serviceWorkerManager=e.model(W.ServiceWorkerManager),this._resourceTreeModel&&this._serviceWorkerManager&&(this._updateManifest(!0),this._registeredListeners=[this._resourceTreeModel.addEventListener(A.Events.DOMContentLoaded,e=>{this._updateManifest(!0)}),this._serviceWorkerManager.addEventListener(W.Events.RegistrationUpdated,e=>{this._updateManifest(!1)})]))}targetRemoved(e){this._target===e&&this._resourceTreeModel&&this._serviceWorkerManager&&(delete this._resourceTreeModel,delete this._serviceWorkerManager,s.EventTarget.removeEventListeners(this._registeredListeners))}async _updateManifest(e){const{url:t,data:i,errors:s}=await this._resourceTreeModel.fetchAppManifest(),a=await this._resourceTreeModel.getInstallabilityErrors(),r=await this._resourceTreeModel.getManifestIcons();this._throttler.schedule(()=>this._renderManifest(t,i,s,a,r),e)}async _renderManifest(i,s,n,o,d){if(!s&&!n.length)return this._emptyView.showWidget(),void this._reportView.hideWidget();this._emptyView.hideWidget(),this._reportView.showWidget();const l=ae.Linkifier.linkifyURL(i);l.tabIndex=0,this._reportView.setURL(l),this._errorsSection.clearContent(),this._errorsSection.element.classList.toggle("hidden",!n.length);for(const e of n)this._errorsSection.appendRow().appendChild(f.createIconLabel(e.message,e.critical?"smallicon-error":"smallicon-warning"));if(!s)return;65279===s.charCodeAt(0)&&(s=s.slice(1));const c=JSON.parse(s);this._nameField.textContent=I("name"),this._shortNameField.textContent=I("short_name"),this._startURLField.removeChildren();const h=I("start_url");if(h){const e=a.ParsedURL.completeURL(i,h),t=ae.Linkifier.linkifyURL(e,{text:h});t.tabIndex=0,this._startURLField.appendChild(t)}this._themeColorSwatch.classList.toggle("hidden",!I("theme_color"));const _=r.Color.parse(I("theme_color")||"white")||r.Color.parse("white");this._themeColorSwatch.setColor(_),this._themeColorSwatch.setFormat(t.detectColorFormat(this._themeColorSwatch.color())),this._backgroundColorSwatch.classList.toggle("hidden",!I("background_color"));const m=r.Color.parse(I("background_color")||"white")||r.Color.parse("white");this._backgroundColorSwatch.setColor(m),this._backgroundColorSwatch.setFormat(t.detectColorFormat(this._backgroundColorSwatch.color())),this._orientationField.textContent=I("orientation");const u=I("display");this._displayField.textContent=u;const p=c.icons||[];this._iconsSection.clearContent();const g=c.shortcuts||[];for(const e of this._shortcutSections)e.detach(!0);const b=[],v=f.CheckboxLabel.create(e.UIString("Show only the minimum safe area for maskable icons"));v.classList.add("mask-checkbox"),v.addEventListener("click",()=>{this._iconsSection.setIconMasked(v.checkboxElement.checked)}),this._iconsSection.appendRow().appendChild(v);const S=y.XLink.create("https://web.dev/maskable-icon/",ls`documentation on maskable icons`);if(this._iconsSection.appendRow().appendChild(f.formatLocalized("Need help? Read our %s.",[S])),d&&d.primaryIcon){const e=createElement("div");e.classList.add("image-wrapper");const t=createElement("img");t.style.maxWidth="200px",t.style.maxHeight="200px",t.src="data:image/png;base64,"+d.primaryIcon,t.alt=ls`Primary manifest icon from ${i}`;const s=ls`Primary icon\nas used by Chrome`,a=this._iconsSection.appendFlexedField(s);e.appendChild(t),a.appendChild(e)}for(const e of p){const t=await this._appendIconResourceToSection(i,e,this._iconsSection);b.push(...t)}let w=1;for(const e of g){const t=this._reportView.appendSection(ls`Shortcut #${w}`);this._shortcutSections.push(t),t.appendFlexedField("Name",e.name),e.short_name&&t.appendFlexedField("Short name",e.short_name),e.description&&t.appendFlexedField("Description",e.description);const s=t.appendFlexedField("URL"),r=a.ParsedURL.completeURL(i,e.url),n=ae.Linkifier.linkifyURL(r,{text:e.url});n.tabIndex=0,s.appendChild(n);const o=e.icons||[];let d=!1;for(const e of o){const s=await this._appendIconResourceToSection(i,e,t);if(s.length>0&&b.push(...s),!d&&e.sizes){const t=e.sizes.match(/^(\d+)x(\d+)$/);t&&t[1]>=96&&t[2]>=96&&(d=!0)}}d||b.push(ls`Shortcut #${w} should include a 96x96 pixel icon`),w++}this._installabilitySection.clearContent(),this._installabilitySection.element.classList.toggle("hidden",!o.length);const C=this.getInstallabilityErrorMessages(o);for(const e of C)this._installabilitySection.appendRow().appendChild(f.createIconLabel(e,"smallicon-warning"));this._errorsSection.element.classList.toggle("hidden",!n.length&&!b.length);for(const e of b)this._errorsSection.appendRow().appendChild(f.createIconLabel(e,"smallicon-warning"));function I(e){const t=c[e];return"string"!=typeof t?"":t}}getInstallabilityErrorMessages(e){const t=[];for(const i of e){let e;switch(i.errorId){case"not-in-main-frame":e=ls`Page is not loaded in the main frame`;break;case"not-from-secure-origin":e=ls`Page is not served from a secure origin`;break;case"no-manifest":e=ls`Page has no manifest <link> URL`;break;case"manifest-empty":e=ls`Manifest could not be fetched, is empty, or could not be parsed`;break;case"start-url-not-valid":e=ls`Manifest start URL is not valid`;break;case"manifest-missing-name-or-short-name":e=ls`Manifest does not contain a 'name' or 'short_name' field`;break;case"manifest-display-not-supported":e=ls`Manifest 'display' property must be one of 'standalone', 'fullscreen', or 'minimal-ui'`;break;case"manifest-missing-suitable-icon":if(1!==i.errorArguments.length||"minimum-icon-size-in-pixels"!==i.errorArguments[0].name){console.error("Installability error does not have the correct errorArguments");break}e=ls`Manifest does not contain a suitable icon - PNG, SVG or WebP format of at least ${i.errorArguments[0].value}px is required, the sizes attribute must be set, and the purpose attribute, if set, must include "any" or "maskable".`;break;case"no-matching-service-worker":e=ls`No matching service worker detected. You may need to reload the page, or check that the scope of the service worker for the current page encloses the scope and start URL from the manifest.`;break;case"no-acceptable-icon":if(1!==i.errorArguments.length||"minimum-icon-size-in-pixels"!==i.errorArguments[0].name){console.error("Installability error does not have the correct errorArguments");break}e=ls`No supplied icon is at least ${i.errorArguments[0].value}px square in PNG, SVG or WebP format`;break;case"cannot-download-icon":e=ls`Could not download a required icon from the manifest`;break;case"no-icon-available":e=ls`Downloaded icon was empty or corrupted`;break;case"platform-not-supported-on-android":e=ls`The specified application platform is not supported on Android`;break;case"no-id-specified":e=ls`No Play store ID provided`;break;case"ids-do-not-match":e=ls`The Play Store app URL and Play Store ID do not match`;break;case"already-installed":e=ls`The app is already installed`;break;case"url-not-supported-for-webapk":e=ls`A URL in the manifest contains a username, password, or port`;break;case"in-incognito":e=ls`Page is loaded in an incognito window`;break;case"not-offline-capable":e=ls`Page does not work offline`;break;case"no-url-for-service-worker":e=ls`Could not check service worker without a 'start_url' field in the manifest`;break;case"prefer-related-applications":e=ls`Manifest specifies prefer_related_applications: true`;break;case"prefer-related-applications-only-beta-stable":e=ls`prefer_related_applications is only supported on Chrome Beta and Stable channels on Android.`;break;case"manifest-display-override-not-supported":e=ls`Manifest contains 'display_override' field, and the first supported display mode must be one of 'standalone', 'fullscreen', or 'minimal-ui'`;break;default:console.error(`Installability error id '${i.errorId}' is not recognized`)}t&&t.push(e)}return t}async _loadImage(e){const t=createElement("div");t.classList.add("image-wrapper");const i=createElement("img"),s=new Promise((e,t)=>{i.onload=e,i.onerror=t});i.src=e,i.alt=ls`Image from ${e}`,t.appendChild(i);try{return await s,{wrapper:t,image:i}}catch(e){}return null}async _appendIconResourceToSection(e,t,i){const s=[];if(!t.src)return s.push(ls`Icon src is not set`),s;const r=a.ParsedURL.completeURL(e,t.src),n=await this._loadImage(r);if(!n)return s.push(ls`Icon ${r} failed to load`),s;const{wrapper:o,image:d}=n,l=(t.sizes?t.sizes.replace("x","×")+"px":"")+"\n"+(t.type||""),c=i.appendFlexedField(l);if(t.sizes)if(/^\d+x\d+$/.test(t.sizes)){const[e,i]=t.sizes.split("x").map(e=>parseInt(e,10));e!==i?s.push(ls`Icon ${r} dimensions should be square`):d.naturalWidth!==e&&d.naturalHeight!==i?s.push(ls`Actual size (${d.naturalWidth}×${d.naturalHeight})px of icon ${r} does not match specified size (${e}×${i}px)`):d.naturalWidth!==e?s.push(ls`Actual width (${d.naturalWidth}px) of icon ${r} does not match specified width (${e}px)`):d.naturalHeight!==i&&s.push(ls`Actual height (${d.naturalHeight}px) of icon ${r} does not match specified height (${i}px)`)}else s.push(ls`Icon ${r} should specify its size as \`{width}x{height}\``);else s.push(ls`Icon ${r} does not specify its size in the manifest`);return c.appendChild(o),s}}var Te=Object.freeze({__proto__:null,AppManifestView:Ee});class Le extends P.SDKModel{constructor(e){super(e),this._backgroundServiceAgent=e.backgroundServiceAgent(),e.registerBackgroundServiceDispatcher(this),this._events=new Map}enable(e){this._events.set(e,[]),this._backgroundServiceAgent.invoke_startObserving({service:e})}setRecording(e,t){this._backgroundServiceAgent.invoke_setRecording({shouldRecord:e,service:t})}clearEvents(e){this._events.set(e,[]),this._backgroundServiceAgent.invoke_clearEvents({service:e})}getEvents(e){return this._events.get(e)||[]}recordingStateChanged({isRecording:e,service:t}){this.dispatchEventToListeners(Re.RecordingStateChanged,{isRecording:e,serviceName:t})}backgroundServiceEventReceived({backgroundServiceEvent:e}){this._events.get(e.service).push(e),this.dispatchEventToListeners(Re.BackgroundServiceEventReceived,e)}usesObjectNotation(){return!0}}P.SDKModel.register(Le,P.Capability.Browser,!1);const Re={RecordingStateChanged:Symbol("RecordingStateChanged"),BackgroundServiceEventReceived:Symbol("BackgroundServiceEventReceived")};var xe=Object.freeze({__proto__:null,BackgroundServiceModel:Le,Events:Re});class De extends S.VBox{static getUIString(e){switch(e){case Protocol.BackgroundService.ServiceName.BackgroundFetch:return ls`Background Fetch`;case Protocol.BackgroundService.ServiceName.BackgroundSync:return ls`Background Sync`;case Protocol.BackgroundService.ServiceName.PushMessaging:return ls`Push Messaging`;case Protocol.BackgroundService.ServiceName.Notifications:return ls`Notifications`;case Protocol.BackgroundService.ServiceName.PaymentHandler:return ls`Payment Handler`;case Protocol.BackgroundService.ServiceName.PeriodicBackgroundSync:return ls`Periodic Background Sync`;default:return""}}constructor(e,t){super(!0),this.registerRequiredCSS("resources/backgroundServiceView.css"),this.registerRequiredCSS("ui/emptyWidget.css"),this._serviceName=e,this._model=t,this._model.addEventListener(Re.RecordingStateChanged,this._onRecordingStateChanged,this),this._model.addEventListener(Re.BackgroundServiceEventReceived,this._onEventReceived,this),this._model.enable(this._serviceName),this._serviceWorkerManager=this._model.target().model(W.ServiceWorkerManager),this._securityOriginManager=this._model.target().model(j.SecurityOriginManager),this._securityOriginManager.addEventListener(j.Events.MainSecurityOriginChanged,()=>this._onOriginChanged()),this._recordAction=C.ActionRegistry.instance().action("background-service.toggle-recording"),this._recordButton=null,this._originCheckbox=null,this._saveButton=null,this._toolbar=new b.Toolbar("background-service-toolbar",this.contentElement),this._setupToolbar(),this._splitWidget=new I.SplitWidget(!1,!0),this._splitWidget.show(this.contentElement),this._dataGrid=this._createDataGrid(),this._previewPanel=new S.VBox,this._selectedEventNode=null,this._preview=null,this._splitWidget.setMainWidget(this._dataGrid.asWidget()),this._splitWidget.setSidebarWidget(this._previewPanel),this._showPreview(null)}async _setupToolbar(){this._recordButton=b.Toolbar.createActionButton(this._recordAction),this._toolbar.appendToolbarItem(this._recordButton);const e=new b.ToolbarButton(ls`Clear`,"largeicon-clear");e.addEventListener(b.ToolbarButton.Events.Click,()=>this._clearEvents()),this._toolbar.appendToolbarItem(e),this._toolbar.appendSeparator(),this._saveButton=new b.ToolbarButton(ls`Save events`,"largeicon-download"),this._saveButton.addEventListener(b.ToolbarButton.Events.Click,e=>{this._saveToFile()}),this._saveButton.setEnabled(!1),this._toolbar.appendToolbarItem(this._saveButton),this._toolbar.appendSeparator(),this._originCheckbox=new b.ToolbarCheckbox(ls`Show events from other domains`,ls`Show events from other domains`,()=>this._refreshView()),this._toolbar.appendToolbarItem(this._originCheckbox)}_refreshView(){this._clearView();const e=this._model.getEvents(this._serviceName).filter(e=>this._acceptEvent(e));for(const t of e)this._addEvent(t)}_clearView(){this._selectedEventNode=null,this._dataGrid.rootNode().removeChildren(),this._saveButton.setEnabled(!1),this._showPreview(null)}_toggleRecording(){this._model.setRecording(!this._recordButton.toggled(),this._serviceName)}_clearEvents(){this._model.clearEvents(this._serviceName),this._clearView()}_onRecordingStateChanged(e){const t=e.data;t.serviceName===this._serviceName&&t.isRecording!==this._recordButton.toggled()&&(this._recordButton.setToggled(t.isRecording),this._updateRecordButtonTooltip(),this._showPreview(this._selectedEventNode))}_updateRecordButtonTooltip(){const e=this._recordButton.toggled()?ls`Stop recording events`:ls`Start recording events`;this._recordButton.setTitle(e,"background-service.toggle-recording")}_onEventReceived(e){const t=e.data;this._acceptEvent(t)&&this._addEvent(t)}_onOriginChanged(){this._originCheckbox.checked()||this._refreshView()}_addEvent(e){const t=this._createEventData(e),i=new Me(t,e.eventMetadata);this._dataGrid.rootNode().appendChild(i),1===this._dataGrid.rootNode().children.length&&(this._saveButton.setEnabled(!0),this._showPreview(this._selectedEventNode))}_createDataGrid(){const e=[{id:"id",title:ls`#`,weight:1},{id:"timestamp",title:ls`Timestamp`,weight:8},{id:"eventName",title:ls`Event`,weight:10},{id:"origin",title:ls`Origin`,weight:10},{id:"swScope",title:ls`SW Scope`,weight:2},{id:"instanceId",title:ls`Instance ID`,weight:10}],t=new c.DataGridImpl({displayName:ls`Background Services`,columns:e});return t.setStriped(!0),t.addEventListener(c.Events.SelectedNode,e=>this._showPreview(e.data)),t}_createEventData(e){let t="";const i=this._serviceWorkerManager.registrations().get(e.serviceWorkerRegistrationId);return i&&(t=i.scopeURL.substr(i.securityOrigin.length)),{id:this._dataGrid.rootNode().children.length+1,timestamp:f.formatTimestamp(1e3*e.timestamp,!0),origin:e.origin,swScope:t,eventName:e.eventName,instanceId:e.instanceId}}_acceptEvent(e){if(e.service!==this._serviceName)return!1;if(this._originCheckbox.checked())return!0;const t=e.origin.substr(0,e.origin.length-1);return this._securityOriginManager.securityOrigins().includes(t)}_createLearnMoreLink(){let e="https://developers.google.com/web/tools/chrome-devtools/javascript/background-services?utm_source=devtools";switch(this._serviceName){case Protocol.BackgroundService.ServiceName.BackgroundFetch:e+="#fetch";break;case Protocol.BackgroundService.ServiceName.BackgroundSync:e+="#sync";break;case Protocol.BackgroundService.ServiceName.PushMessaging:e+="#push";break;case Protocol.BackgroundService.ServiceName.Notifications:e+="#notifications"}return y.XLink.create(e,ls`Learn more`)}_showPreview(e){if(this._selectedEventNode&&this._selectedEventNode===e)return;if(this._selectedEventNode=e,this._preview&&this._preview.detach(),this._selectedEventNode)return this._preview=this._selectedEventNode.createPreview(),void this._preview.show(this._previewPanel.contentElement);this._preview=new S.VBox,this._preview.contentElement.classList.add("background-service-preview","fill");const t=this._preview.contentElement.createChild("div");if(this._dataGrid.rootNode().children.length)t.createChild("p").textContent=ls`Select an entry to view metadata`;else if(this._recordButton.toggled()){const e=De.getUIString(this._serviceName);t.createChild("p").textContent=ls`Recording ${e} activity...`,t.createChild("p").textContent=ls`DevTools will record all ${e} activity for up to 3 days, even when closed.`}else{const e=b.Toolbar.createActionButton(this._recordAction),i=document.createElement("b");i.classList.add("background-service-shortcut"),i.textContent=k.ShortcutRegistry.instance().shortcutsForAction("background-service.toggle-recording")[0].title();const s=f.createInlineButton(e);s.classList.add("background-service-record-inline-button"),t.createChild("p").appendChild(f.formatLocalized("Click the record button %s or hit %s to start recording.",[s,i])),t.appendChild(this._createLearnMoreLink())}this._preview.show(this._previewPanel.contentElement)}async _saveToFile(){const e=`${this._serviceName}-${m.toISO8601Compact(new Date)}.json`,t=new ne.FileOutputStream;if(!await t.open(e))return;const i=this._model.getEvents(this._serviceName).filter(e=>this._acceptEvent(e));await t.write(JSON.stringify(i,void 0,2)),t.close()}}class Me extends c.DataGridNode{constructor(e,t){super(e),this._eventMetadata=t.sort((e,t)=>e.key.compareTo(t.key))}createPreview(){const e=new S.VBox;e.element.classList.add("background-service-metadata");for(const t of this._eventMetadata){const i=document.createElement("div");i.classList.add("background-service-metadata-entry"),i.createChild("div","background-service-metadata-name").textContent=t.key+": ",t.value?i.createChild("div","background-service-metadata-value source-code").textContent=t.value:i.createChild("div","background-service-metadata-value background-service-empty-value").textContent=ls`empty`,e.element.appendChild(i)}if(!e.element.children.length){const t=document.createElement("div");t.classList.add("background-service-metadata-entry"),t.createChild("div","background-service-metadata-name").textContent=ls`No metadata for this event`,e.element.appendChild(t)}return e}}var Oe=Object.freeze({__proto__:null,BackgroundServiceView:De,EventDataNode:Me,ActionDelegate:class{handleAction(e,t){const i=e.flavor(De);switch(t){case"background-service.toggle-recording":return i._toggleRecording(),!0}return!1}},RecordingState:void 0,EventData:void 0});class Fe{constructor(e,t,i,s,a){this._model=e,this._id=t,this._domain=i,this._name=s,this._version=a}get id(){return this._id}get name(){return this._name}set name(e){this._name=e}get version(){return this._version}set version(e){this._version=e}get domain(){return this._domain}set domain(e){this._domain=e}async tableNames(){const{tableNames:e}=await this._model._agent.invoke_getDatabaseTableNames({databaseId:this._id})||[];return e.sort()}async executeSql(t,i,s){const a=await this._model._agent.invoke_executeSQL({databaseId:this._id,query:t}),r=a.getError()||null;if(r)return void s(r);const n=a.sqlError;if(!n)return void i(a.columnNames,a.values);let o;o=n.message?n.message:2===n.code?e.UIString("Database no longer has expected version."):e.UIString("An unexpected error %s occurred.",n.code),s(o)}}class Be extends P.SDKModel{constructor(e){super(e),this._databases=[],this._agent=e.databaseAgent(),this.target().registerDatabaseDispatcher(new Ue(this))}enable(){this._enabled||(this._agent.invoke_enable(),this._enabled=!0)}disable(){this._enabled&&(this._enabled=!1,this._databases=[],this._agent.invoke_disable(),this.dispatchEventToListeners(Ve.DatabasesRemoved))}databases(){const e=[];for(const t of this._databases)e.push(t);return e}_addDatabase(e){this._databases.push(e),this.dispatchEventToListeners(Ve.DatabaseAdded,e)}}P.SDKModel.register(Be,P.Capability.DOM,!1);const Ve={DatabaseAdded:Symbol("DatabaseAdded"),DatabasesRemoved:Symbol("DatabasesRemoved")};class Ue{constructor(e){this._model=e}addDatabase({database:e}){this._model._addDatabase(new Fe(this._model,e.id,e.domain,e.name,e.version))}usesObjectNotation(){return!0}}var Ne=Object.freeze({__proto__:null,Database:Fe,DatabaseModel:Be,Events:Ve,DatabaseDispatcher:Ue});class Pe extends n.ObjectWrapper{constructor(e,t,i){super(),this._model=e,this._securityOrigin=t,this._isLocalStorage=i}static storageId(e,t){return{securityOrigin:e,isLocalStorage:t}}get id(){return Pe.storageId(this._securityOrigin,this._isLocalStorage)}get securityOrigin(){return this._securityOrigin}get isLocalStorage(){return this._isLocalStorage}getItems(){return this._model._agent.invoke_getDOMStorageItems({storageId:this.id}).then(({entries:e})=>e)}setItem(e,t){this._model._agent.invoke_setDOMStorageItem({storageId:this.id,key:e,value:t})}removeItem(e){this._model._agent.invoke_removeDOMStorageItem({storageId:this.id,key:e})}clear(){this._model._agent.invoke_clear({storageId:this.id})}}Pe.Events={DOMStorageItemsCleared:Symbol("DOMStorageItemsCleared"),DOMStorageItemRemoved:Symbol("DOMStorageItemRemoved"),DOMStorageItemAdded:Symbol("DOMStorageItemAdded"),DOMStorageItemUpdated:Symbol("DOMStorageItemUpdated")};class Ae extends P.SDKModel{constructor(e){super(e),this._securityOriginManager=e.model(j.SecurityOriginManager),this._storages={},this._agent=e.domstorageAgent()}enable(){if(!this._enabled){if(this.target().registerDOMStorageDispatcher(new je(this)),this._securityOriginManager){this._securityOriginManager.addEventListener(j.Events.SecurityOriginAdded,this._securityOriginAdded,this),this._securityOriginManager.addEventListener(j.Events.SecurityOriginRemoved,this._securityOriginRemoved,this);for(const e of this._securityOriginManager.securityOrigins())this._addOrigin(e)}this._agent.invoke_enable(),this._enabled=!0}}clearForOrigin(e){if(this._enabled){for(const t of[!0,!1]){const i=this._storageKey(e,t),s=this._storages[i];if(!s)return;s.clear()}this._removeOrigin(e),this._addOrigin(e)}}_securityOriginAdded(e){this._addOrigin(e.data)}_addOrigin(e){const t=new a.ParsedURL(e);if(t.isValid&&"data"!==t.scheme&&"about"!==t.scheme&&"javascript"!==t.scheme)for(const t of[!0,!1]){const i=this._storageKey(e,t);console.assert(!this._storages[i]);const s=new Pe(this,e,t);this._storages[i]=s,this.dispatchEventToListeners(We.DOMStorageAdded,s)}}_securityOriginRemoved(e){this._removeOrigin(e.data)}_removeOrigin(e){for(const t of[!0,!1]){const i=this._storageKey(e,t),s=this._storages[i];s&&(delete this._storages[i],this.dispatchEventToListeners(We.DOMStorageRemoved,s))}}_storageKey(e,t){return JSON.stringify(Pe.storageId(e,t))}_domStorageItemsCleared(e){const t=this.storageForId(e);if(!t)return;t.dispatchEventToListeners(Pe.Events.DOMStorageItemsCleared,{})}_domStorageItemRemoved(e,t){const i=this.storageForId(e);if(!i)return;const s={key:t};i.dispatchEventToListeners(Pe.Events.DOMStorageItemRemoved,s)}_domStorageItemAdded(e,t,i){const s=this.storageForId(e);if(!s)return;const a={key:t,value:i};s.dispatchEventToListeners(Pe.Events.DOMStorageItemAdded,a)}_domStorageItemUpdated(e,t,i,s){const a=this.storageForId(e);if(!a)return;const r={key:t,oldValue:i,value:s};a.dispatchEventToListeners(Pe.Events.DOMStorageItemUpdated,r)}storageForId(e){return this._storages[JSON.stringify(e)]}storages(){const e=[];for(const t in this._storages)e.push(this._storages[t]);return e}}P.SDKModel.register(Ae,P.Capability.DOM,!1);const We={DOMStorageAdded:Symbol("DOMStorageAdded"),DOMStorageRemoved:Symbol("DOMStorageRemoved")};class je{constructor(e){this._model=e}domStorageItemsCleared({storageId:e}){this._model._domStorageItemsCleared(e)}domStorageItemRemoved({storageId:e,key:t}){this._model._domStorageItemRemoved(e,t)}domStorageItemAdded({storageId:e,key:t,newValue:i}){this._model._domStorageItemAdded(e,t,i)}domStorageItemUpdated({storageId:e,key:t,oldValue:i,newValue:s}){this._model._domStorageItemUpdated(e,t,i,s)}usesObjectNotation(){return!0}}var qe=Object.freeze({__proto__:null,DOMStorage:Pe,DOMStorageModel:Ae,Events:We,DOMStorageDispatcher:je});class Ge extends P.SDKModel{constructor(e){super(e),e.registerStorageDispatcher(this),this._securityOriginManager=e.model(j.SecurityOriginManager),this._indexedDBAgent=e.indexedDBAgent(),this._storageAgent=e.storageAgent(),this._databases=new Map,this._databaseNamesBySecurityOrigin={},this._originsUpdated=new Set,this._throttler=new i.Throttler(1e3)}usesObjectNotation(){return!0}static keyFromIDBKey(e){if(null==e)return;let t;switch(typeof e){case"number":t={type:Protocol.IndexedDB.KeyType.Number,number:e};break;case"string":t={type:Protocol.IndexedDB.KeyType.String,string:e};break;case"object":if(e instanceof Date)t={type:Protocol.IndexedDB.KeyType.Date,date:e.getTime()};else{if(!Array.isArray(e))return;{const i=[];for(let t=0;t<e.length;++t){const s=Ge.keyFromIDBKey(e[t]);s&&i.push(s)}t={type:Protocol.IndexedDB.KeyType.Array,array:i}}}break;default:return}return t}static _keyRangeFromIDBKeyRange(e){const t={};return t.lower=Ge.keyFromIDBKey(e.lower),t.upper=Ge.keyFromIDBKey(e.upper),t.lowerOpen=!!e.lowerOpen,t.upperOpen=!!e.upperOpen,t}static idbKeyPathFromKeyPath(e){let t;switch(e.type){case Protocol.IndexedDB.KeyPathType.Null:t=null;break;case Protocol.IndexedDB.KeyPathType.String:t=e.string;break;case Protocol.IndexedDB.KeyPathType.Array:t=e.array}return t}static keyPathStringFromIDBKeyPath(e){return"string"==typeof e?'"'+e+'"':e instanceof Array?'["'+e.join('", "')+'"]':null}enable(){if(!this._enabled){if(this._indexedDBAgent.invoke_enable(),this._securityOriginManager){this._securityOriginManager.addEventListener(j.Events.SecurityOriginAdded,this._securityOriginAdded,this),this._securityOriginManager.addEventListener(j.Events.SecurityOriginRemoved,this._securityOriginRemoved,this);for(const e of this._securityOriginManager.securityOrigins())this._addOrigin(e)}this._enabled=!0}}clearForOrigin(e){this._enabled&&this._databaseNamesBySecurityOrigin[e]&&(this._removeOrigin(e),this._addOrigin(e))}async deleteDatabase(e){this._enabled&&(await this._indexedDBAgent.invoke_deleteDatabase({securityOrigin:e.securityOrigin,databaseName:e.name}),this._loadDatabaseNames(e.securityOrigin))}async refreshDatabaseNames(){for(const e in this._databaseNamesBySecurityOrigin)await this._loadDatabaseNames(e);this.dispatchEventToListeners(ze.DatabaseNamesRefreshed)}refreshDatabase(e){this._loadDatabase(e,!0)}async clearObjectStore(e,t){await this._indexedDBAgent.invoke_clearObjectStore({securityOrigin:e.securityOrigin,databaseName:e.name,objectStoreName:t})}async deleteEntries(e,t,i){const s=Ge._keyRangeFromIDBKeyRange(i);await this._indexedDBAgent.invoke_deleteObjectStoreEntries({securityOrigin:e.securityOrigin,databaseName:e.name,objectStoreName:t,keyRange:s})}_securityOriginAdded(e){const t=e.data;this._addOrigin(t)}_securityOriginRemoved(e){const t=e.data;this._removeOrigin(t)}_addOrigin(e){console.assert(!this._databaseNamesBySecurityOrigin[e]),this._databaseNamesBySecurityOrigin[e]=[],this._loadDatabaseNames(e),this._isValidSecurityOrigin(e)&&this._storageAgent.invoke_trackIndexedDBForOrigin({origin:e})}_removeOrigin(e){console.assert(!!this._databaseNamesBySecurityOrigin[e]);for(let t=0;t<this._databaseNamesBySecurityOrigin[e].length;++t)this._databaseRemoved(e,this._databaseNamesBySecurityOrigin[e][t]);delete this._databaseNamesBySecurityOrigin[e],this._isValidSecurityOrigin(e)&&this._storageAgent.invoke_untrackIndexedDBForOrigin({origin:e})}_isValidSecurityOrigin(e){const t=a.ParsedURL.fromString(e);return!!t&&t.scheme.startsWith("http")}_updateOriginDatabaseNames(e,t){const i=new Set(t),s=new Set(this._databaseNamesBySecurityOrigin[e]);this._databaseNamesBySecurityOrigin[e]=t;for(const t of s)i.has(t)||this._databaseRemoved(e,t);for(const t of i)s.has(t)||this._databaseAdded(e,t)}databases(){const e=[];for(const t in this._databaseNamesBySecurityOrigin){const i=this._databaseNamesBySecurityOrigin[t];for(let s=0;s<i.length;++s)e.push(new $e(t,i[s]))}return e}_databaseAdded(e,t){const i=new $e(e,t);this.dispatchEventToListeners(ze.DatabaseAdded,{model:this,databaseId:i})}_databaseRemoved(e,t){const i=new $e(e,t);this.dispatchEventToListeners(ze.DatabaseRemoved,{model:this,databaseId:i})}async _loadDatabaseNames(e){const{databaseNames:t}=await this._indexedDBAgent.invoke_requestDatabaseNames({securityOrigin:e});return t&&this._databaseNamesBySecurityOrigin[e]?(this._updateOriginDatabaseNames(e,t),t):[]}async _loadDatabase(e,t){const{databaseWithObjectStores:i}=await this._indexedDBAgent.invoke_requestDatabase({securityOrigin:e.securityOrigin,databaseName:e.name});if(!i)return;if(!this._databaseNamesBySecurityOrigin[e.securityOrigin])return;const s=new He(e,i.version);this._databases.set(e,s);for(const e of i.objectStores){const t=Ge.idbKeyPathFromKeyPath(e.keyPath),i=new Qe(e.name,t,e.autoIncrement);for(let t=0;t<e.indexes.length;++t){const s=e.indexes[t],a=Ge.idbKeyPathFromKeyPath(s.keyPath),r=new Xe(s.name,a,s.unique,s.multiEntry);i.indexes.set(r.name,r)}s.objectStores.set(i.name,i)}this.dispatchEventToListeners(ze.DatabaseLoaded,{model:this,database:s,entriesUpdated:t})}loadObjectStoreData(e,t,i,s,a,r){this._requestData(e,e.name,t,"",i,s,a,r)}loadIndexData(e,t,i,s,a,r,n){this._requestData(e,e.name,t,i,s,a,r,n)}async _requestData(e,t,i,s,a,r,n,o){const d=a?Ge._keyRangeFromIDBKeyRange(a):void 0,l=await this._indexedDBAgent.invoke_requestData({securityOrigin:e.securityOrigin,databaseName:t,objectStoreName:i,indexName:s,skipCount:r,pageSize:n,keyRange:d});if(l.getError())return void console.error("IndexedDBAgent error: "+l.getError());const c=this.target().model(q.RuntimeModel);if(!c||!this._databaseNamesBySecurityOrigin[e.securityOrigin])return;const h=l.objectStoreDataEntries,_=[];for(const e of h){const t=c.createRemoteObject(e.key),i=c.createRemoteObject(e.primaryKey),s=c.createRemoteObject(e.value);_.push(new Ke(t,i,s))}o(_,l.hasMore)}async getMetadata(e,t){const i=e.securityOrigin,s=e.name,a=t.name,r=await this._indexedDBAgent.invoke_getMetadata({securityOrigin:i,databaseName:s,objectStoreName:a});return r.getError()?(console.error("IndexedDBAgent error: "+r.getError()),null):{entriesCount:r.entriesCount,keyGeneratorValue:r.keyGeneratorValue}}async _refreshDatabaseList(e){const t=await this._loadDatabaseNames(e);for(const i of t)this._loadDatabase(new $e(e,i),!1)}indexedDBListUpdated({origin:e}){this._originsUpdated.add(e),this._throttler.schedule(()=>{const e=Array.from(this._originsUpdated,e=>{this._refreshDatabaseList(e)});return this._originsUpdated.clear(),Promise.all(e)})}indexedDBContentUpdated({origin:e,databaseName:t,objectStoreName:i}){const s=new $e(e,t);this.dispatchEventToListeners(ze.IndexedDBContentUpdated,{databaseId:s,objectStoreName:i,model:this})}cacheStorageListUpdated(e){}cacheStorageContentUpdated(e){}}P.SDKModel.register(Ge,P.Capability.Storage,!1);const ze={DatabaseAdded:Symbol("DatabaseAdded"),DatabaseRemoved:Symbol("DatabaseRemoved"),DatabaseLoaded:Symbol("DatabaseLoaded"),DatabaseNamesRefreshed:Symbol("DatabaseNamesRefreshed"),IndexedDBContentUpdated:Symbol("IndexedDBContentUpdated")};class Ke{constructor(e,t,i){this.key=e,this.primaryKey=t,this.value=i}}class $e{constructor(e,t){this.securityOrigin=e,this.name=t}equals(e){return this.name===e.name&&this.securityOrigin===e.securityOrigin}}class He{constructor(e,t){this.databaseId=e,this.version=t,this.objectStores=new Map}}class Qe{constructor(e,t,i){this.name=e,this.keyPath=t,this.autoIncrement=i,this.indexes=new Map}get keyPathString(){return Ge.keyPathStringFromIDBKeyPath(this.keyPath)}}class Xe{constructor(e,t,i,s){this.name=e,this.keyPath=t,this.unique=i,this.multiEntry=s}get keyPathString(){return Ge.keyPathStringFromIDBKeyPath(this.keyPath)}}var Je=Object.freeze({__proto__:null,IndexedDBModel:Ge,Events:ze,Entry:Ke,DatabaseId:$e,Database:He,ObjectStore:Qe,Index:Xe,ObjectStoreMetadata:void 0});class Ye extends E.ThrottledWidget{constructor(){super(!0,1e3),this.registerRequiredCSS("resources/clearStorageView.css"),this.contentElement.classList.add("clear-storage-container");const i=Protocol.Storage.StorageType;this._pieColors=new Map([[i.Appcache,"rgb(110, 161, 226)"],[i.Cache_storage,"rgb(229, 113, 113)"],[i.Cookies,"rgb(239, 196, 87)"],[i.Indexeddb,"rgb(155, 127, 230)"],[i.Local_storage,"rgb(116, 178, 102)"],[i.Service_workers,"rgb(255, 167, 36)"],[i.Websql,"rgb(203, 220, 56)"]]),this._reportView=new w.ReportView(e.UIString("Clear storage")),this._reportView.registerRequiredCSS("resources/clearStorageView.css"),this._reportView.element.classList.add("clear-storage-header"),this._reportView.show(this.contentElement),this._target=null,this._securityOrigin=null,this._settings=new Map;for(const e of Ze)this._settings.set(e,t.Settings.instance().createSetting("clear-storage-"+e,!0));const s=this._reportView.appendSection(e.UIString("Usage"));this._quotaRow=s.appendSelectableRow();const a=s.appendRow(),r=y.XLink.create("https://developers.google.com/web/tools/chrome-devtools/progressive-web-apps#opaque-responses",ls`Learn more`);a.appendChild(r),this._quotaUsage=null,this._pieChart=de.createPieChart(),this._populatePieChart(0,[]);const n=s.appendRow();n.classList.add("usage-breakdown-row"),n.appendChild(this._pieChart);const o=this._reportView.appendSection("","clear-storage-button").appendRow();this._clearButton=f.createTextButton(ls`Clear site data`,this._clear.bind(this)),o.appendChild(this._clearButton);const d=this._reportView.appendSection(e.UIString("Application"));this._appendItem(d,e.UIString("Unregister service workers"),"service_workers"),d.markFieldListAsGroup();const l=this._reportView.appendSection(e.UIString("Storage"));this._appendItem(l,e.UIString("Local and session storage"),"local_storage"),this._appendItem(l,e.UIString("IndexedDB"),"indexeddb"),this._appendItem(l,e.UIString("Web SQL"),"websql"),this._appendItem(l,e.UIString("Cookies"),"cookies"),l.markFieldListAsGroup();const c=this._reportView.appendSection(e.UIString("Cache"));this._appendItem(c,e.UIString("Cache storage"),"cache_storage"),this._appendItem(c,e.UIString("Application cache"),"appcache"),c.markFieldListAsGroup(),P.TargetManager.instance().observeTargets(this)}_appendItem(e,t,i){e.appendRow().appendChild(T.createSettingCheckbox(t,this._settings.get(i),!0))}targetAdded(e){if(this._target)return;this._target=e;const t=e.model(j.SecurityOriginManager);this._updateOrigin(t.mainSecurityOrigin(),t.unreachableMainSecurityOrigin()),t.addEventListener(j.Events.MainSecurityOriginChanged,this._originChanged,this)}targetRemoved(e){if(this._target!==e)return;e.model(j.SecurityOriginManager).removeEventListener(j.Events.MainSecurityOriginChanged,this._originChanged,this)}_originChanged(e){const t=e.data.mainSecurityOrigin,i=e.data.unreachableMainSecurityOrigin;this._updateOrigin(t,i)}_updateOrigin(e,t){t?(this._securityOrigin=t,this._reportView.setSubtitle(ls`${t} (failed to load)`)):(this._securityOrigin=e,this._reportView.setSubtitle(e)),this.doUpdate()}_clear(){if(!this._securityOrigin)return;const t=[];for(const e of this._settings.keys())this._settings.get(e).get()&&t.push(e);this._target&&Ye.clear(this._target,this._securityOrigin,t),this._clearButton.disabled=!0;const i=this._clearButton.textContent;this._clearButton.textContent=e.UIString("Clearing..."),setTimeout(()=>{this._clearButton.disabled=!1,this._clearButton.textContent=i,this._clearButton.focus()},500)}static clear(e,t,i){e.storageAgent().invoke_clearDataForOrigin({origin:t,storageTypes:i.join(",")});const s=new Set(i),a=s.has(Protocol.Storage.StorageType.All);if(s.has(Protocol.Storage.StorageType.Cookies)||a){const t=e.model(G.CookieModel);t&&t.clear()}if(s.has(Protocol.Storage.StorageType.Indexeddb)||a)for(const e of P.TargetManager.instance().targets()){const i=e.model(Ge);i&&i.clearForOrigin(t)}if(s.has(Protocol.Storage.StorageType.Local_storage)||a){const i=e.model(Ae);i&&i.clearForOrigin(t)}if(s.has(Protocol.Storage.StorageType.Websql)||a){const t=e.model(Be);t&&(t.disable(),t.enable())}if(s.has(Protocol.Storage.StorageType.Cache_storage)||a){const e=P.TargetManager.instance().mainTarget(),i=e&&e.model(z.ServiceWorkerCacheModel);i&&i.clearForOrigin(t)}if(s.has(Protocol.Storage.StorageType.Appcache)||a){const t=e.model(Se);t&&t.reset()}}async doUpdate(){if(!this._securityOrigin||!this._target)return this._quotaRow.textContent="",void this._populatePieChart(0,[]);const t=this._securityOrigin,i=await this._target.storageAgent().invoke_getUsageAndQuota({origin:t});if(i.getError())return this._quotaRow.textContent="",void this._populatePieChart(0,[]);if(this._quotaRow.textContent=e.UIString("%s used out of %s storage quota. ",_.bytesToString(i.usage),_.bytesToString(i.quota)),i.quota<125829120&&(this._quotaRow.title=ls`Storage quota is limited in Incognito mode`,this._quotaRow.appendChild(L.Icon.create("smallicon-info"))),null===this._quotaUsage||this._quotaUsage!==i.usage){this._quotaUsage=i.usage;const e=[];for(const t of i.usageBreakdown.sort((e,t)=>t.usage-e.usage)){const i=t.usage;if(!i)continue;const s=this._getStorageTypeName(t.storageType),a=this._pieColors.get(t.storageType)||"#ccc";e.push({value:i,color:a,title:s})}this._populatePieChart(i.usage,e)}this._usageUpdatedForTest(i.usage,i.quota,i.usageBreakdown),this.update()}_populatePieChart(e,t){this._pieChart.data={chartName:ls`Storage usage`,size:110,formatter:_.bytesToString,showLegend:!0,total:e,slices:t}}_getStorageTypeName(t){switch(t){case Protocol.Storage.StorageType.File_systems:return e.UIString("File System");case Protocol.Storage.StorageType.Websql:return e.UIString("Web SQL");case Protocol.Storage.StorageType.Appcache:return e.UIString("Application Cache");case Protocol.Storage.StorageType.Indexeddb:return e.UIString("IndexedDB");case Protocol.Storage.StorageType.Cache_storage:return e.UIString("Cache Storage");case Protocol.Storage.StorageType.Service_workers:return e.UIString("Service Workers");default:return e.UIString("Other")}}_usageUpdatedForTest(e,t,i){}}const Ze=[Protocol.Storage.StorageType.Appcache,Protocol.Storage.StorageType.Cache_storage,Protocol.Storage.StorageType.Cookies,Protocol.Storage.StorageType.Indexeddb,Protocol.Storage.StorageType.Local_storage,Protocol.Storage.StorageType.Service_workers,Protocol.Storage.StorageType.Websql];var et=Object.freeze({__proto__:null,ClearStorageView:Ye,AllStorageTypes:Ze,ActionDelegate:class{handleAction(e,t){switch(t){case"resources.clear":return this._handleClear()}return!1}_handleClear(){const e=P.TargetManager.instance().mainTarget();if(!e)return!1;const t=e.model(A.ResourceTreeModel);if(!t)return!1;const i=t.getMainSecurityOrigin();return!!i&&(Ye.clear(e,i,Ze),!0)}}});class tt extends S.VBox{constructor(e){super(),this.database=e,this.element.classList.add("storage-view","query","monospace"),this.element.addEventListener("selectstart",this._selectStart.bind(this),!1),this._queryWrapper=this.element.createChild("div","database-query-group-messages"),this._queryWrapper.addEventListener("focusin",this._onFocusIn.bind(this)),this._queryWrapper.addEventListener("focusout",this._onFocusOut.bind(this)),this._queryWrapper.addEventListener("keydown",this._onKeyDown.bind(this)),this._queryWrapper.tabIndex=-1,this._promptContainer=this.element.createChild("div","database-query-prompt-container"),this._promptContainer.appendChild(L.Icon.create("smallicon-text-prompt","prompt-icon")),this._promptElement=this._promptContainer.createChild("div"),this._promptElement.className="database-query-prompt",this._promptElement.addEventListener("keydown",this._promptKeyDown.bind(this)),this._prompt=new R.TextPrompt,this._prompt.initialize(this.completions.bind(this)," "),this._proxyElement=this._prompt.attach(this._promptElement),this.element.addEventListener("click",this._messagesClicked.bind(this),!0),this._queryResults=[],this._virtualSelectedIndex=-1,this._lastSelectedElement,this._selectionTimeout=0}_messagesClicked(){this._prompt.focus(),this._prompt.isCaretInsidePrompt()||this.element.hasSelection()||this._prompt.moveCaretToEndOfPrompt()}_onKeyDown(e){if(!f.isEditing()&&this._queryResults.length&&!e.shiftKey){switch(e.key){case"ArrowUp":if(!(this._virtualSelectedIndex>0))return;this._virtualSelectedIndex--;break;case"ArrowDown":if(!(this._virtualSelectedIndex<this._queryResults.length-1))return;this._virtualSelectedIndex++;break;case"Home":this._virtualSelectedIndex=0;break;case"End":this._virtualSelectedIndex=this._queryResults.length-1;break;default:return}e.consume(!0),this._updateFocusedItem()}}_onFocusIn(e){-1===this._virtualSelectedIndex&&this._isOutsideViewport(e.relatedTarget)&&e.target===this._queryWrapper&&this._queryResults.length&&(this._virtualSelectedIndex=this._queryResults.length-1),this._updateFocusedItem()}_onFocusOut(e){this._isOutsideViewport(e.relatedTarget)&&(this._virtualSelectedIndex=-1),this._updateFocusedItem(),this._queryWrapper.scrollTop=1e7}_isOutsideViewport(e){return!!e&&!e.isSelfOrDescendant(this._queryWrapper)}_updateFocusedItem(){let e=this._virtualSelectedIndex;this._queryResults.length&&this._virtualSelectedIndex<0&&(e=this._queryResults.length-1);const t=e>=0?this._queryResults[e]:null,i=this._lastSelectedElement!==t,s=this._queryWrapper===this.element.ownerDocument.deepActiveElement();t&&(i||s)&&this.element.hasFocus()&&(t.hasFocus()||t.focus()),this._queryResults.length&&!this._queryWrapper.hasFocus()?this._queryWrapper.tabIndex=0:this._queryWrapper.tabIndex=-1,this._lastSelectedElement=t}async completions(e,t,i){if(!t)return[];t=t.toLowerCase();return(await this.database.tableNames()).map(e=>e+" ").concat(st).filter(e=>e.toLowerCase().startsWith(t)).map(e=>({text:e}))}_selectStart(e){this._selectionTimeout&&clearTimeout(this._selectionTimeout),this._prompt.clearAutocomplete(),this._selectionTimeout=window.setTimeout(function(){this._selectionTimeout=0,this._prompt.isCaretInsidePrompt()||this.element.hasSelection()||this._prompt.moveCaretToEndOfPrompt(),this._prompt.autoCompleteSoon()}.bind(this),100)}_promptKeyDown(e){isEnterKey(e)&&this._enterKeyPressed(e)}async _enterKeyPressed(e){e.consume(!0);const t=this._prompt.textWithCurrentSuggestion();if(this._prompt.clearAutocomplete(),t.length){this._prompt.setEnabled(!1);try{const e=await new Promise((e,i)=>{this.database.executeSql(t,(t,i)=>e({columnNames:t,values:i}),e=>i(e))});this._queryFinished(t,e.columnNames,e.values)}catch(e){this._appendErrorQueryResult(t,e)}this._prompt.setEnabled(!0),this._prompt.setText(""),this._prompt.focus()}}_queryFinished(e,t,i){const s=h.SortableDataGrid.create(t||[],i||[],ls`Database Query`),a=e.trim();let r=null;s&&(s.setStriped(!0),s.renderInline(),s.autoSizeColumns(5),r=s.asWidget(),s.setFocusable(!1)),this._appendViewQueryResult(a,r),(a.match(/^create /i)||a.match(/^drop table /i))&&this.dispatchEventToListeners(it.SchemaUpdated,this.database)}_appendViewQueryResult(e,t){const i=this._appendQueryResult(e);t?t.show(i):i.remove(),this._scrollResultIntoView()}_appendErrorQueryResult(e,t){const i=this._appendQueryResult(e);i.classList.add("error"),i.appendChild(L.Icon.create("smallicon-error","prompt-icon")),f.createTextChild(i,t),this._scrollResultIntoView()}_scrollResultIntoView(){this._queryResults[this._queryResults.length-1].scrollIntoView(!1),this._promptElement.scrollIntoView(!1)}_appendQueryResult(e){const t=document.createElement("div");t.className="database-user-query",t.tabIndex=-1,x.setAccessibleName(t,ls`Query: ${e}`),this._queryResults.push(t),this._updateFocusedItem(),t.appendChild(L.Icon.create("smallicon-user-command","prompt-icon"));const i=document.createElement("span");i.className="database-query-text",i.textContent=e,t.appendChild(i);const s=document.createElement("div");return s.className="database-query-result",t.appendChild(s),this._queryWrapper.appendChild(t),s}}const it={SchemaUpdated:Symbol("SchemaUpdated")},st=["SELECT ","FROM ","WHERE ","LIMIT ","DELETE FROM ","CREATE ","DROP ","TABLE ","INDEX ","UPDATE ","INSERT INTO ","VALUES ("];var at=Object.freeze({__proto__:null,DatabaseQueryView:tt,Events:it,SQL_BUILT_INS:st});class rt extends g.SimpleView{constructor(i,s){super(e.UIString("Database")),this.database=i,this.tableName=s,this.element.classList.add("storage-view","table"),this._visibleColumnsSetting=t.Settings.instance().createSetting("databaseTableViewVisibleColumns",{}),this.refreshButton=new b.ToolbarButton(e.UIString("Refresh"),"largeicon-refresh"),this.refreshButton.addEventListener(b.ToolbarButton.Events.Click,this._refreshButtonClicked,this),this._visibleColumnsInput=new b.ToolbarInput(e.UIString("Visible columns"),"",1),this._visibleColumnsInput.addEventListener(b.ToolbarInput.Event.TextChanged,this._onVisibleColumnsChanged,this),this._dataGrid}wasShown(){this.update()}async toolbarItems(){return[this.refreshButton,this._visibleColumnsInput]}_escapeTableName(e){return e.replace(/\"/g,'""')}update(){this.database.executeSql('SELECT rowid, * FROM "'+this._escapeTableName(this.tableName)+'"',this._queryFinished.bind(this),this._queryError.bind(this))}_queryFinished(e,t){if(this.detachChildWidgets(),this.element.removeChildren(),this._dataGrid=h.SortableDataGrid.create(e,t,ls`Database`),this._visibleColumnsInput.setVisible(!!this._dataGrid),!this._dataGrid)return this._emptyWidget=new v.EmptyWidget(ls`The "${this.tableName}"\ntable is empty.`),void this._emptyWidget.show(this.element);this._dataGrid.setStriped(!0),this._dataGrid.asWidget().show(this.element),this._dataGrid.autoSizeColumns(5),this._columnsMap=new Map;for(let t=1;t<e.length;++t)this._columnsMap.set(e[t],String(t));this._lastVisibleColumns="";const i=this._visibleColumnsSetting.get()[this.tableName]||"";this._visibleColumnsInput.setValue(i),this._onVisibleColumnsChanged()}_onVisibleColumnsChanged(){if(!this._dataGrid)return;const e=this._visibleColumnsInput.value(),t=e.split(/[\s,]+/),i=new Set,s={0:!0};for(let e=0;e<t.length;++e){const a=t[e];this._columnsMap.has(a)&&(i.add(a),s[this._columnsMap.get(a)]=!0)}const a=[...i].sort().join(", ");if(0===a.length)for(const e of this._columnsMap.values())s[e]=!0;if(a===this._lastVisibleColumns)return;const r=this._visibleColumnsSetting.get();r[this.tableName]=e,this._visibleColumnsSetting.set(r),this._dataGrid.setColumnsVisiblity(s),this._lastVisibleColumns=a}_queryError(e){this.detachChildWidgets(),this.element.removeChildren();const t=createElement("div");t.className="storage-table-error",t.textContent=ls`An error occurred trying to\nread the "${this.tableName}" table.`,this.element.appendChild(t)}_refreshButtonClicked(e){this.update()}}var nt=Object.freeze({__proto__:null,DatabaseTableView:rt});const ot=e=>e?ls`Yes`:ls`No`;class dt extends E.ThrottledWidget{constructor(e){super(),this.registerRequiredCSS("resources/frameDetailsReportView.css"),this._frame=e,this.contentElement.classList.add("frame-details-container"),this._reportView=new w.ReportView(e.displayName()),this._reportView.registerRequiredCSS("resources/frameDetailsReportView.css"),this._reportView.show(this.contentElement),this._reportView.element.classList.add("frame-details-report-container"),this._generalSection=this._reportView.appendSection(ls`Document`),this._urlFieldValue=this._generalSection.appendField(ls`URL`),this._urlStringElement=this._urlFieldValue.createChild("div","text-ellipsis"),this._unreachableURL=this._generalSection.appendField(ls`Unreachable URL`);const t=this._generalSection.appendField(ls`Origin`);this._originStringElement=t.createChild("div","text-ellipsis"),this._ownerFieldValue=this._generalSection.appendField(ls`Owner Element`),this._adStatus=this._generalSection.appendField(ls`Ad Status`),this._isolationSection=this._reportView.appendSection(ls`Security & Isolation`),this._secureContext=this._isolationSection.appendField(ls`Secure Context`),this._crossOriginIsolatedContext=this._isolationSection.appendField(ls`Cross-Origin Isolated`),this._coepPolicy=this._isolationSection.appendField(ls`Cross-Origin Embedder Policy`),this._coopPolicy=this._isolationSection.appendField(ls`Cross-Origin Opener Policy`),this._apiAvailability=this._reportView.appendSection(ls`API availablity`);const i=this._apiAvailability.appendRow(),s=ls`Availability of certain APIs depends on the document being cross-origin isolated.`;i.appendChild(D.html`<div>${s} ${y.XLink.create("https://web.dev/why-coop-coep/",ls`Learn more`)}</div>`),this.update()}async doUpdate(){if(this._urlFieldValue.removeChildren(),this._urlStringElement.textContent=this._frame.url,this._urlStringElement.title=this._frame.url,this._urlFieldValue.appendChild(this._urlStringElement),!this._frame.unreachableUrl()){const e=this.uiSourceCodeForFrame(this._frame),t=lt("mediumicon-sources-panel",ls`Click to reveal in Sources panel`,()=>o.reveal(e));this._urlFieldValue.appendChild(t)}dt.maybeAppendLinkToRequest(this._urlFieldValue,this._frame.resourceForURL(this._frame.url)),this._maybeAppendLinkForUnreachableUrl(),this._frame.securityOrigin&&"://"!==this._frame.securityOrigin?(this._originStringElement.textContent=this._frame.securityOrigin,this._originStringElement.title=this._frame.securityOrigin,this._generalSection.setFieldVisible(ls`Origin`,!0)):this._generalSection.setFieldVisible(ls`Origin`,!1),this._updateAdStatus(),this._ownerFieldValue.removeChildren();const e=await ct(this._frame);e&&this._ownerFieldValue.appendChild(e),await this._updateCoopCoepStatus(),this._updateContextStatus()}uiSourceCodeForFrame(e){for(const t of me.WorkspaceImpl.instance().projects()){const i=oe.NetworkProject.getTargetForProject(t);if(i&&i===e.resourceTreeModel().target()){const i=t.uiSourceCodeForURL(e.url);if(i)return i}}return null}static fillCrossOriginPolicy(e,t,i){const s=t(i.value);if(e.textContent=s?i.value:i.reportOnlyValue,!s&&t(i.reportOnlyValue)){const t=document.createElement("span");t.classList.add("inline-comment"),t.textContent="report-only",e.appendChild(t)}const a=s?i.reportingEndpoint:i.reportOnlyReportingEndpoint;if(a){e.createChild("span","inline-name").textContent=ls`reporting to`;e.createChild("span").textContent=a}}async _updateCoopCoepStatus(){const e=this._frame.resourceTreeModel().target().model(K.NetworkManager),t=e&&await e.getSecurityIsolationStatus(this._frame.id);if(!t)return;dt.fillCrossOriginPolicy(this._coepPolicy,e=>e!==Protocol.Network.CrossOriginEmbedderPolicyValue.None,t.coep);dt.fillCrossOriginPolicy(this._coopPolicy,e=>e!==Protocol.Network.CrossOriginOpenerPolicyValue.UnsafeNone,t.coop)}_explanationFromSecureContextType(e){switch(e){case Protocol.Page.SecureContextType.Secure:return null;case Protocol.Page.SecureContextType.SecureLocalhost:return ls`Localhost is always a secure context`;case Protocol.Page.SecureContextType.InsecureAncestor:return ls`A frame ancestor is an insecure context`;case Protocol.Page.SecureContextType.InsecureScheme:return ls`The frame's scheme is insecure`}return null}_updateContextStatus(){if(this._frame.unreachableUrl())return this._isolationSection.setFieldVisible(ls`Secure Context`,!1),void this._isolationSection.setFieldVisible(ls`Cross-Origin Isolated`,!1);this._isolationSection.setFieldVisible(ls`Secure Context`,!0),this._isolationSection.setFieldVisible(ls`Cross-Origin Isolated`,!0),this._secureContext.textContent=ot(this._frame.isSecureContext());const e=this._explanationFromSecureContextType(this._frame.getSecureContextType());if(e){this._secureContext.createChild("span","inline-comment").textContent=e}this._crossOriginIsolatedContext.textContent=ot(this._frame.isCrossOriginIsolated())}static maybeAppendLinkToRequest(e,t){if(t&&t.request){const i=t.request,s=lt("mediumicon-network-panel",ls`Click to reveal in Network panel`,()=>le.NetworkPanel.selectAndShowRequest(i,ce.Tabs.Headers));e.appendChild(s)}}_maybeAppendLinkForUnreachableUrl(){if(!this._frame.unreachableUrl())return void this._generalSection.setFieldVisible(ls`Unreachable URL`,!1);this._generalSection.setFieldVisible(ls`Unreachable URL`,!0),this._unreachableURL.textContent=this._frame.unreachableUrl();const e=a.ParsedURL.fromString(this._frame.unreachableUrl());if(!e)return;const t=lt("mediumicon-network-panel",ls`Click to reveal in Network panel (might require page reload)`,()=>{le.NetworkPanel.revealAndFilter([{filterType:"domain",filterValue:e.domain()},{filterType:null,filterValue:e.path}])});this._unreachableURL.appendChild(t)}_updateAdStatus(){switch(this._frame.adFrameType()){case Protocol.Page.AdFrameType.Root:this._generalSection.setFieldVisible(ls`Ad Status`,!0),this._adStatus.textContent=ls`root`,this._adStatus.title=ls`This frame has been identified as the root frame of an ad`;break;case Protocol.Page.AdFrameType.Child:this._generalSection.setFieldVisible(ls`Ad Status`,!0),this._adStatus.textContent=ls`child`,this._adStatus.title=ls`This frame has been identified as the a child frame of an ad`;break;default:this._generalSection.setFieldVisible(ls`Ad Status`,!1)}}}function lt(e,t,i){const s=L.Icon.create(e,"icon-link devtools-link"),a=document.createElement("span");return a.title=t,a.classList.add("devtools-link"),a.tabIndex=0,a.appendChild(s),a.addEventListener("click",()=>i()),a.addEventListener("keydown",e=>{isEnterKey(e)&&i()}),a}async function ct(e){let t=null;if(e instanceof A.ResourceTreeFrame?t=e:e&&(t=$.FrameManager.instance().getFrame(e)),!t)return null;const i=await t.getOwnerDOMNodeOrDocument();if(!i)return null;const s=lt("mediumicon-elements-panel",ls`Click to reveal in Elements panel`,()=>o.reveal(i)),a=document.createElement("span");return a.textContent=`<${i.nodeName().toLocaleLowerCase()}>`,s.insertBefore(a,s.firstChild),s.addEventListener("mouseenter",()=>{t&&t.highlight()}),s.addEventListener("mouseleave",()=>{H.OverlayModel.hideDOMNodeHighlight()}),s}class ht extends E.ThrottledWidget{constructor(e,t){super(),this._targetInfo=e,this._isWindowClosed=t,this.registerRequiredCSS("resources/frameDetailsReportView.css"),this.contentElement.classList.add("frame-details-container"),this._reportView=new w.ReportView(this.buildTitle()),this._reportView.registerRequiredCSS("resources/frameDetailsReportView.css"),this._reportView.show(this.contentElement),this._reportView.element.classList.add("frame-details-report-container"),this._documentSection=this._reportView.appendSection(ls`Document`),this._URLFieldValue=this._documentSection.appendField(ls`URL`),this._securitySection=this._reportView.appendSection(ls`Security`),this._openerElementField=this._securitySection.appendField(ls`Opener Frame`),this._securitySection.setFieldVisible(ls`Opener Frame`,!1),this._hasDOMAccessValue=this._securitySection.appendField(ls`Access to opener`),this._hasDOMAccessValue.title=ls`Shows whether the opened window is able to access its opener and vice versa`,this.update()}async doUpdate(){this._reportView.setTitle(this.buildTitle()),this._URLFieldValue.textContent=this._targetInfo.url,this._hasDOMAccessValue.textContent=ot(this._targetInfo.canAccessOpener),this.maybeDisplayOpenerFrame()}async maybeDisplayOpenerFrame(){this._openerElementField.removeChildren();const e=await ct(this._targetInfo.openerFrameId);if(e)return this._openerElementField.append(e),void this._securitySection.setFieldVisible(ls`Opener Frame`,!0);this._securitySection.setFieldVisible(ls`Opener Frame`,!1)}buildTitle(){let e=this._targetInfo.title||ls`Window without title`;return this._isWindowClosed&&(e+=` (${ls`closed`})`),e}setIsWindowClosed(e){this._isWindowClosed=e}setTargetInfo(e){this._targetInfo=e}}class _t extends E.ThrottledWidget{constructor(e){super(),this._targetInfo=e,this.registerRequiredCSS("resources/frameDetailsReportView.css"),this.contentElement.classList.add("frame-details-container"),this._reportView=new w.ReportView(this._targetInfo.title||this._targetInfo.url||ls`worker`),this._reportView.registerRequiredCSS("resources/frameDetailsReportView.css"),this._reportView.show(this.contentElement),this._reportView.element.classList.add("frame-details-report-container"),this._documentSection=this._reportView.appendSection(ls`Document`),this._URLFieldValue=this._documentSection.appendField(ls`URL`),this._URLFieldValue.textContent=this._targetInfo.url}}var mt=Object.freeze({__proto__:null,FrameDetailsView:dt,OpenedWindowDetailsView:ht,WorkerDetailsView:_t});class ut extends S.VBox{constructor(e,t){super(),this._model=e;const i=t?t.databaseId.name:ls`Loading…`;this._reportView=new w.ReportView(i),this._reportView.show(this.contentElement);const s=this._reportView.appendSection("");this._securityOriginElement=s.appendField(ls`Security origin`),this._versionElement=s.appendField(ls`Version`),this._objectStoreCountElement=s.appendField(ls`Object stores`);const a=this._reportView.appendSection("").appendRow();this._clearButton=f.createTextButton(ls`Delete database`,()=>this._deleteDatabase(),ls`Delete database`),a.appendChild(this._clearButton),this._refreshButton=f.createTextButton(ls`Refresh database`,()=>this._refreshDatabaseButtonClicked(),ls`Refresh database`),a.appendChild(this._refreshButton),t&&this.update(t)}_refreshDatabase(){this._securityOriginElement.textContent=this._database.databaseId.securityOrigin,this._versionElement.textContent=this._database.version,this._objectStoreCountElement.textContent=this._database.objectStores.size}_refreshDatabaseButtonClicked(){this._model.refreshDatabase(this._database.databaseId)}update(e){this._database=e,this._reportView.setTitle(this._database.databaseId.name),this._refreshDatabase(),this._updatedForTests()}_updatedForTests(){}async _deleteDatabase(){await f.ConfirmDialog.show(e.UIString('Please confirm delete of "%s" database.',this._database.databaseId.name),this.element)&&this._model.deleteDatabase(this._database.databaseId)}}class pt extends g.SimpleView{constructor(t,i,s,a,r){super(e.UIString("IDB")),this.registerRequiredCSS("resources/indexedDBViews.css"),this._model=t,this._databaseId=i,this._isIndex=!!a,this._refreshObjectStoreCallback=r,this.element.classList.add("indexed-db-data-view","storage-view"),this._refreshButton=new b.ToolbarButton(e.UIString("Refresh"),"largeicon-refresh"),this._refreshButton.addEventListener(b.ToolbarButton.Events.Click,this._refreshButtonClicked,this),this._deleteSelectedButton=new b.ToolbarButton(e.UIString("Delete selected"),"largeicon-delete"),this._deleteSelectedButton.addEventListener(b.ToolbarButton.Events.Click,e=>{this._deleteButtonClicked(null)}),this._clearButton=new b.ToolbarButton(e.UIString("Clear object store"),"largeicon-clear"),this._clearButton.addEventListener(b.ToolbarButton.Events.Click,e=>{this._clearButtonClicked(e)},this),this._needsRefresh=new b.ToolbarItem(f.createIconLabel(e.UIString("Data may be stale"),"smallicon-warning")),this._needsRefresh.setVisible(!1),this._needsRefresh.setTitle(e.UIString("Some entries may have been modified")),this._createEditorToolbar(),this._pageSize=50,this._skipCount=0,this.update(s,a),this._entries=[]}_createDataGrid(){const t=this._isIndex?this._index.keyPath:this._objectStore.keyPath,i=[];i.push({id:"number",title:e.UIString("#"),sortable:!1,width:"50px"}),i.push({id:"key",titleDOMFragment:this._keyColumnHeaderFragment(e.UIString("Key"),t),sortable:!1}),this._isIndex&&i.push({id:"primaryKey",titleDOMFragment:this._keyColumnHeaderFragment(e.UIString("Primary key"),this._objectStore.keyPath),sortable:!1}),i.push({id:"value",title:e.UIString("Value"),sortable:!1});const s=new c.DataGridImpl({displayName:ls`Indexed DB`,columns:i,deleteCallback:this._deleteButtonClicked.bind(this),refreshCallback:this._updateData.bind(this,!0)});return s.setStriped(!0),s.addEventListener(c.Events.SelectedNode,e=>this._updateToolbarEnablement(),this),s}_keyColumnHeaderFragment(t,i){const s=createDocumentFragment();if(f.createTextChild(s,t),null===i)return s;if(f.createTextChild(s," ("+e.UIString("Key path: ")),Array.isArray(i)){f.createTextChild(s,"[");for(let e=0;e<i.length;++e)0!==e&&f.createTextChild(s,", "),s.appendChild(this._keyPathStringFragment(i[e]));f.createTextChild(s,"]")}else{const e=i;s.appendChild(this._keyPathStringFragment(e))}return f.createTextChild(s,")"),s}_keyPathStringFragment(e){const t=createDocumentFragment();f.createTextChild(t,'"');return t.createChild("span","source-code indexed-db-key-path").textContent=e,f.createTextChild(t,'"'),t}_createEditorToolbar(){const t=new b.Toolbar("data-view-toolbar",this.element);t.appendToolbarItem(this._refreshButton),t.appendToolbarItem(new b.ToolbarSeparator),this._pageBackButton=new b.ToolbarButton(e.UIString("Show previous page"),"largeicon-play-back"),this._pageBackButton.addEventListener(b.ToolbarButton.Events.Click,this._pageBackButtonClicked,this),t.appendToolbarItem(this._pageBackButton),this._pageForwardButton=new b.ToolbarButton(e.UIString("Show next page"),"largeicon-play"),this._pageForwardButton.setEnabled(!1),this._pageForwardButton.addEventListener(b.ToolbarButton.Events.Click,this._pageForwardButtonClicked,this),t.appendToolbarItem(this._pageForwardButton),this._keyInput=new b.ToolbarInput(ls`Start from key`,"",.5),this._keyInput.addEventListener(b.ToolbarInput.Event.TextChanged,this._updateData.bind(this,!1)),t.appendToolbarItem(this._keyInput),t.appendToolbarItem(new b.ToolbarSeparator),t.appendToolbarItem(this._clearButton),t.appendToolbarItem(this._deleteSelectedButton),t.appendToolbarItem(this._needsRefresh)}_pageBackButtonClicked(e){this._skipCount=Math.max(0,this._skipCount-this._pageSize),this._updateData(!1)}_pageForwardButtonClicked(e){this._skipCount=this._skipCount+this._pageSize,this._updateData(!1)}_populateContextMenu(e,t){const i=t;i.valueObjectPresentation&&(e.revealSection().appendItem(ls`Expand Recursively`,()=>{i.valueObjectPresentation.objectTreeElement().expandRecursively()}),e.revealSection().appendItem(ls`Collapse`,()=>{i.valueObjectPresentation.objectTreeElement().collapse()}))}refreshData(){this._updateData(!0)}update(e,t){this._objectStore=e,this._index=t,this._dataGrid&&this._dataGrid.asWidget().detach(),this._dataGrid=this._createDataGrid(),this._dataGrid.setRowContextMenuCallback(this._populateContextMenu.bind(this)),this._dataGrid.asWidget().show(this.element),this._skipCount=0,this._updateData(!0)}_parseKey(e){let t;try{t=JSON.parse(e)}catch(i){t=e}return t}_updateData(e){const t=this._parseKey(this._keyInput.value()),i=this._pageSize;let s=this._skipCount,a=this._dataGrid.selectedNode?this._dataGrid.selectedNode.data.number:0;if(a=Math.max(a,this._skipCount),this._refreshButton.setEnabled(!1),this._clearButton.setEnabled(!this._isIndex),!e&&this._lastKey===t&&this._lastPageSize===i&&this._lastSkipCount===s)return;function r(e,t){this._refreshButton.setEnabled(!0),this.clear(),this._entries=e;let i=null;for(let t=0;t<e.length;++t){const r={};r.number=t+s,r.key=e[t].key,r.primaryKey=e[t].primaryKey,r.value=e[t].value;const n=new gt(r);this._dataGrid.rootNode().appendChild(n),r.number<=a&&(i=n)}i&&i.select(),this._pageBackButton.setEnabled(!!s),this._pageForwardButton.setEnabled(t),this._needsRefresh.setVisible(!1),this._updateToolbarEnablement(),this._updatedDataForTests()}this._lastKey===t&&this._lastPageSize===i||(s=0,this._skipCount=0),this._lastKey=t,this._lastPageSize=i,this._lastSkipCount=s;const n=t?window.IDBKeyRange.lowerBound(t):null;this._isIndex?this._model.loadIndexData(this._databaseId,this._objectStore.name,this._index.name,n,s,i,r.bind(this)):this._model.loadObjectStoreData(this._databaseId,this._objectStore.name,n,s,i,r.bind(this)),this._model.getMetadata(this._databaseId,this._objectStore).then(this._updateSummaryBar.bind(this))}_updateSummaryBar(e){if(this._summaryBarElement||(this._summaryBarElement=this.element.createChild("div","object-store-summary-bar")),this._summaryBarElement.removeChildren(),!e)return;const t=this._summaryBarElement.createChild("span");t.textContent=ls`Total entries: ${String(e.entriesCount)}`,this._objectStore.autoIncrement&&(t.textContent+=" ❘ ",t.textContent+=ls`Key generator value: ${String(e.keyGeneratorValue)}`)}_updatedDataForTests(){}_refreshButtonClicked(e){this._updateData(!0)}async _clearButtonClicked(e){this._clearButton.setEnabled(!1),await this._model.clearObjectStore(this._databaseId,this._objectStore.name),this._clearButton.setEnabled(!0),this._updateData(!0)}markNeedsRefresh(){this._needsRefresh.setVisible(!0)}async _deleteButtonClicked(e){if(!e&&!(e=this._dataGrid.selectedNode))return;const t=(this._isIndex?e.data.primaryKey:e.data.key).value;await this._model.deleteEntries(this._databaseId,this._objectStore.name,window.IDBKeyRange.only(t)),this._refreshObjectStoreCallback()}clear(){this._dataGrid.rootNode().removeChildren(),this._entries=[]}_updateToolbarEnablement(){const e=!this._dataGrid||0===this._dataGrid.rootNode().children.length;this._deleteSelectedButton.setEnabled(!e&&null!==this._dataGrid.selectedNode)}}class gt extends c.DataGridNode{constructor(e){super(e,!1),this.selectable=!0,this.valueObjectPresentation=null}createCell(e){const t=super.createCell(e),i=this.data[e];switch(e){case"value":{t.removeChildren();const e=ue.ObjectPropertiesSection.defaultObjectPropertiesSection(i,void 0,!0,!0);t.appendChild(e.element),this.valueObjectPresentation=e;break}case"key":case"primaryKey":{t.removeChildren();const e=ue.ObjectPropertiesSection.defaultObjectPresentation(i,void 0,!0,!0);t.appendChild(e);break}}return t}}var bt=Object.freeze({__proto__:null,IDBDatabaseView:ut,IDBDataView:pt,IDBDataGridNode:gt});class vt extends g.SimpleView{constructor(t,s){super(e.UIString("Cache")),this.registerRequiredCSS("resources/serviceWorkerCacheViews.css"),this._model=t,this._entriesForTest=null,this.element.classList.add("service-worker-cache-data-view"),this.element.classList.add("storage-view");const a=new b.Toolbar("data-view-toolbar",this.element);this._splitWidget=new I.SplitWidget(!1,!1),this._splitWidget.show(this.element),this._previewPanel=new S.VBox;const r=this._previewPanel.element.createChild("div","cache-preview-panel-resizer");this._splitWidget.setMainWidget(this._previewPanel),this._splitWidget.installResizer(r),this._preview=null,this._cache=s,this._dataGrid=null,this._refreshThrottler=new i.Throttler(300),this._refreshButton=new b.ToolbarButton(e.UIString("Refresh"),"largeicon-refresh"),this._refreshButton.addEventListener(b.ToolbarButton.Events.Click,this._refreshButtonClicked,this),a.appendToolbarItem(this._refreshButton),this._deleteSelectedButton=new b.ToolbarButton(e.UIString("Delete Selected"),"largeicon-delete"),this._deleteSelectedButton.addEventListener(b.ToolbarButton.Events.Click,e=>{this._deleteButtonClicked(null)}),a.appendToolbarItem(this._deleteSelectedButton);const n=new b.ToolbarInput(ls`Filter by Path`,"",1);a.appendToolbarItem(n);const o=new i.Throttler(300);this._entryPathFilter="",n.addEventListener(b.ToolbarInput.Event.TextChanged,()=>{o.schedule(()=>(this._entryPathFilter=n.value(),this._updateData(!0)))}),this._returnCount=null,this._summaryBarElement=null,this._loadingPromise=null,this.update(s)}_resetDataGrid(){this._dataGrid&&this._dataGrid.asWidget().detach(),this._dataGrid=this._createDataGrid();const e=this._dataGrid.asWidget();this._splitWidget.setSidebarWidget(e),e.setMinimumSize(0,250)}wasShown(){this._model.addEventListener(z.Events.CacheStorageContentUpdated,this._cacheContentUpdated,this),this._updateData(!0)}willHide(){this._model.removeEventListener(z.Events.CacheStorageContentUpdated,this._cacheContentUpdated,this)}_showPreview(t){t&&this._preview===t||(this._preview&&this._preview.detach(),t||(t=new v.EmptyWidget(e.UIString("Select a cache entry above to preview"))),this._preview=t,this._preview.show(this._previewPanel.element))}_createDataGrid(){const t=[{id:"number",title:"#",sortable:!1,width:"3px"},{id:"name",title:e.UIString("Name"),weight:4,sortable:!0},{id:"responseType",title:ls`Response-Type`,weight:1,align:c.Align.Right,sortable:!0},{id:"contentType",title:e.UIString("Content-Type"),weight:1,sortable:!0},{id:"contentLength",title:e.UIString("Content-Length"),weight:1,align:c.Align.Right,sortable:!0},{id:"responseTime",title:e.UIString("Time Cached"),width:"12em",weight:1,align:c.Align.Right,sortable:!0}],i=new c.DataGridImpl({displayName:ls`Service Worker Cache`,columns:t,deleteCallback:this._deleteButtonClicked.bind(this),refreshCallback:this._updateData.bind(this,!0),editCallback:void 0});return i.addEventListener(c.Events.SortingChanged,this._sortingChanged,this),i.addEventListener(c.Events.SelectedNode,e=>{this._previewCachedResponse(e.data.data)},this),i.setStriped(!0),i}_sortingChanged(){if(!this._dataGrid)return;const e=this._dataGrid,t=e.isSortOrderAscending(),i=e.sortColumnId();let s;"name"===i?s=(e,t)=>e._name.localeCompare(t._name):"contentType"===i?s=(e,t)=>e.data.mimeType.localeCompare(t.data.mimeType):"contentLength"===i?s=(e,t)=>e.data.resourceSize-t.data.resourceSize:"responseTime"===i?s=(e,t)=>e.data.endTime-t.data.endTime:"responseType"===i&&(s=(e,t)=>e._responseType.localeCompare(t._responseType));const a=e.rootNode().children.slice();e.rootNode().removeChildren(),a.sort((e,i)=>{const a=s(e,i);return t?a:-a}),a.forEach(t=>e.rootNode().appendChild(t))}async _deleteButtonClicked(e){(e||(e=this._dataGrid&&this._dataGrid.selectedNode))&&(await this._model.deleteCacheEntry(this._cache,e.data.url()),e.remove())}update(e){this._cache=e,this._resetDataGrid(),this._updateData(!0)}_updateSummaryBar(){this._summaryBarElement||(this._summaryBarElement=this.element.createChild("div","cache-storage-summary-bar")),this._summaryBarElement.removeChildren();const e=this._summaryBarElement.createChild("span");this._entryPathFilter?e.textContent=ls`Matching entries: ${this._returnCount}`:e.textContent=ls`Total entries: ${this._returnCount}`}_updateDataCallback(e,t,i){if(!this._dataGrid)return;const s=this._dataGrid.selectedNode&&this._dataGrid.selectedNode.data.url();this._refreshButton.setEnabled(!0),this._entriesForTest=t,this._returnCount=i,this._updateSummaryBar();const a=new Map,r=this._dataGrid.rootNode();for(const e of r.children)a.set(e.data.url,e);r.removeChildren();let n=null;for(let e=0;e<t.length;++e){const i=t[e];let o=a.get(i.requestURL);o&&o.data.responseTime===i.responseTime?o.data.number=e:(o=new wt(e,this._createRequest(i),i.responseType),o.selectable=!0),r.appendChild(o),i.requestURL===s&&(n=o)}n?n.revealAndSelect():this._showPreview(null),this._updatedForTest()}async _updateData(e){if(!e&&this._loadingPromise)return this._loadingPromise;if(this._refreshButton.setEnabled(!1),this._loadingPromise)return this._loadingPromise;this._loadingPromise=new Promise(e=>{this._model.loadAllCacheData(this._cache,this._entryPathFilter,(t,i)=>{e({entries:t,returnCount:i})})});const{entries:t,returnCount:i}=await this._loadingPromise;this._updateDataCallback(0,t,i),this._loadingPromise=null}_refreshButtonClicked(e){this._updateData(!0)}_cacheContentUpdated(e){const t=e.data;this._cache.securityOrigin===t.origin&&this._cache.cacheName===t.cacheName&&this._refreshThrottler.schedule(()=>Promise.resolve(this._updateData(!0)),!0)}async _previewCachedResponse(e){let t=St.get(e);t||(t=new ft(e),St.set(e,t)),this._dataGrid&&this._dataGrid.selectedNode&&e===this._dataGrid.selectedNode.data&&this._showPreview(t)}_createRequest(e){const t=new Q.NetworkRequest("cache-storage-"+e.requestURL,e.requestURL,"","","",null);t.requestMethod=e.requestMethod,t.setRequestHeaders(e.requestHeaders),t.statusCode=e.responseStatus,t.statusText=e.responseStatusText,t.protocol=new a.ParsedURL(e.requestURL).scheme,t.responseHeaders=e.responseHeaders,t.setRequestHeadersText(""),t.endTime=e.responseTime;let i=e.responseHeaders.find(e=>"content-type"===e.name.toLowerCase());const s=i?i.value:Q.MIME_TYPE.PLAIN;t.mimeType=s,i=e.responseHeaders.find(e=>"content-length"===e.name.toLowerCase()),t.resourceSize=i&&Number(i.value)||0;let r=d.ResourceType.fromMimeType(s);return r||(r=d.ResourceType.fromURL(e.requestURL)||d.resourceTypes.Other),t.setResourceType(r),t.setContentDataProvider(this._requestContent.bind(this,t)),t}async _requestContent(e){const t=e.resourceType().isTextType(),i={error:null,content:null,encoded:!t},s=await this._cache.requestCachedResponse(e.url(),e.requestHeaders());return s&&(i.content=t?window.atob(s.body):s.body),i}_updatedForTest(){}}const St=new WeakMap;vt._previewSymbol=Symbol("preview");class wt extends c.DataGridNode{constructor(e,t,i){super(t),this._number=e;const s=new a.ParsedURL(t.url());s.isValid?this._name=u.trimURL(t.url(),s.domain()):this._name=t.url(),this._request=t,this._responseType=i}createCell(e){const t=this.createTD(e);let i;return"number"===e?i=String(this._number):"name"===e?i=this._name:"responseType"===e?i="opaqueResponse"===this._responseType?"opaque":"opaqueRedirect"===this._responseType?"opaqueredirect":this._responseType:"contentType"===e?i=this._request.mimeType:"contentLength"===e?i=(0|this._request.resourceSize).toLocaleString("en-US"):"responseTime"===e&&(i=new Date(1e3*this._request.endTime).toLocaleString()),c.DataGridImpl.setElementText(t,i||"",!0),t.title=this._request.url(),t}}class ft extends S.VBox{constructor(i){super(),this._tabbedPane=new M.TabbedPane,this._tabbedPane.addEventListener(M.Events.TabSelected,this._tabSelected,this),this._resourceViewTabSetting=t.Settings.instance().createSetting("cacheStorageViewTab","preview"),this._tabbedPane.appendTab("headers",e.UIString("Headers"),new he.RequestHeadersView(i)),this._tabbedPane.appendTab("preview",e.UIString("Preview"),new _e.RequestPreviewView(i)),this._tabbedPane.show(this.element)}wasShown(){super.wasShown(),this._selectTab()}_selectTab(e){e||(e=this._resourceViewTabSetting.get()),e&&!this._tabbedPane.selectTab(e)&&this._tabbedPane.selectTab("headers")}_tabSelected(e){e.data.isUserGesture&&this._resourceViewTabSetting.set(e.data.tabId)}}var yt=Object.freeze({__proto__:null,ServiceWorkerCacheView:vt,DataGridNode:wt,RequestView:ft});class Ct extends S.VBox{constructor(){super(!0),this.registerRequiredCSS("resources/serviceWorkersView.css"),this._currentWorkersView=new w.ReportView(e.UIString("Service Workers")),this._currentWorkersView.setBodyScrollable(!1),this.contentElement.classList.add("service-worker-list"),this._currentWorkersView.show(this.contentElement),this._currentWorkersView.element.classList.add("service-workers-this-origin"),this._toolbar=this._currentWorkersView.createToolbar(),this._toolbar.makeWrappable(!0),this._sections=new Map,this._registrationSymbol=Symbol("Resources.ServiceWorkersView"),this._manager=null,this._securityOriginManager=null;const i=this.contentElement.createChild("div","service-workers-other-origin"),s=new w.ReportView;s.setHeaderVisible(!1),s.show(i);const a=s.appendSection(e.UIString("Service workers from other origins")).appendRow(),r=D.html`<a class="devtools-link" role="link" tabindex="0" href="chrome://serviceworker-internals" target="_blank" style="display: inline; cursor: pointer;">See all registrations</a>`;self.onInvokeElement(r,e=>{P.TargetManager.instance().mainTarget().targetAgent().invoke_createTarget({url:"chrome://serviceworker-internals?devtools"}),e.consume(!0)}),a.appendChild(r),this._toolbar.appendToolbarItem(pe.throttlingManager().createOfflineToolbarCheckbox());const n=t.Settings.instance().createSetting("serviceWorkerUpdateOnReload",!1);n.setTitle(e.UIString("Update on reload"));const o=new b.ToolbarSettingCheckbox(n,ls`On page reload, force the service worker to update, and activate it`);this._toolbar.appendToolbarItem(o);const d=t.Settings.instance().createSetting("bypassServiceWorker",!1);d.setTitle(e.UIString("Bypass for network"));const l=new b.ToolbarSettingCheckbox(d,ls`Bypass the service worker and load resources from the network`);this._toolbar.appendToolbarItem(l),this._eventListeners=new Map,P.TargetManager.instance().observeModels(W.ServiceWorkerManager,this),this._updateListVisibility()}modelAdded(e){if(!this._manager){this._manager=e,this._securityOriginManager=e.target().model(j.SecurityOriginManager);for(const e of this._manager.registrations().values())this._updateRegistration(e);this._eventListeners.set(e,[this._manager.addEventListener(W.Events.RegistrationUpdated,this._registrationUpdated,this),this._manager.addEventListener(W.Events.RegistrationDeleted,this._registrationDeleted,this),this._securityOriginManager.addEventListener(j.Events.SecurityOriginAdded,this._updateSectionVisibility,this),this._securityOriginManager.addEventListener(j.Events.SecurityOriginRemoved,this._updateSectionVisibility,this)])}}modelRemoved(e){this._manager&&this._manager===e&&(s.EventTarget.removeEventListeners(this._eventListeners.get(e)),this._eventListeners.delete(e),this._manager=null,this._securityOriginManager=null)}_getTimeStamp(e){const t=e.versionsByMode();let i=0;const s=t.get(W.ServiceWorkerVersion.Modes.Active),a=t.get(W.ServiceWorkerVersion.Modes.Installing),r=t.get(W.ServiceWorkerVersion.Modes.Waiting),n=t.get(W.ServiceWorkerVersion.Modes.Redundant);return s?i=s.scriptResponseTime:r?i=r.scriptResponseTime:a?i=a.scriptResponseTime:n&&(i=n.scriptResponseTime),i||0}_updateSectionVisibility(){let e=!1;const t=[];for(const i of this._sections.values()){const s=this._getReportViewForOrigin(i._registration.securityOrigin);e|=s===this._currentWorkersView,i._section.parentWidget()!==s&&t.push(i)}for(const e of t){const t=e._registration;this._removeRegistrationFromList(t),this._updateRegistration(t,!0)}this._currentWorkersView.sortSections((e,t)=>{const i=this._getTimeStamp(e[this._registrationSymbol]);return this._getTimeStamp(t[this._registrationSymbol])-i});for(const e of this._sections.values())e._section.parentWidget()===this._currentWorkersView||this._isRegistrationVisible(e._registration)?e._section.showWidget():e._section.hideWidget();this.contentElement.classList.toggle("service-worker-has-current",!!e),this._updateListVisibility()}_registrationUpdated(e){const t=e.data;this._updateRegistration(t),this._gcRegistrations()}_gcRegistrations(){let e=!1;const t=new Set(this._securityOriginManager.securityOrigins());for(const i of this._manager.registrations().values())if((t.has(i.securityOrigin)||this._isRegistrationVisible(i))&&!i.canBeRemoved()){e=!0;break}if(e)for(const e of this._manager.registrations().values()){!(t.has(e.securityOrigin)||this._isRegistrationVisible(e))&&e.canBeRemoved()&&this._removeRegistrationFromList(e)}}_getReportViewForOrigin(e){return this._securityOriginManager.securityOrigins().includes(e)||this._securityOriginManager.unreachableMainSecurityOrigin()===e?this._currentWorkersView:null}_updateRegistration(e,t){let i=this._sections.get(e);if(!i){const t=e.scopeURL,s=this._getReportViewForOrigin(e.securityOrigin);if(!s)return;const a=s.appendSection(t);a.setUiGroupTitle(ls`Service worker for ${t}`),a[this._registrationSymbol]=e,i=new It(this._manager,a,e),this._sections.set(e,i)}t||(this._updateSectionVisibility(),i._scheduleUpdate())}_registrationDeleted(e){const t=e.data;this._removeRegistrationFromList(t)}_removeRegistrationFromList(e){const t=this._sections.get(e);t&&t._section.detach(),this._sections.delete(e),this._updateSectionVisibility()}_isRegistrationVisible(e){return!e.scopeURL}_updateListVisibility(){this.contentElement.classList.toggle("service-worker-list-empty",0===this._sections.size)}}class It{constructor(s,a,r){this._manager=s,this._section=a,this._registration=r,this._fingerprint=null,this._pushNotificationDataSetting=t.Settings.instance().createLocalSetting("pushData",e.UIString("Test push message from DevTools.")),this._syncTagNameSetting=t.Settings.instance().createLocalSetting("syncTagName","test-tag-from-devtools"),this._periodicSyncTagNameSetting=t.Settings.instance().createLocalSetting("periodicSyncTagName","test-tag-from-devtools"),this._toolbar=a.createToolbar(),this._toolbar.renderAsLinks(),this._updateButton=new b.ToolbarButton(e.UIString("Update"),void 0,e.UIString("Update")),this._updateButton.addEventListener(b.ToolbarButton.Events.Click,this._updateButtonClicked,this),this._toolbar.appendToolbarItem(this._updateButton),this._deleteButton=new b.ToolbarButton(e.UIString("Unregister service worker"),void 0,e.UIString("Unregister")),this._deleteButton.addEventListener(b.ToolbarButton.Events.Click,this._unregisterButtonClicked,this),this._toolbar.appendToolbarItem(this._deleteButton),this._sourceField=this._wrapWidget(this._section.appendField(e.UIString("Source"))),this._statusField=this._wrapWidget(this._section.appendField(e.UIString("Status"))),this._clientsField=this._wrapWidget(this._section.appendField(e.UIString("Clients"))),this._createSyncNotificationField(e.UIString("Push"),this._pushNotificationDataSetting.get(),e.UIString("Push data"),this._push.bind(this)),this._createSyncNotificationField(e.UIString("Sync"),this._syncTagNameSetting.get(),e.UIString("Sync tag"),this._sync.bind(this)),this._createSyncNotificationField(ls`Periodic Sync`,this._periodicSyncTagNameSetting.get(),ls`Periodic Sync tag`,e=>this._periodicSync(e)),this._linkifier=new ae.Linkifier,this._clientInfoCache=new Map,this._throttler=new i.Throttler(500)}_createSyncNotificationField(e,t,i,s){const a=this._wrapWidget(this._section.appendField(e)).createChild("form","service-worker-editor-with-button"),r=f.createInput("source-code service-worker-notification-editor");a.appendChild(r);const n=f.createTextButton(e);n.type="submit",a.appendChild(n),r.value=t,r.placeholder=i,x.setAccessibleName(r,e),a.addEventListener("submit",e=>{s(r.value||""),e.consume(!0)})}_scheduleUpdate(){Ct._noThrottle?this._update():this._throttler.schedule(this._update.bind(this))}_targetForVersionId(e){const t=this._manager.findVersion(e);return t&&t.targetId?P.TargetManager.instance().targetById(t.targetId):null}_addVersion(e,t,i){const s=e.createChild("div","service-worker-version");s.createChild("div",t);const a=s.createChild("span","service-worker-version-string");return a.textContent=i,x.markAsAlert(a),s}_updateClientsField(t){this._clientsField.removeChildren(),this._section.setFieldVisible(e.UIString("Clients"),!!t.controlledClients.length);for(const e of t.controlledClients){const t=this._clientsField.createChild("div","service-worker-client");this._clientInfoCache.has(e)&&this._updateClientInfo(t,this._clientInfoCache.get(e)),this._manager.target().targetAgent().getTargetInfo(e).then(this._onClientInfo.bind(this,t))}}_updateSourceField(t){this._sourceField.removeChildren();const i=a.ParsedURL.extractName(t.scriptURL),s=this._sourceField.createChild("div","report-field-value-filename"),r=ae.Linkifier.linkifyURL(t.scriptURL,{text:i});if(r.tabIndex=0,s.appendChild(r),this._registration.errors.length){const e=f.createIconLabel(String(this._registration.errors.length),"smallicon-error");e.classList.add("link"),e.tabIndex=0,x.setAccessibleName(e,ls`${this._registration.errors.length} registration errors`),self.onInvokeElement(e,()=>l.Console.instance().show()),s.appendChild(e)}this._sourceField.createChild("div","report-field-value-subtitle").textContent=e.UIString("Received %s",new Date(1e3*t.scriptResponseTime).toLocaleString())}_update(){const t=this._registration.fingerprint();if(t===this._fingerprint)return Promise.resolve();this._fingerprint=t,this._toolbar.setEnabled(!this._registration.isDeleted);const i=this._registration.versionsByMode(),s=this._registration.scopeURL,a=this._registration.isDeleted?e.UIString("%s - deleted",s):s;this._section.setTitle(a);const r=i.get(W.ServiceWorkerVersion.Modes.Active),n=i.get(W.ServiceWorkerVersion.Modes.Waiting),o=i.get(W.ServiceWorkerVersion.Modes.Installing),d=i.get(W.ServiceWorkerVersion.Modes.Redundant);this._statusField.removeChildren();const l=this._statusField.createChild("div","service-worker-version-stack");if(l.createChild("div","service-worker-version-stack-bar"),r){this._updateSourceField(r);const t=W.ServiceWorkerVersion.RunningStatus[r.runningStatus],i=this._addVersion(l,"service-worker-active-circle",ls`#${r.id} activated and is ${t}`);r.isRunning()||r.isStarting()?(this._createLink(i,e.UIString("stop"),this._stopButtonClicked.bind(this,r.id)),this._targetForVersionId(r.id)||this._createLink(i,e.UIString("inspect"),this._inspectButtonClicked.bind(this,r.id))):r.isStartable()&&this._createLink(i,e.UIString("start"),this._startButtonClicked.bind(this)),this._updateClientsField(r)}else d&&(this._updateSourceField(d),this._addVersion(l,"service-worker-redundant-circle",e.UIString("#%s is redundant",d.id)),this._updateClientsField(d));if(n){const t=this._addVersion(l,"service-worker-waiting-circle",e.UIString("#%s waiting to activate",n.id));this._createLink(t,e.UIString("skipWaiting"),this._skipButtonClicked.bind(this)),t.createChild("div","service-worker-subtitle").textContent=e.UIString("Received %s",new Date(1e3*n.scriptResponseTime).toLocaleString()),this._targetForVersionId(n.id)||!n.isRunning()&&!n.isStarting()||this._createLink(t,e.UIString("inspect"),this._inspectButtonClicked.bind(this,n.id))}if(o){const t=this._addVersion(l,"service-worker-installing-circle",e.UIString("#%s trying to install",o.id));t.createChild("div","service-worker-subtitle").textContent=e.UIString("Received %s",new Date(1e3*o.scriptResponseTime).toLocaleString()),this._targetForVersionId(o.id)||!o.isRunning()&&!o.isStarting()||this._createLink(t,e.UIString("inspect"),this._inspectButtonClicked.bind(this,o.id))}return Promise.resolve()}_createLink(e,t,i,s,a){const r=e.createChild("button",s);return r.classList.add("link","devtools-link"),r.textContent=t,r.tabIndex=0,r.addEventListener("click",i,a),r}_unregisterButtonClicked(e){this._manager.deleteRegistration(this._registration.id)}_updateButtonClicked(e){this._manager.updateRegistration(this._registration.id)}_push(e){this._pushNotificationDataSetting.set(e),this._manager.deliverPushMessage(this._registration.id,e)}_sync(e){this._syncTagNameSetting.set(e),this._manager.dispatchSyncEvent(this._registration.id,e,!0)}_periodicSync(e){this._periodicSyncTagNameSetting.set(e),this._manager.dispatchPeriodicSyncEvent(this._registration.id,e)}_onClientInfo(e,t){t&&(this._clientInfoCache.set(t.targetId,t),this._updateClientInfo(e,t))}_updateClientInfo(e,t){if("page"!==t.type&&"iframe"===t.type){const i=e.createChild("span","service-worker-client-string");return void f.createTextChild(i,ls`Worker: ${t.url}`)}e.removeChildren();const i=e.createChild("span","service-worker-client-string");f.createTextChild(i,t.url),this._createLink(e,ls`focus`,this._activateTarget.bind(this,t.targetId),"service-worker-client-focus-link")}_activateTarget(e){this._manager.target().targetAgent().activateTarget(e)}_startButtonClicked(){this._manager.startWorker(this._registration.scopeURL)}_skipButtonClicked(){this._manager.skipWaiting(this._registration.scopeURL)}_stopButtonClicked(e){this._manager.stopWorker(e)}_inspectButtonClicked(e){this._manager.inspectWorker(e)}_wrapWidget(e){const t=O.createShadowRootWithCoreStyles(e);O.appendStyle(t,"resources/serviceWorkersView.css");const i=createElement("div");return t.appendChild(i),i}}var kt=Object.freeze({__proto__:null,ServiceWorkersView:Ct,Section:It});class Et extends S.VBox{constructor(t){super(),this._panel=t,this._sidebarTree=new F.TreeOutlineInShadow,this._sidebarTree.element.classList.add("resources-sidebar"),this._sidebarTree.registerRequiredCSS("resources/resourcesSidebar.css"),this._sidebarTree.element.classList.add("filter-all"),this._sidebarTree.addEventListener(F.Events.ElementAttached,this._treeElementAdded,this),this.contentElement.appendChild(this._sidebarTree.element),this._applicationTreeElement=this._addSidebarSection(e.UIString("Application"));const i=new Bt(t);this._applicationTreeElement.appendChild(i),this.serviceWorkersTreeElement=new Ft(t),this._applicationTreeElement.appendChild(this.serviceWorkersTreeElement);const s=new Vt(t);this._applicationTreeElement.appendChild(s);const a=this._addSidebarSection(e.UIString("Storage"));this.localStorageListTreeElement=new Lt(t,e.UIString("Local Storage"),"LocalStorage"),this.localStorageListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/localstorage?utm_source=devtools");const r=L.Icon.create("mediumicon-table","resource-tree-item");this.localStorageListTreeElement.setLeadingIcons([r]),a.appendChild(this.localStorageListTreeElement),this.sessionStorageListTreeElement=new Lt(t,e.UIString("Session Storage"),"SessionStorage"),this.sessionStorageListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/sessionstorage?utm_source=devtools");const n=L.Icon.create("mediumicon-table","resource-tree-item");this.sessionStorageListTreeElement.setLeadingIcons([n]),a.appendChild(this.sessionStorageListTreeElement),this.indexedDBListTreeElement=new Ut(t),this.indexedDBListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/indexeddb?utm_source=devtools"),a.appendChild(this.indexedDBListTreeElement),this.databasesListTreeElement=new Lt(t,e.UIString("Web SQL"),"Databases"),this.databasesListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/websql?utm_source=devtools");const o=L.Icon.create("mediumicon-database","resource-tree-item");this.databasesListTreeElement.setLeadingIcons([o]),a.appendChild(this.databasesListTreeElement),this.cookieListTreeElement=new Lt(t,e.UIString("Cookies"),"Cookies"),this.cookieListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/cookies?utm_source=devtools");const d=L.Icon.create("mediumicon-cookie","resource-tree-item");this.cookieListTreeElement.setLeadingIcons([d]),a.appendChild(this.cookieListTreeElement);const l=this._addSidebarSection(e.UIString("Cache"));this.cacheStorageListTreeElement=new Mt(t),l.appendChild(this.cacheStorageListTreeElement),this.applicationCacheListTreeElement=new Lt(t,e.UIString("Application Cache"),"ApplicationCache"),this.applicationCacheListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/applicationcache?utm_source=devtools");const c=L.Icon.create("mediumicon-table","resource-tree-item");if(this.applicationCacheListTreeElement.setLeadingIcons([c]),l.appendChild(this.applicationCacheListTreeElement),Root.Runtime.experiments.isEnabled("backgroundServices")){const e=this._addSidebarSection(ls`Background Services`);this.backgroundFetchTreeElement=new Rt(t,Protocol.BackgroundService.ServiceName.BackgroundFetch),e.appendChild(this.backgroundFetchTreeElement),this.backgroundSyncTreeElement=new Rt(t,Protocol.BackgroundService.ServiceName.BackgroundSync),e.appendChild(this.backgroundSyncTreeElement),Root.Runtime.experiments.isEnabled("backgroundServicesNotifications")&&(this.notificationsTreeElement=new Rt(t,Protocol.BackgroundService.ServiceName.Notifications),e.appendChild(this.notificationsTreeElement)),Root.Runtime.experiments.isEnabled("backgroundServicesPaymentHandler")&&(this.paymentHandlerTreeElement=new Rt(t,Protocol.BackgroundService.ServiceName.PaymentHandler),e.appendChild(this.paymentHandlerTreeElement)),this.periodicBackgroundSyncTreeElement=new Rt(t,Protocol.BackgroundService.ServiceName.PeriodicBackgroundSync),e.appendChild(this.periodicBackgroundSyncTreeElement),Root.Runtime.experiments.isEnabled("backgroundServicesPushMessaging")&&(this.pushMessagingTreeElement=new Rt(t,Protocol.BackgroundService.ServiceName.PushMessaging),e.appendChild(this.pushMessagingTreeElement))}this._resourcesSection=new Kt(t,this._addSidebarSection(e.UIString("Frames"))),this._databaseTableViews=new Map,this._databaseQueryViews=new Map,this._databaseTreeElements=new Map,this._domStorageTreeElements=new Map,this._domains={},this._sidebarTree.contentElement.addEventListener("mousemove",this._onmousemove.bind(this),!1),this._sidebarTree.contentElement.addEventListener("mouseleave",this._onmouseleave.bind(this),!1),P.TargetManager.instance().observeTargets(this),P.TargetManager.instance().addModelListener(A.ResourceTreeModel,A.Events.FrameNavigated,this._frameNavigated,this);this._panel.lastSelectedItemPath().length||i.select()}_addSidebarSection(e){const t=new F.TreeElement(e,!0);return t.listItemElement.classList.add("storage-group-list-item"),t.setCollapsible(!1),t.selectable=!1,this._sidebarTree.appendChild(t),t}targetAdded(e){if(this._target)return;this._target=e,this._databaseModel=e.model(Be),this._databaseModel&&(this._databaseModel.addEventListener(Ve.DatabaseAdded,this._databaseAdded,this),this._databaseModel.addEventListener(Ve.DatabasesRemoved,this._resetWebSQL,this));const t=e.model(A.ResourceTreeModel);t&&(t.cachedResourcesLoaded()&&this._initialize(),t.addEventListener(A.Events.CachedResourcesLoaded,this._initialize,this),t.addEventListener(A.Events.WillLoadCachedResources,this._resetWithFrames,this))}targetRemoved(e){if(e!==this._target)return;delete this._target;const t=e.model(A.ResourceTreeModel);t&&(t.removeEventListener(A.Events.CachedResourcesLoaded,this._initialize,this),t.removeEventListener(A.Events.WillLoadCachedResources,this._resetWithFrames,this)),this._databaseModel&&(this._databaseModel.removeEventListener(Ve.DatabaseAdded,this._databaseAdded,this),this._databaseModel.removeEventListener(Ve.DatabasesRemoved,this._resetWebSQL,this),this._databaseModel=null),this._resetWithFrames()}focus(){this._sidebarTree.focus()}_initialize(){for(const e of A.ResourceTreeModel.frames())this._addCookieDocument(e);this._databaseModel&&this._databaseModel.enable();const e=this._target.model(z.ServiceWorkerCacheModel);e&&e.enable();const t=this._target.model(A.ResourceTreeModel);t&&this._populateApplicationCacheTree(t),P.TargetManager.instance().observeModels(Ae,{modelAdded:e=>this._domStorageModelAdded(e),modelRemoved:e=>this._domStorageModelRemoved(e)}),this.indexedDBListTreeElement._initialize(),P.TargetManager.instance().observeModels(Ge,{modelAdded:e=>e.enable(),modelRemoved:e=>this.indexedDBListTreeElement.removeIndexedDBForModel(e)});const i=this._target.model(z.ServiceWorkerCacheModel);this.cacheStorageListTreeElement._initialize(i);const s=this._target.model(Le);Root.Runtime.experiments.isEnabled("backgroundServices")&&(this.backgroundFetchTreeElement._initialize(s),this.backgroundSyncTreeElement._initialize(s),Root.Runtime.experiments.isEnabled("backgroundServicesNotifications")&&this.notificationsTreeElement._initialize(s),Root.Runtime.experiments.isEnabled("backgroundServicesPaymentHandler")&&this.paymentHandlerTreeElement._initialize(s),this.periodicBackgroundSyncTreeElement._initialize(s),Root.Runtime.experiments.isEnabled("backgroundServicesPushMessaging")&&this.pushMessagingTreeElement._initialize(s))}_domStorageModelAdded(e){e.enable(),e.storages().forEach(this._addDOMStorage.bind(this)),e.addEventListener(We.DOMStorageAdded,this._domStorageAdded,this),e.addEventListener(We.DOMStorageRemoved,this._domStorageRemoved,this)}_domStorageModelRemoved(e){e.storages().forEach(this._removeDOMStorage.bind(this)),e.removeEventListener(We.DOMStorageAdded,this._domStorageAdded,this),e.removeEventListener(We.DOMStorageRemoved,this._domStorageRemoved,this)}_resetWithFrames(){this._resourcesSection.reset(),this._reset()}_resetWebSQL(){for(const e of this._databaseQueryViews.values())e.removeEventListener(it.SchemaUpdated,e=>{this._updateDatabaseTables(e)},this);this._databaseTableViews.clear(),this._databaseQueryViews.clear(),this._databaseTreeElements.clear(),this.databasesListTreeElement.removeChildren(),this.databasesListTreeElement.setExpandable(!1)}_resetAppCache(){for(const e of Object.keys(this._applicationCacheFrameElements))this._applicationCacheFrameManifestRemoved({data:e});this.applicationCacheListTreeElement.setExpandable(!1)}_treeElementAdded(e){const t=this._panel.lastSelectedItemPath();if(!t.length)return;const i=e.data,s=[i];for(let e=i.parent;e&&e.itemURL;e=e.parent)s.push(e);let a=t.length-1,r=s.length-1;for(;a>=0&&r>=0&&t[a]===s[r].itemURL;)s[r].expanded||(a>0&&s[r].expand(),s[r].selected||s[r].select()),a--,r--}_reset(){this._domains={},this._resetWebSQL(),this.cookieListTreeElement.removeChildren()}_frameNavigated(e){const t=e.data;t.isTopFrame()&&this._reset();const i=this._applicationCacheFrameElements[t.id];i&&i.frameNavigated(t),this._addCookieDocument(t)}_databaseAdded(e){const t=e.data,i=new xt(this,t);this._databaseTreeElements.set(t,i),this.databasesListTreeElement.appendChild(i)}_addCookieDocument(e){const t=e.unreachableUrl()||e.url,i=a.ParsedURL.fromString(t);if(!i||"http"!==i.scheme&&"https"!==i.scheme&&"file"!==i.scheme)return;const s=i.securityOrigin();if(!this._domains[s]){this._domains[s]=!0;const t=new jt(this._panel,e,s);this.cookieListTreeElement.appendChild(t)}}_domStorageAdded(e){const t=e.data;this._addDOMStorage(t)}_addDOMStorage(e){console.assert(!this._domStorageTreeElements.get(e));const t=new Wt(this._panel,e);this._domStorageTreeElements.set(e,t),e.isLocalStorage?this.localStorageListTreeElement.appendChild(t):this.sessionStorageListTreeElement.appendChild(t)}_domStorageRemoved(e){const t=e.data;this._removeDOMStorage(t)}_removeDOMStorage(e){const t=this._domStorageTreeElements.get(e);if(!t)return;const i=t.selected,s=t.parent;s.removeChild(t),i&&s.select(),this._domStorageTreeElements.delete(e)}selectDatabase(e){e&&(this._showDatabase(e),this._databaseTreeElements.get(e).select())}async showResource(e,t,i){await this._resourcesSection.revealResource(e,t,i)}_showDatabase(e,t){if(!e)return;let i;if(t){let s=this._databaseTableViews.get(e);s||(s={},this._databaseTableViews.set(e,s)),i=s[t],i||(i=new rt(e,t),s[t]=i)}else i=this._databaseQueryViews.get(e),i||(i=new tt(e),this._databaseQueryViews.set(e,i),i.addEventListener(it.SchemaUpdated,e=>{this._updateDatabaseTables(e)},this));this._innerShowView(i)}_showApplicationCache(e){this._applicationCacheViews[e]||(this._applicationCacheViews[e]=new Ie(this._applicationCacheModel,e)),this._innerShowView(this._applicationCacheViews[e])}showFileSystem(e){this._innerShowView(e)}_innerShowView(e){this._panel.showView(e)}async _updateDatabaseTables(e){const t=e.data;if(!t)return;const i=this._databaseTreeElements.get(t);if(!i)return;i.invalidateChildren();const s=this._databaseTableViews.get(t);if(!s)return;const a={},r=this._panel,n=await t.tableNames(),o=n.length;for(let e=0;e<o;++e)a[n[e]]=!0;for(const e in s)e in a||(r.visibleView===s[e]&&r.showView(null),delete s[e]);await i.updateChildren()}_populateApplicationCacheTree(e){this._applicationCacheModel=this._target.model(Se),this._applicationCacheViews={},this._applicationCacheFrameElements={},this._applicationCacheManifestElements={},this._applicationCacheModel.addEventListener(we.FrameManifestAdded,this._applicationCacheFrameManifestAdded,this),this._applicationCacheModel.addEventListener(we.FrameManifestRemoved,this._applicationCacheFrameManifestRemoved,this),this._applicationCacheModel.addEventListener(we.FrameManifestsReset,this._resetAppCache,this),this._applicationCacheModel.addEventListener(we.FrameManifestStatusUpdated,this._applicationCacheFrameManifestStatusChanged,this),this._applicationCacheModel.addEventListener(we.NetworkStateChanged,this._applicationCacheNetworkStateChanged,this)}_applicationCacheFrameManifestAdded(e){const t=e.data,i=this._applicationCacheModel.frameManifestURL(t);let s=this._applicationCacheManifestElements[i];s||(s=new qt(this._panel,i),this.applicationCacheListTreeElement.appendChild(s),this._applicationCacheManifestElements[i]=s);const a=this._target.model(A.ResourceTreeModel),r=new Gt(this,a.frameForId(t),i);s.appendChild(r),s.expand(),this._applicationCacheFrameElements[t]=r}_applicationCacheFrameManifestRemoved(e){const t=e.data,i=this._applicationCacheFrameElements[t];if(!i)return;const s=i.manifestURL;delete this._applicationCacheFrameElements[t],delete this._applicationCacheViews[t],i.parent.removeChild(i);const a=this._applicationCacheManifestElements[s];a.childCount()||(delete this._applicationCacheManifestElements[s],a.parent.removeChild(a))}_applicationCacheFrameManifestStatusChanged(e){const t=e.data,i=this._applicationCacheModel.frameManifestStatus(t);this._applicationCacheViews[t]&&this._applicationCacheViews[t].updateStatus(i)}_applicationCacheNetworkStateChanged(e){const t=e.data;for(const e in this._applicationCacheViews)this._applicationCacheViews[e].updateNetworkState(t)}showView(e){e&&this.showResource(e.resource)}_onmousemove(e){const t=e.target;if(!t)return;const i=t.enclosingNodeOrSelfWithNodeName("li");if(!i)return;const s=i.treeElement;this._previousHoveredElement!==s&&(this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement),s instanceof $t&&(this._previousHoveredElement=s,s.hovered=!0))}_onmouseleave(e){this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement)}}class Tt extends F.TreeElement{constructor(e,t,i){super(t,i),this._storagePanel=e,x.setAccessibleName(this.listItemElement,t)}onselect(e){if(!e)return!1;const t=[];for(let e=this;e;e=e.parent){const i=e.itemURL;if(!i)break;t.push(i)}return this._storagePanel.setLastSelectedItemPath(t),!1}showView(e){this._storagePanel.showView(e)}}class Lt extends Tt{constructor(e,i,s){super(e,i,!1),this._expandedSetting=t.Settings.instance().createSetting("resources"+s+"Expanded","Frames"===s),this._categoryName=i,this._categoryLink=null}get itemURL(){return"category://"+this._categoryName}setLink(e){this._categoryLink=e}onselect(e){return super.onselect(e),this._storagePanel.showCategoryView(this._categoryName,this._categoryLink),!1}onattach(){super.onattach(),this._expandedSetting.get()&&this.expand()}onexpand(){this._expandedSetting.set(!0)}oncollapse(){this._expandedSetting.set(!1)}}class Rt extends Tt{constructor(e,t){super(e,De.getUIString(t),!1),this._serviceName=t,this._selected=!1,this._view=null,this._model=null;const i=L.Icon.create(this._getIconType(),"resource-tree-item");this.setLeadingIcons([i])}_getIconType(){switch(this._serviceName){case Protocol.BackgroundService.ServiceName.BackgroundFetch:return"mediumicon-fetch";case Protocol.BackgroundService.ServiceName.BackgroundSync:return"mediumicon-sync";case Protocol.BackgroundService.ServiceName.PushMessaging:return"mediumicon-cloud";case Protocol.BackgroundService.ServiceName.Notifications:return"mediumicon-bell";case Protocol.BackgroundService.ServiceName.PaymentHandler:return"mediumicon-payment";case Protocol.BackgroundService.ServiceName.PeriodicBackgroundSync:return"mediumicon-schedule";default:return console.error(`Service ${this._serviceName} does not have a dedicated icon`),"mediumicon-table"}}_initialize(e){this._model=e,this._selected&&!this._view&&this.onselect(!1)}get itemURL(){return"background-service://"+this._serviceName}onselect(e){return super.onselect(e),this._selected=!0,!!this._model&&(this._view||(this._view=new De(this._serviceName,this._model)),this.showView(this._view),B.Context.instance().setFlavor(De,this._view),!1)}}class xt extends Tt{constructor(e,t){super(e._panel,t.name,!0),this._sidebar=e,this._database=t;const i=L.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([i])}get itemURL(){return"database://"+encodeURI(this._database.name)}onselect(e){return super.onselect(e),this._sidebar._showDatabase(this._database),!1}onexpand(){this.updateChildren()}async updateChildren(){this.removeChildren();const e=await this._database.tableNames();for(const t of e)this.appendChild(new Dt(this._sidebar,this._database,t))}}class Dt extends Tt{constructor(e,t,i){super(e._panel,i,!1),this._sidebar=e,this._database=t,this._tableName=i;const s=L.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([s])}get itemURL(){return"database://"+encodeURI(this._database.name)+"/"+encodeURI(this._tableName)}onselect(e){return super.onselect(e),this._sidebar._showDatabase(this._database,this._tableName),!1}}class Mt extends Lt{constructor(t){super(t,e.UIString("Cache Storage"),"CacheStorage");const i=L.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([i]),this._swCacheModel=null}_initialize(e){if(this._swCacheTreeElements=new Set,this._swCacheModel=e,e)for(const t of e.caches())this._addCache(e,t);P.TargetManager.instance().addModelListener(z.ServiceWorkerCacheModel,z.Events.CacheAdded,this._cacheAdded,this),P.TargetManager.instance().addModelListener(z.ServiceWorkerCacheModel,z.Events.CacheRemoved,this._cacheRemoved,this)}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(t){const i=new V.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Refresh Caches"),this._refreshCaches.bind(this)),i.show()}_refreshCaches(){this._swCacheModel&&this._swCacheModel.refreshCacheNames()}_cacheAdded(e){const t=e.data.cache,i=e.data.model;this._addCache(i,t)}_addCache(e,t){const i=new Ot(this._storagePanel,e,t);this._swCacheTreeElements.add(i),this.appendChild(i)}_cacheRemoved(e){const t=e.data.cache,i=e.data.model,s=this._cacheTreeElement(i,t);s&&(this.removeChild(s),this._swCacheTreeElements.delete(s),this.setExpandable(this.childCount()>0))}_cacheTreeElement(e,t){for(const i of this._swCacheTreeElements)if(i._cache.equals(t)&&i._model===e)return i;return null}}class Ot extends Tt{constructor(e,t,i){super(e,i.cacheName+" - "+i.securityOrigin,!1),this._model=t,this._cache=i,this._view=null;const s=L.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([s])}get itemURL(){return"cache://"+this._cache.cacheId}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(t){const i=new V.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Delete"),this._clearCache.bind(this)),i.show()}_clearCache(){this._model.deleteCache(this._cache)}update(e){this._cache=e,this._view&&this._view.update(e)}onselect(e){return super.onselect(e),this._view||(this._view=new vt(this._model,this._cache)),this.showView(this._view),!1}}class Ft extends Tt{constructor(t){super(t,e.UIString("Service Workers"),!1);const i=L.Icon.create("mediumicon-service-worker","resource-tree-item");this.setLeadingIcons([i])}get itemURL(){return"service-workers://"}onselect(e){return super.onselect(e),this._view||(this._view=new Ct),this.showView(this._view),!1}}class Bt extends Tt{constructor(t){super(t,e.UIString("Manifest"),!1);const i=L.Icon.create("mediumicon-manifest","resource-tree-item");this.setLeadingIcons([i])}get itemURL(){return"manifest://"}onselect(e){return super.onselect(e),this._view||(this._view=new Ee),this.showView(this._view),!1}}class Vt extends Tt{constructor(t){super(t,e.UIString("Clear storage"),!1);const i=L.Icon.create("mediumicon-clear-storage","resource-tree-item");this.setLeadingIcons([i])}get itemURL(){return"clear-storage://"}onselect(e){return super.onselect(e),this._view||(this._view=new Ye),this.showView(this._view),!1}}class Ut extends Lt{constructor(t){super(t,e.UIString("IndexedDB"),"IndexedDB");const i=L.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([i])}_initialize(){P.TargetManager.instance().addModelListener(Ge,ze.DatabaseAdded,this._indexedDBAdded,this),P.TargetManager.instance().addModelListener(Ge,ze.DatabaseRemoved,this._indexedDBRemoved,this),P.TargetManager.instance().addModelListener(Ge,ze.DatabaseLoaded,this._indexedDBLoaded,this),P.TargetManager.instance().addModelListener(Ge,ze.IndexedDBContentUpdated,this._indexedDBContentUpdated,this),this._idbDatabaseTreeElements=[];for(const e of P.TargetManager.instance().models(Ge)){const t=e.databases();for(let i=0;i<t.length;++i)this._addIndexedDB(e,t[i])}}removeIndexedDBForModel(e){const t=this._idbDatabaseTreeElements.filter(t=>t._model===e);for(const e of t)this._removeIDBDatabaseTreeElement(e)}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(t){const i=new V.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Refresh IndexedDB"),this.refreshIndexedDB.bind(this)),i.show()}refreshIndexedDB(){for(const e of P.TargetManager.instance().models(Ge))e.refreshDatabaseNames()}_indexedDBAdded(e){const t=e.data.databaseId,i=e.data.model;this._addIndexedDB(i,t)}_addIndexedDB(e,t){const i=new Nt(this._storagePanel,e,t);this._idbDatabaseTreeElements.push(i),this.appendChild(i),e.refreshDatabase(t)}_indexedDBRemoved(e){const t=e.data.databaseId,i=e.data.model,s=this._idbDatabaseTreeElement(i,t);s&&this._removeIDBDatabaseTreeElement(s)}_removeIDBDatabaseTreeElement(e){e.clear(),this.removeChild(e),p.removeElement(this._idbDatabaseTreeElements,e),this.setExpandable(this.childCount()>0)}_indexedDBLoaded(e){const t=e.data.database,i=e.data.model,s=e.data.entriesUpdated,a=this._idbDatabaseTreeElement(i,t.databaseId);a&&(a.update(t,s),this._indexedDBLoadedForTest())}_indexedDBLoadedForTest(){}_indexedDBContentUpdated(e){const t=e.data.databaseId,i=e.data.objectStoreName,s=e.data.model,a=this._idbDatabaseTreeElement(s,t);a&&a.indexedDBContentUpdated(i)}_idbDatabaseTreeElement(e,t){return this._idbDatabaseTreeElements.find(i=>i._databaseId.equals(t)&&i._model===e)||null}}class Nt extends Tt{constructor(e,t,i){super(e,i.name+" - "+i.securityOrigin,!1),this._model=t,this._databaseId=i,this._idbObjectStoreTreeElements={};const s=L.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([s]),this._model.addEventListener(ze.DatabaseNamesRefreshed,this._refreshIndexedDB,this)}get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(t){const i=new V.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Refresh IndexedDB"),this._refreshIndexedDB.bind(this)),i.show()}_refreshIndexedDB(){this._model.refreshDatabase(this._databaseId)}indexedDBContentUpdated(e){this._idbObjectStoreTreeElements[e]&&this._idbObjectStoreTreeElements[e].markNeedsRefresh()}update(e,t){this._database=e;const i={};for(const e of[...this._database.objectStores.keys()].sort()){const s=this._database.objectStores.get(e);if(i[s.name]=!0,!this._idbObjectStoreTreeElements[s.name]){const e=new Pt(this._storagePanel,this._model,this._databaseId,s);this._idbObjectStoreTreeElements[s.name]=e,this.appendChild(e)}this._idbObjectStoreTreeElements[s.name].update(s,t)}for(const e in this._idbObjectStoreTreeElements)i[e]||this._objectStoreRemoved(e);this._view&&this._view.update(e),this._updateTooltip()}_updateTooltip(){0===Object.keys(this._idbObjectStoreTreeElements).length?this.tooltip=ls`Version: ${this._database.version} (empty)`:this.tooltip=ls`Version: ${this._database.version}`}onselect(e){return super.onselect(e),this._view||(this._view=new ut(this._model,this._database)),this.showView(this._view),!1}_objectStoreRemoved(e){const t=this._idbObjectStoreTreeElements[e];t.clear(),this.removeChild(t),delete this._idbObjectStoreTreeElements[e],this._updateTooltip()}clear(){for(const e in this._idbObjectStoreTreeElements)this._objectStoreRemoved(e)}}class Pt extends Tt{constructor(e,t,i,s){super(e,s.name,!1),this._model=t,this._databaseId=i,this._idbIndexTreeElements={},this._objectStore=s,this._view=null;const a=L.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([a])}get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name+"/"+this._objectStore.name}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}markNeedsRefresh(){this._view&&this._view.markNeedsRefresh();for(const e in this._idbIndexTreeElements)this._idbIndexTreeElements[e].markNeedsRefresh()}_handleContextMenuEvent(t){const i=new V.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Clear"),this._clearObjectStore.bind(this)),i.show()}_refreshObjectStore(){this._view&&this._view.refreshData();for(const e in this._idbIndexTreeElements)this._idbIndexTreeElements[e].refreshIndex()}async _clearObjectStore(){await this._model.clearObjectStore(this._databaseId,this._objectStore.name),this.update(this._objectStore,!0)}update(e,t){this._objectStore=e;const i={};for(const e of this._objectStore.indexes.values()){if(i[e.name]=!0,!this._idbIndexTreeElements[e.name]){const t=new At(this._storagePanel,this._model,this._databaseId,this._objectStore,e,this._refreshObjectStore.bind(this));this._idbIndexTreeElements[e.name]=t,this.appendChild(t)}this._idbIndexTreeElements[e.name].update(this._objectStore,e,t)}for(const e in this._idbIndexTreeElements)i[e]||this._indexRemoved(e);for(const e in this._idbIndexTreeElements)i[e]||(this.removeChild(this._idbIndexTreeElements[e]),delete this._idbIndexTreeElements[e]);this.childCount()&&this.expand(),this._view&&t&&this._view.update(this._objectStore,null),this._updateTooltip()}_updateTooltip(){const t=this._objectStore.keyPathString;let i=null!==t?ls`Key path: ${t}`:"";this._objectStore.autoIncrement&&(i+="\n"+e.UIString("autoIncrement")),this.tooltip=i}onselect(e){return super.onselect(e),this._view||(this._view=new pt(this._model,this._databaseId,this._objectStore,null,this._refreshObjectStore.bind(this))),this.showView(this._view),!1}_indexRemoved(e){const t=this._idbIndexTreeElements[e];t.clear(),this.removeChild(t),delete this._idbIndexTreeElements[e]}clear(){for(const e in this._idbIndexTreeElements)this._indexRemoved(e);this._view&&this._view.clear()}}class At extends Tt{constructor(e,t,i,s,a,r){super(e,a.name,!1),this._model=t,this._databaseId=i,this._objectStore=s,this._index=a,this._refreshObjectStore=r}get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name+"/"+this._objectStore.name+"/"+this._index.name}markNeedsRefresh(){this._view&&this._view.markNeedsRefresh()}refreshIndex(){this._view&&this._view.refreshData()}update(e,t,i){this._objectStore=e,this._index=t,this._view&&i&&this._view.update(this._objectStore,this._index),this._updateTooltip()}_updateTooltip(){const t=[],i=this._index.keyPathString;t.push(ls`Key path: ${i}`),this._index.unique&&t.push(e.UIString("unique")),this._index.multiEntry&&t.push(e.UIString("multiEntry")),this.tooltip=t.join("\n")}onselect(e){return super.onselect(e),this._view||(this._view=new pt(this._model,this._databaseId,this._objectStore,this._index,this._refreshObjectStore)),this.showView(this._view),!1}clear(){this._view&&this._view.clear()}}class Wt extends Tt{constructor(t,i){super(t,i.securityOrigin?i.securityOrigin:e.UIString("Local Files"),!1),this._domStorage=i;const s=L.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([s])}get itemURL(){return"storage://"+this._domStorage.securityOrigin+"/"+(this._domStorage.isLocalStorage?"local":"session")}onselect(e){return super.onselect(e),this._storagePanel.showDOMStorage(this._domStorage),!1}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(t){const i=new V.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Clear"),()=>this._domStorage.clear()),i.show()}}class jt extends Tt{constructor(t,i,s){super(t,s||e.UIString("Local Files"),!1),this._target=i.resourceTreeModel().target(),this._cookieDomain=s,this.tooltip=ls`Cookies used by frames from ${s}`;const a=L.Icon.create("mediumicon-cookie","resource-tree-item");this.setLeadingIcons([a])}get itemURL(){return"cookies://"+this._cookieDomain}cookieDomain(){return this._cookieDomain}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(t){const i=new V.ContextMenu(t);i.defaultSection().appendItem(e.UIString("Clear"),()=>this._storagePanel.clearCookies(this._target,this._cookieDomain)),i.show()}onselect(e){return super.onselect(e),this._storagePanel.showCookies(this._target,this._cookieDomain),!1}}class qt extends Tt{constructor(e,t){super(e,new a.ParsedURL(t).displayName,!1),this.tooltip=t,this._manifestURL=t}get itemURL(){return"appcache://"+this._manifestURL}get manifestURL(){return this._manifestURL}onselect(e){return super.onselect(e),this._storagePanel.showCategoryView(this._manifestURL,null),!1}}class Gt extends Tt{constructor(e,t,i){super(e._panel,"",!1),this._sidebar=e,this._frameId=t.id,this._manifestURL=i,this._refreshTitles(t);const s=L.Icon.create("mediumicon-frame-top","navigator-folder-tree-item");this.setLeadingIcons([s])}get itemURL(){return"appcache://"+this._manifestURL+"/"+encodeURI(this.titleAsText())}get frameId(){return this._frameId}get manifestURL(){return this._manifestURL}_refreshTitles(e){this.title=e.displayName()}frameNavigated(e){this._refreshTitles(e)}onselect(e){return super.onselect(e),this._sidebar._showApplicationCache(this._frameId),!1}}class zt extends S.VBox{constructor(){super(),this.element.classList.add("storage-view"),this._emptyWidget=new v.EmptyWidget(""),this._linkElement=null,this._emptyWidget.show(this.element)}setText(e){this._emptyWidget.text=e}setLink(e){e&&!this._linkElement&&(this._linkElement=this._emptyWidget.appendLink(e)),!e&&this._linkElement&&this._linkElement.classList.add("hidden"),e&&this._linkElement&&(this._linkElement.setAttribute("href",e),this._linkElement.classList.remove("hidden"))}}class Kt{constructor(e,t){this._panel=e,this._treeElement=t,this._treeElementForFrameId=new Map,this._treeElementForTargetId=new Map;const i=$.FrameManager.instance();i.addEventListener($.Events.FrameAddedToTarget,e=>this._frameAdded(e.data.frame),this),i.addEventListener($.Events.FrameRemoved,e=>this._frameDetached(e.data.frameId),this),i.addEventListener($.Events.FrameNavigated,e=>this._frameNavigated(e.data.frame),this),i.addEventListener($.Events.ResourceAdded,e=>this._resourceAdded(e.data.resource),this),P.TargetManager.instance().addModelListener(X.ChildTargetManager,X.Events.TargetCreated,this._windowOpened,this),P.TargetManager.instance().addModelListener(X.ChildTargetManager,X.Events.TargetInfoChanged,this._windowChanged,this),P.TargetManager.instance().addModelListener(X.ChildTargetManager,X.Events.TargetDestroyed,this._windowDestroyed,this),P.TargetManager.instance().observeTargets(this);for(const e of i.getAllFrames()){this._treeElementForFrameId.get(e.id)||this._addFrameAndParents(e);const t=e.resourceTreeModel().target().model(X.ChildTargetManager);for(const e of t.targetInfos())this._windowOpened({data:{targetInfo:e}})}}targetAdded(e){"worker"===e.type()&&this._workerAdded(e)}async _workerAdded(e){const t=e.parentTarget().id(),i=this._treeElementForTargetId.get(t),s=(await e.parentTarget().targetAgent().invoke_getTargetInfo({targetId:e.id()})).targetInfo;i&&s&&i.workerCreated(s)}targetRemoved(e){}_addFrameAndParents(e){const t=e.parentFrame();t&&!this._treeElementForFrameId.get(t.id)&&this._addFrameAndParents(t),this._frameAdded(e)}_expandFrame(e){if(!e)return!1;let t=this._treeElementForFrameId.get(e.id);return!(!t&&!this._expandFrame(e.parentFrame()))&&(t=this._treeElementForFrameId.get(e.id),!!t&&(t.expand(),!0))}async revealResource(e,t,i){if(!this._expandFrame(e.frame()))return;const s=Ht.forResource(e);s&&await s.revealResource(t,i)}_frameAdded(e){const t=e.parentFrame(),i=t?this._treeElementForFrameId.get(t.id):this._treeElement;if(!i)return;const s=this._treeElementForFrameId.get(e.id);s&&(this._treeElementForFrameId.delete(e.id),s.parent&&s.parent.removeChild(s));const a=new $t(this,e);this._treeElementForFrameId.set(e.id,a);const r=e.resourceTreeModel().target().id();this._treeElementForTargetId.get(r)||this._treeElementForTargetId.set(r,a),i.appendChild(a);for(const t of e.resources())this._resourceAdded(t)}_frameDetached(e){const t=this._treeElementForFrameId.get(e);t&&(this._treeElementForFrameId.delete(e),t.parent&&t.parent.removeChild(t))}_frameNavigated(e){const t=this._treeElementForFrameId.get(e.id);t&&t.frameNavigated(e)}_resourceAdded(e){const t=this._treeElementForFrameId.get(e.frameId);t&&t.appendResource(e)}_windowOpened(e){const t=e.data;if(t.openerId&&"page"===t.type){const e=this._treeElementForFrameId.get(t.openerId);e&&(this._treeElementForTargetId.set(t.targetId,e),e.windowOpened(t))}}_windowDestroyed(e){const t=e.data,i=this._treeElementForTargetId.get(t);i&&(i.windowDestroyed(t),this._treeElementForTargetId.delete(t))}_windowChanged(e){const t=e.data;if(t.openerId&&"page"===t.type){const e=this._treeElementForFrameId.get(t.openerId);e&&e.windowChanged(t)}}reset(){this._treeElement.removeChildren(),this._treeElementForFrameId.clear(),this._treeElementForTargetId.clear()}}class $t extends Tt{constructor(e,t){super(e._panel,"",!1),this._section=e,this._frame=t,this._frameId=t.id,this._categoryElements=new Map,this._treeElementForResource=new Map,this._treeElementForWindow=new Map,this.setExpandable(!0),this.frameNavigated(t),this._view=null}getIconTypeForFrame(e){return e.isTopFrame()?e.unreachableUrl()?"mediumicon-frame-blocked":"mediumicon-frame":e.unreachableUrl()?"mediumicon-frame-embedded-blocked":"mediumicon-frame-embedded"}frameNavigated(e){const t=L.Icon.create(this.getIconTypeForFrame(e));if(e.unreachableUrl()&&t.classList.add("red-icon"),this.setLeadingIcons([t]),this.invalidateChildren(),this._frameId=e.id,this.title!==e.displayName()&&(this.title=e.displayName(),x.setAccessibleName(this.listItemElement,this.title),this.parent)){const e=this.parent;e.removeChild(this),e.appendChild(this)}this._categoryElements.clear(),this._treeElementForResource.clear(),this.selected?(this._view=new dt(this._frame),this.showView(this._view)):this._view=null}get itemURL(){return"frame://"+encodeURI(this._frame.url)}onselect(e){return super.onselect(e),this._view?this._view.update():this._view=new dt(this._frame),this.showView(this._view),this.listItemElement.classList.remove("hovered"),H.OverlayModel.hideDOMNodeHighlight(),!1}set hovered(e){e?(this.listItemElement.classList.add("hovered"),this._frame.highlight()):(this.listItemElement.classList.remove("hovered"),H.OverlayModel.hideDOMNodeHighlight())}appendResource(e){const t=e.statusCode;if(t>=301&&t<=303)return;const i=e.resourceType(),s=i.name();let a=i===d.resourceTypes.Document?this:this._categoryElements.get(s);a||(a=new Lt(this._section._panel,e.resourceType().category().title,s),this._categoryElements.set(i.name(),a),this.appendChild(a,$t._presentationOrderCompare));const r=new Ht(this._section._panel,e);a.appendChild(r,$t._presentationOrderCompare),this._treeElementForResource.set(e.url,r),this._view&&this._view.update()}windowOpened(e){let t=this._categoryElements.get("OpenedWindows");if(t||(t=new Lt(this._section._panel,ls`Opened Windows`,"OpenedWindows"),this._categoryElements.set("OpenedWindows",t),this.appendChild(t,$t._presentationOrderCompare)),!this._treeElementForWindow.get(e.targetId)){const i=new Qt(this._section._panel,e);t.appendChild(i),this._treeElementForWindow.set(e.targetId,i)}}workerCreated(e){let t=this._categoryElements.get("Workers");if(t||(t=new Lt(this._section._panel,ls`Workers`,"Workers"),this._categoryElements.set("Workers",t),this.appendChild(t,$t._presentationOrderCompare)),!this._treeElementForWindow.get(e.targetId)){const i=new Xt(this._section._panel,e);t.appendChild(i),this._treeElementForWindow.set(e.targetId,i)}}windowChanged(e){const t=this._treeElementForWindow.get(e.targetId);t&&(t.title!==e.title&&(t.title=e.title),t.update(e))}windowDestroyed(e){const t=this._treeElementForWindow.get(e);t&&t.windowClosed()}resourceByURL(e){const t=this._treeElementForResource.get(e);return t?t._resource:null}appendChild(e){super.appendChild(e,$t._presentationOrderCompare)}static _presentationOrderCompare(e,t){function i(e){return e instanceof Lt?2:e instanceof $t?1:3}return i(e)-i(t)||e.titleAsText().localeCompare(t.titleAsText())}}class Ht extends Tt{constructor(e,t){super(e,t.displayName,!1),this._panel=e,this._resource=t,this._previewPromise=null,this.tooltip=t.url,this._resource[Ht._symbol]=this;const i=L.Icon.create("mediumicon-manifest","navigator-file-tree-item");i.classList.add("navigator-"+t.resourceType().name()+"-tree-item"),this.setLeadingIcons([i])}static forResource(e){return e[Ht._symbol]}get itemURL(){return this._resource.url}_preparePreview(){if(this._previewPromise)return this._previewPromise;const e=ee.PreviewFactory.createPreview(this._resource,this._resource.mimeType);return this._previewPromise=e.then(e=>e||new v.EmptyWidget(this._resource.url)),this._previewPromise}onselect(e){return super.onselect(e),this._panel.scheduleShowView(this._preparePreview()),!1}ondblclick(e){return Z.InspectorFrontendHostInstance.openInNewTab(this._resource.url),!1}onattach(){super.onattach(),this.listItemElement.draggable=!0,this.listItemElement.addEventListener("dragstart",this._ondragstart.bind(this),!1),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_ondragstart(e){return e.dataTransfer.setData("text/plain",this._resource.content||""),e.dataTransfer.effectAllowed="copy",!0}_handleContextMenuEvent(e){const t=new V.ContextMenu(e);t.appendApplicableItems(this._resource),t.show()}async revealResource(e,t){this.revealAndSelect(!0);const i=await this._panel.scheduleShowView(this._preparePreview());i instanceof te.ResourceSourceFrame&&"number"==typeof e&&i.revealPosition(e,t,!0)}}class Qt extends Tt{constructor(e,t){super(e,t.title||ls`Window without title`,!1),this._targetInfo=t,this._isWindowClosed=!1,this._view=null,this.updateIcon(t.canAccessOpener)}updateIcon(e){const t=e?"mediumicon-frame-opened":"mediumicon-frame",i=L.Icon.create(t);this.setLeadingIcons([i])}update(e){e.canAccessOpener!==this._targetInfo.canAccessOpener&&this.updateIcon(e.canAccessOpener),this._targetInfo=e,this._view&&(this._view.setTargetInfo(e),this._view.update())}windowClosed(){this.listItemElement.classList.add("window-closed"),this._isWindowClosed=!0,this._view&&(this._view.setIsWindowClosed(!0),this._view.update())}onselect(e){return super.onselect(e),this._view?this._view.update():this._view=new ht(this._targetInfo,this._isWindowClosed),this.showView(this._view),!1}}class Xt extends Tt{constructor(e,t){super(e,t.title||t.url||ls`worker`,!1),this._targetInfo=t,this._view=null;const i=L.Icon.create("mediumicon-service-worker","navigator-file-tree-item");this.setLeadingIcons([i])}onselect(e){return super.onselect(e),this._view?this._view.update():this._view=new _t(this._targetInfo),this.showView(this._view),!1}}Ht._symbol=Symbol("treeElement");var Jt=Object.freeze({__proto__:null,ApplicationPanelSidebar:Et,BaseStorageTreeElement:Tt,StorageCategoryTreeElement:Lt,BackgroundServiceTreeElement:Rt,DatabaseTreeElement:xt,DatabaseTableTreeElement:Dt,ServiceWorkerCacheTreeElement:Mt,SWCacheTreeElement:Ot,ServiceWorkersTreeElement:Ft,AppManifestTreeElement:Bt,ClearStorageTreeElement:Vt,IndexedDBTreeElement:Ut,IDBDatabaseTreeElement:Nt,IDBObjectStoreTreeElement:Pt,IDBIndexTreeElement:At,DOMStorageTreeElement:Wt,CookieTreeElement:jt,ApplicationCacheManifestTreeElement:qt,ApplicationCacheFrameTreeElement:Gt,StorageCategoryView:zt,ResourcesSection:Kt,FrameTreeElement:$t,FrameResourceTreeElement:Ht});class Yt extends S.VBox{constructor(t,i){super(!1),this._filterRegex=null,this._refreshButton=this._addButton(e.UIString("Refresh"),"largeicon-refresh",this.refreshItems),this._mainToolbar=new b.Toolbar("top-resources-toolbar",this.element),this._filterItem=new b.ToolbarInput(e.UIString("Filter"),"",.4),this._filterItem.addEventListener(b.ToolbarInput.Event.TextChanged,this._filterChanged,this);const s=new b.ToolbarSeparator;this._deleteAllButton=this._addButton(e.UIString("Clear All"),"largeicon-clear",this.deleteAllItems),this._deleteSelectedButton=this._addButton(e.UIString("Delete Selected"),"largeicon-delete",this.deleteSelectedItem);const a=[this._refreshButton,this._filterItem,s,this._deleteAllButton,this._deleteSelectedButton];for(const e of a)this._mainToolbar.appendToolbarItem(e)}appendToolbarItem(e){this._mainToolbar.appendToolbarItem(e)}_addButton(e,t,i){const s=new b.ToolbarButton(e,t);return s.addEventListener(b.ToolbarButton.Events.Click,i,this),s}_filterChanged(e){const t=e.data;this._filterRegex=t?new RegExp(t.escapeForRegExp(),"i"):null,this.refreshItems()}filter(e,t){if(this._filterRegex){const i=this._filterRegex;return e.filter(e=>i.test(t(e)))}return e}wasShown(){this.refreshItems()}setCanDeleteAll(e){this._deleteAllButton.setEnabled(e)}setCanDeleteSelected(e){this._deleteSelectedButton.setEnabled(e)}setCanRefresh(e){this._refreshButton.setEnabled(e)}setCanFilter(e){this._filterItem.setEnabled(e)}deleteAllItems(){}deleteSelectedItem(){}refreshItems(){}}var Zt=Object.freeze({__proto__:null,StorageItemsView:Yt});class ei extends Yt{constructor(t,s){super(e.UIString("Cookies"),"cookiesPanel"),this.registerRequiredCSS("resources/cookieItemsView.css"),this.element.classList.add("storage-view"),this._model=t,this._cookieDomain=s,this._totalSize=0,this._cookiesTable=new be.CookiesTable(!1,this._saveCookie.bind(this),this.refreshItems.bind(this),this._handleCookieSelected.bind(this),this._deleteCookie.bind(this)),this._cookiesTable.setMinimumSize(0,50),this._splitWidget=new I.SplitWidget(!1,!0,"cookieItemsSplitViewState"),this._splitWidget.show(this.element),this._previewPanel=new S.VBox;const a=this._previewPanel.element.createChild("div","preview-panel-resizer");this._splitWidget.setMainWidget(this._cookiesTable),this._splitWidget.setSidebarWidget(this._previewPanel),this._splitWidget.installResizer(a),this._onlyIssuesFilterUI=new b.ToolbarCheckbox(ls`Only show cookies with an issue`,ls`Only show cookies which have an associated issue`,()=>{this._updateWithCookies(this._allCookies)}),this.appendToolbarItem(this._onlyIssuesFilterUI),this._refreshThrottler=new i.Throttler(300),this._eventDescriptors=[],this._preview=null,this._previewValue=null,this._allCookies=[],this.setCookiesDomain(t,s)}setCookiesDomain(e,t){this._model=e,this._cookieDomain=t,this.refreshItems(),s.EventTarget.removeEventListeners(this._eventDescriptors);const i=e.target().model(K.NetworkManager);this._eventDescriptors=[i.addEventListener(K.Events.ResponseReceived,this._onResponseReceived,this),i.addEventListener(K.Events.LoadingFinished,this._onLoadingFinished,this)],this._showPreview(null,null)}_showPreview(e,t){this._preview&&this._previewValue===t||(this._preview&&this._preview.detach(),e||(e=new v.EmptyWidget(ls`Select a cookie to preview its value`)).element.classList.add("cookie-value"),this._previewValue=t,this._preview=e,e.show(this._previewPanel.contentElement))}_handleCookieSelected(){const e=this._cookiesTable.selectedCookie();if(this.setCanDeleteSelected(!!e),!e)return void this._showPreview(null,null);const t=document.createElement("div");t.classList.add("cookie-value"),t.textContent=e.value(),t.addEventListener("dblclick",(function(){const e=document.createRange();e.selectNode(t),window.getSelection().removeAllRanges(),window.getSelection().addRange(e)}));const i=new S.VBox;i.contentElement.appendChild(t),this._showPreview(i,e)}async _saveCookie(e,t){return t&&e.key()!==t.key()&&await this._model.deleteCookie(t),this._model.saveCookie(e)}_deleteCookie(e,t){this._model.deleteCookie(e).then(t)}_updateWithCookies(e){this._allCookies=e,this._totalSize=e.reduce((e,t)=>e+t.size(),0);const t=a.ParsedURL.fromString(this._cookieDomain),i=t?t.host:"";this._cookiesTable.setCookieDomain(i);const s=this.filter(e,e=>`${e.name()} ${e.value()} ${e.domain()}`);this._cookiesTable.setCookies(s,this._model.getCookieToBlockedReasonsMap()),x.alert(ls`Number of cookies shown in table: ${s.length}`,this.element),this.setCanFilter(!0),this.setCanDeleteAll(!0),this.setCanDeleteSelected(!!this._cookiesTable.selectedCookie())}filter(e,t){return super.filter(e,t).filter(e=>!this._onlyIssuesFilterUI.checked()||e instanceof J.Cookie&&ge.hasIssues(e))}deleteAllItems(){this._showPreview(null,null),this._model.clear(this._cookieDomain).then(()=>this.refreshItems())}deleteSelectedItem(){const e=this._cookiesTable.selectedCookie();e&&(this._showPreview(null,null),this._model.deleteCookie(e).then(()=>this.refreshItems()))}refreshItems(){this._model.getCookiesForDomain(this._cookieDomain).then(this._updateWithCookies.bind(this))}refreshItemsThrottled(){this._refreshThrottler.schedule(()=>Promise.resolve(this.refreshItems()))}_onResponseReceived(){this.refreshItemsThrottled()}_onLoadingFinished(){this.refreshItemsThrottled()}}var ti=Object.freeze({__proto__:null,CookieItemsView:ei});class ii extends Yt{constructor(t){super(e.UIString("DOM Storage"),"domStoragePanel"),this._domStorage=t,this.element.classList.add("storage-view","table");const i=[{id:"key",title:e.UIString("Key"),sortable:!1,editable:!0,longText:!0,weight:50},{id:"value",title:e.UIString("Value"),sortable:!1,editable:!0,longText:!0,weight:50}];this._dataGrid=new c.DataGridImpl({displayName:ls`DOM Storage Items`,columns:i,editCallback:this._editingCallback.bind(this),deleteCallback:this._deleteCallback.bind(this),refreshCallback:this.refreshItems.bind(this)}),this._dataGrid.addEventListener(c.Events.SelectedNode,e=>{this._previewEntry(e.data)}),this._dataGrid.addEventListener(c.Events.DeselectedNode,e=>{this._previewEntry(null)}),this._dataGrid.setStriped(!0),this._dataGrid.setName("DOMStorageItemsView"),this._splitWidget=new I.SplitWidget(!1,!0,"domStorageSplitViewState"),this._splitWidget.show(this.element),this._previewPanel=new S.VBox,this._previewPanel.setMinimumSize(0,50);const s=this._previewPanel.element.createChild("div","preview-panel-resizer"),a=this._dataGrid.asWidget();a.setMinimumSize(0,50),this._splitWidget.setMainWidget(a),this._splitWidget.setSidebarWidget(this._previewPanel),this._splitWidget.installResizer(s),this._preview=null,this._previewValue=null,this._showPreview(null,null),this._eventListeners=[],this.setStorage(t)}setStorage(e){s.EventTarget.removeEventListeners(this._eventListeners),this._domStorage=e,this._eventListeners=[this._domStorage.addEventListener(Pe.Events.DOMStorageItemsCleared,this._domStorageItemsCleared,this),this._domStorage.addEventListener(Pe.Events.DOMStorageItemRemoved,this._domStorageItemRemoved,this),this._domStorage.addEventListener(Pe.Events.DOMStorageItemAdded,this._domStorageItemAdded,this),this._domStorage.addEventListener(Pe.Events.DOMStorageItemUpdated,this._domStorageItemUpdated,this)],this.refreshItems()}_domStorageItemsCleared(){this.isShowing()&&this._dataGrid&&(this._dataGrid.rootNode().removeChildren(),this._dataGrid.addCreationNode(!1),this.setCanDeleteSelected(!1))}_domStorageItemRemoved(e){if(!this.isShowing()||!this._dataGrid)return;const t=e.data,i=this._dataGrid.rootNode(),s=i.children;for(let e=0;e<s.length;++e){const a=s[e];if(a.data.key===t.key)return i.removeChild(a),void this.setCanDeleteSelected(s.length>1)}}_domStorageItemAdded(e){if(!this.isShowing()||!this._dataGrid)return;const t=e.data,i=this._dataGrid.rootNode(),s=i.children;for(let e=0;e<s.length;++e)if(s[e].data.key===t.key)return;const a=new c.DataGridNode({key:t.key,value:t.value},!1);i.insertChild(a,s.length-1)}_domStorageItemUpdated(e){if(!this.isShowing()||!this._dataGrid)return;const t=e.data,i=this._dataGrid.rootNode().children.find(e=>e.data.key===t.key);i&&i.data.value!==t.value&&(i.data.value=t.value,i.refresh(),i.selected&&(this._previewEntry(i),this.setCanDeleteSelected(!0)))}_showDOMStorageItems(e){const t=this._dataGrid.rootNode();let i=null;for(const e of t.children)if(e.selected){i=e.data.key;break}t.removeChildren();let s=null;const a=e=>`${e[0]} ${e[1]}`;for(const r of this.filter(e,a)){const e=r[0],a=r[1],n=new c.DataGridNode({key:e,value:a},!1);n.selectable=!0,t.appendChild(n),s&&e!==i||(s=n)}s&&(s.selected=!0),this._dataGrid.addCreationNode(!1),this.setCanDeleteSelected(!!s)}deleteSelectedItem(){this._dataGrid&&this._dataGrid.selectedNode&&this._deleteCallback(this._dataGrid.selectedNode)}refreshItems(){this._domStorage.getItems().then(e=>e&&this._showDOMStorageItems(e))}deleteAllItems(){this._domStorage.clear(),this._domStorageItemsCleared()}_editingCallback(e,t,i,s){const a=this._domStorage;"key"===t?("string"==typeof i&&a.removeItem(i),a.setItem(s,e.data.value||""),this._removeDupes(e)):a.setItem(e.data.key||"",s)}_removeDupes(e){const t=this._dataGrid.rootNode(),i=t.children;for(let s=i.length-1;s>=0;--s){const a=i[s];a.data.key===e.data.key&&e!==a&&t.removeChild(a)}}_deleteCallback(e){e&&!e.isCreationNode&&this._domStorage&&this._domStorage.removeItem(e.data.key)}_showPreview(t,i){this._preview&&this._previewValue===i||(this._preview&&this._preview.detach(),t||(t=new v.EmptyWidget(e.UIString("Select a value to preview"))),this._previewValue=i,this._preview=t,t.show(this._previewPanel.contentElement))}async _previewEntry(e){const t=e&&e.data&&e.data.value;if(!t)return void this._showPreview(null,t);const i=`${this._domStorage.isLocalStorage?"localstorage":"sessionstorage"}://${e.key}`,s=ve.StaticContentProvider.fromString(i,d.resourceTypes.XHR,t),a=await ee.PreviewFactory.createPreview(s,"text/plain");e.selected&&this._showPreview(a,t)}}var si=Object.freeze({__proto__:null,DOMStorageItemsView:ii});let ai;class ri extends U.PanelWithSidebar{constructor(){super("resources"),this.registerRequiredCSS("resources/resourcesPanel.css"),this._resourcesLastSelectedItemSetting=t.Settings.instance().createSetting("resourcesLastSelectedElementPath",[]),this.visibleView=null,this._pendingViewPromise=null,this._categoryView=null;const e=new S.VBox;this.storageViews=e.element.createChild("div","vbox flex-auto"),this._storageViewToolbar=new b.Toolbar("resources-toolbar",e.element),this.splitWidget().setMainWidget(e),this._domStorageView=null,this._cookieView=null,this._emptyWidget=null,this._sidebar=new Et(this),this._sidebar.show(this.panelSidebarElement())}static instance(e={forceNew:null}){const{forceNew:t}=e;return ai&&!t||(ai=new ri),ai}static _instance(){return ri.instance()}static _shouldCloseOnReset(e){return[te.ResourceSourceFrame,ie.ImageView,se.FontView,Yt,tt,rt].some(t=>e instanceof t)}focus(){this._sidebar.focus()}lastSelectedItemPath(){return this._resourcesLastSelectedItemSetting.get()}setLastSelectedItemPath(e){this._resourcesLastSelectedItemSetting.set(e)}resetView(){this.visibleView&&ri._shouldCloseOnReset(this.visibleView)&&this.showView(null)}showView(e){this._pendingViewPromise=null,this.visibleView!==e&&(this.visibleView&&this.visibleView.detach(),e&&e.show(this.storageViews),this.visibleView=e,this._storageViewToolbar.removeToolbarItems(),e instanceof g.SimpleView&&e.toolbarItems().then(e=>{e.map(e=>this._storageViewToolbar.appendToolbarItem(e)),this._storageViewToolbar.element.classList.toggle("hidden",!e.length)}))}async scheduleShowView(e){this._pendingViewPromise=e;const t=await e;return this._pendingViewPromise!==e?null:(this.showView(t),t)}showCategoryView(e,t){this._categoryView||(this._categoryView=new zt),this._categoryView.setText(e),this._categoryView.setLink(t),this.showView(this._categoryView)}showDOMStorage(e){e&&(this._domStorageView?this._domStorageView.setStorage(e):this._domStorageView=new ii(e),this.showView(this._domStorageView))}showCookies(e,t){const i=e.model(G.CookieModel);i&&(this._cookieView?this._cookieView.setCookiesDomain(i,t):this._cookieView=new ei(i,t),this.showView(this._cookieView))}clearCookies(e,t){const i=e.model(G.CookieModel);i&&i.clear(t).then(()=>{this._cookieView&&this._cookieView.refreshItems()})}}var ni=Object.freeze({__proto__:null,ResourcesPanel:ri,ResourceRevealer:class{async reveal(e){if(!(e instanceof Y.Resource))return Promise.reject(new Error("Internal error: not a resource"));const t=ri._instance()._sidebar;await N.ViewManager.instance().showView("resources"),await t.showResource(e)}},CookieReferenceRevealer:class{async reveal(e){if(!(e instanceof J.CookieReference))throw new Error("Internal error: not a cookie reference");const t=ri._instance()._sidebar;await N.ViewManager.instance().showView("resources"),await t.cookieListTreeElement.select();const i=e.contextUrl();i&&await this._revealByDomain(t,i)||this._revealByDomain(t,e.domain())}async _revealByDomain(e,t){const i=e.cookieListTreeElement.children().find(e=>e.cookieDomain().endsWith(t));return!!i&&(await i.revealAndSelect(),!0)}}});export{Te as AppManifestView,ke as ApplicationCacheItemsView,Ce as ApplicationCacheModel,Jt as ApplicationPanelSidebar,xe as BackgroundServiceModel,Oe as BackgroundServiceView,et as ClearStorageView,ti as CookieItemsView,si as DOMStorageItemsView,qe as DOMStorageModel,Ne as DatabaseModel,at as DatabaseQueryView,nt as DatabaseTableView,mt as FrameDetailsView,Je as IndexedDBModel,bt as IndexedDBViews,ni as ResourcesPanel,yt as ServiceWorkerCacheViews,kt as ServiceWorkersView,Zt as StorageItemsView};
