import{Linkifier as e,Revealer as t,Color as i}from"../common/common.js";import{BezierUI as s}from"../inline_editor/inline_editor.js";import{Widget as n,Context as a,Toolbar as r,ARIAUtils as o,PopoverHelper as h,UIUtils as l,Geometry as d,ContextMenu as _}from"../ui/ui.js";import{userMetrics as m,UserMetrics as c}from"../host/host.js";import{ArrayUtilities as u}from"../platform/platform.js";import{SDKModel as p,RuntimeModel as b,ResourceTreeModel as f,ScreenCaptureModel as y,DOMModel as g}from"../sdk/sdk.js";class v extends p.SDKModel{constructor(e){super(e),this._runtimeModel=e.model(b.RuntimeModel),this._agent=e.animationAgent(),e.registerAnimationDispatcher(new x(this)),this._animationsById=new Map,this._animationGroups=new Map,this._pendingAnimations=new Set,this._playbackRate=1;e.model(f.ResourceTreeModel).addEventListener(f.Events.MainFrameNavigated,this._reset,this);const t=e.model(y.ScreenCaptureModel);t&&(this._screenshotCapture=new P(this,t))}_reset(){this._animationsById.clear(),this._animationGroups.clear(),this._pendingAnimations.clear(),this.dispatchEventToListeners(w.ModelReset)}animationCreated(e){this._pendingAnimations.add(e)}_animationCanceled(e){this._pendingAnimations.delete(e),this._flushPendingAnimationsIfNeeded()}animationStarted(e){if(!e.source||!e.source.backendNodeId)return;const t=M.parsePayload(this,e);if(!t)return;const i=t.source().keyframesRule();"WebAnimation"===t.type()&&i&&0===i.keyframes().length?this._pendingAnimations.delete(t.id()):(this._animationsById.set(t.id(),t),this._pendingAnimations.add(t.id())),this._flushPendingAnimationsIfNeeded()}_flushPendingAnimationsIfNeeded(){for(const e of this._pendingAnimations)if(!this._animationsById.get(e))return;for(;this._pendingAnimations.size;)this._matchExistingGroups(this._createGroupFromPendingAnimations())}_matchExistingGroups(e){let t=null;for(const i of this._animationGroups.values())if(i._matches(e)){t=i,i._update(e);break}return t||(this._animationGroups.set(e.id(),e),this._screenshotCapture&&this._screenshotCapture.captureScreenshots(e.finiteDuration(),e._screenshots)),this.dispatchEventToListeners(w.AnimationGroupStarted,t||e),!!t}_createGroupFromPendingAnimations(){console.assert(this._pendingAnimations.size>0);const e=this._pendingAnimations.values().next().value;this._pendingAnimations.delete(e);const t=this._animationsById.get(e);if(!t)throw new Error("Unable to locate first animation");const i=[t],s=t.startTime(),n=new Set;for(const e of this._pendingAnimations){const t=this._animationsById.get(e);t.startTime()===s?i.push(t):n.add(e)}return this._pendingAnimations=n,new T(this,e,i)}setPlaybackRate(e){this._playbackRate=e,this._agent.invoke_setPlaybackRate({playbackRate:e})}_releaseAnimations(e){this._agent.invoke_releaseAnimations({animations:e})}async suspendModel(){this._reset(),await this._agent.invoke_disable()}async resumeModel(){this._enabled&&await this._agent.invoke_enable()}async ensureEnabled(){this._enabled||(await this._agent.invoke_enable(),this._enabled=!0)}}const w={AnimationGroupStarted:Symbol("AnimationGroupStarted"),ModelReset:Symbol("ModelReset")};class M{constructor(e,t){this._animationModel=e,this._payload=t,this._source=new k(e,this._payload.source)}static parsePayload(e,t){return new M(e,t)}payload(){return this._payload}id(){return this._payload.id}name(){return this._payload.name}paused(){return this._payload.pausedState}playState(){return this._playState||this._payload.playState}setPlayState(e){this._playState=e}playbackRate(){return this._payload.playbackRate}startTime(){return this._payload.startTime}endTime(){return this.source().iterations?this.startTime()+this.source().delay()+this.source().duration()*this.source().iterations()+this.source().endDelay():1/0}_finiteDuration(){const e=Math.min(this.source().iterations(),3);return this.source().delay()+this.source().duration()*e}currentTime(){return this._payload.currentTime}source(){return this._source}type(){return this._payload.type}overlaps(e){if(!this.source().iterations()||!e.source().iterations())return!0;const t=this.startTime()<e.startTime()?this:e,i=t===this?e:this;return t.endTime()>=i.startTime()}setTiming(e,t){this._source.node().then(i=>{if(!i)throw new Error("Unable to find node");this._updateNodeStyle(e,t,i)}),this._source._duration=e,this._source._delay=t,this._animationModel._agent.invoke_setTiming({animationId:this.id(),duration:e,delay:t})}_updateNodeStyle(e,t,i){let s;if(this.type()===A.CSSTransition)s="transition-";else{if(this.type()!==A.CSSAnimation)return;s="animation-"}if(!i.id)throw new Error("Node has no id");const n=i.domModel().cssModel();n.setEffectivePropertyValueForNode(i.id,s+"duration",e+"ms"),n.setEffectivePropertyValueForNode(i.id,s+"delay",t+"ms")}async remoteObjectPromise(){const e=await this._animationModel._agent.invoke_resolveAnimation({animationId:this.id()});return e?this._animationModel._runtimeModel.createRemoteObject(e.remoteObject):null}_cssId(){return this._payload.cssId||""}}const A={CSSTransition:"CSSTransition",CSSAnimation:"CSSAnimation",WebAnimation:"WebAnimation"};class k{constructor(e,t){this._animationModel=e,this._payload=t,t.keyframesRule&&(this._keyframesRule=new C(t.keyframesRule)),this._delay=this._payload.delay,this._duration=this._payload.duration}delay(){return this._delay}endDelay(){return this._payload.endDelay}iterationStart(){return this._payload.iterationStart}iterations(){return this.delay()||this.endDelay()||this.duration()?this._payload.iterations||1/0:0}duration(){return this._duration}direction(){return this._payload.direction}fill(){return this._payload.fill}node(){return this._deferredNode||(this._deferredNode=new g.DeferredDOMNode(this._animationModel.target(),this.backendNodeId())),this._deferredNode.resolvePromise()}deferredNode(){return new g.DeferredDOMNode(this._animationModel.target(),this.backendNodeId())}backendNodeId(){return this._payload.backendNodeId}keyframesRule(){return this._keyframesRule||null}easing(){return this._payload.easing}}class C{constructor(e){this._payload=e,this._keyframes=this._payload.keyframes.map((function(e){return new S(e)}))}_setKeyframesPayload(e){this._keyframes=e.map((function(e){return new S(e)}))}name(){return this._payload.name}keyframes(){return this._keyframes}}class S{constructor(e){this._payload=e,this._offset=this._payload.offset}offset(){return this._offset}setOffset(e){this._offset=100*e+"%"}offsetAsNumber(){return parseFloat(this._offset)/100}easing(){return this._payload.easing}}class T{constructor(e,t,i){this._animationModel=e,this._id=t,this._animations=i,this._paused=!1,this._screenshots=[],this._screenshotImages=[]}id(){return this._id}animations(){return this._animations}release(){this._animationModel._animationGroups.delete(this.id()),this._animationModel._releaseAnimations(this._animationIds())}_animationIds(){return this._animations.map((function(e){return e.id()}))}startTime(){return this._animations[0].startTime()}finiteDuration(){let e=0;for(let t=0;t<this._animations.length;++t)e=Math.max(e,this._animations[t]._finiteDuration());return e}seekTo(e){this._animationModel._agent.invoke_seekAnimations({animations:this._animationIds(),currentTime:e})}paused(){return this._paused}togglePause(e){e!==this._paused&&(this._paused=e,this._animationModel._agent.invoke_setPaused({animations:this._animationIds(),paused:e}))}currentTimePromise(){let e=null;for(const t of this._animations)(!e||t.endTime()>e.endTime())&&(e=t);if(!e)throw new Error("No longest animation found");return this._animationModel._agent.invoke_getCurrentTime({id:e.id()}).then(({currentTime:e})=>e||0)}_matches(e){function t(e){return e.type()===A.WebAnimation?e.type()+e.id():e._cssId()}if(this._animations.length!==e._animations.length)return!1;const i=this._animations.map(t).sort(),s=e._animations.map(t).sort();for(let e=0;e<i.length;e++)if(i[e]!==s[e])return!1;return!0}_update(e){this._animationModel._releaseAnimations(this._animationIds()),this._animations=e._animations}screenshots(){for(let e=0;e<this._screenshots.length;++e){const t=new Image;t.src="data:image/jpeg;base64,"+this._screenshots[e],this._screenshotImages.push(t)}return this._screenshots=[],this._screenshotImages}}class x{constructor(e){this._animationModel=e}animationCreated({id:e}){this._animationModel.animationCreated(e)}animationCanceled({id:e}){this._animationModel._animationCanceled(e)}animationStarted({animation:e}){this._animationModel.animationStarted(e)}usesObjectNotation(){return!0}}class P{constructor(e,t){this._requests=[],this._screenCaptureModel=t,this._animationModel=e,this._animationModel.addEventListener(w.ModelReset,this._stopScreencast,this)}captureScreenshots(e,t){const i=Math.min(e/this._animationModel._playbackRate,3e3),s=i+window.performance.now();this._requests.push({endTime:s,screenshots:t}),(!this._endTime||s>this._endTime)&&(clearTimeout(this._stopTimer),this._stopTimer=window.setTimeout(this._stopScreencast.bind(this),i),this._endTime=s),this._capturing||(this._capturing=!0,this._screenCaptureModel.startScreencast(Protocol.Page.StartScreencastRequestFormat.Jpeg,80,void 0,300,2,this._screencastFrame.bind(this),e=>{}))}_screencastFrame(e,t){if(!this._capturing)return;const i=window.performance.now();this._requests=this._requests.filter((function(e){return e.endTime>=i}));for(const t of this._requests)t.screenshots.push(e)}_stopScreencast(){this._capturing&&(delete this._stopTimer,delete this._endTime,this._requests=[],this._capturing=!1,this._screenCaptureModel.stopScreencast())}}p.SDKModel.register(v,p.Capability.DOM,!1);var R=Object.freeze({__proto__:null,AnimationModel:v,Events:w,AnimationImpl:M,Type:A,AnimationEffect:k,KeyframesRule:C,KeyframeStyle:S,AnimationGroup:T,AnimationDispatcher:x,ScreenshotCapture:P,Request:void 0});class E extends n.VBox{constructor(e){super(!0),console.assert(e.length>0),this.registerRequiredCSS("animation/animationScreenshotPopover.css"),this.contentElement.classList.add("animation-screenshot-popover"),this._frames=e;for(const t of e)this.contentElement.appendChild(t),t.style.display="none";this._rafId=0,this._currentFrame=0,this._frames[0].style.display="block",this._progressBar=this.contentElement.createChild("div","animation-progress")}wasShown(){this._rafId=this.contentElement.window().requestAnimationFrame(this._changeFrame.bind(this))}willHide(){this.contentElement.window().cancelAnimationFrame(this._rafId),delete this._endDelay}_changeFrame(){if(this._rafId=this.contentElement.window().requestAnimationFrame(this._changeFrame.bind(this)),this._endDelay)return void this._endDelay--;if(this._showFrame=!this._showFrame,!this._showFrame)return;const e=this._frames.length;this._frames[this._currentFrame%e].style.display="none",this._currentFrame++,this._frames[this._currentFrame%e].style.display="block",this._currentFrame%e==e-1&&(this._endDelay=50),this._progressBar.style.width=(this._currentFrame%e+1)/e*100+"%"}}var B=Object.freeze({__proto__:null,AnimationScreenshotPopover:E});const G=new WeakMap,L=new WeakMap;class I extends n.VBox{constructor(){super(!0),this.registerRequiredCSS("animation/animationTimeline.css"),this.element.classList.add("animations-timeline"),this._grid=this.contentElement.createSVGChild("svg","animation-timeline-grid"),this._playbackRate=1,this._allPaused=!1,this._createHeader(),this._animationsContainer=this.contentElement.createChild("div","animation-timeline-rows");this.contentElement.createChild("div","animation-timeline-rows-hint").textContent=ls`Select an effect above to inspect and modify.`,this._playbackRateButtons,this._previewContainer,this._timelineScrubber,this._currentTime,this._popoverHelper,this._clearButton,this._selectedGroup,this._renderQueue,this._defaultDuration=100,this._duration=this._defaultDuration,this._timelineControlsWidth=150,this._nodesMap=new Map,this._uiAnimations=[],this._groupBuffer=[],this._previewMap=new Map,this._symbol=Symbol("animationTimeline"),this._animationsMap=new Map,p.TargetManager.instance().addModelListener(g.DOMModel,g.Events.NodeRemoved,this._nodeRemoved,this),p.TargetManager.instance().observeModels(v,this),a.Context.instance().addFlavorChangeListener(g.DOMNode,this._nodeChanged,this)}wasShown(){for(const e of p.TargetManager.instance().models(v))this._addEventListeners(e)}willHide(){for(const e of p.TargetManager.instance().models(v))this._removeEventListeners(e);this._popoverHelper&&this._popoverHelper.hidePopover()}modelAdded(e){this.isShowing()&&this._addEventListeners(e)}modelRemoved(e){this._removeEventListeners(e)}_addEventListeners(e){e.ensureEnabled(),e.addEventListener(w.AnimationGroupStarted,this._animationGroupStarted,this),e.addEventListener(w.ModelReset,this._reset,this)}_removeEventListeners(e){e.removeEventListener(w.AnimationGroupStarted,this._animationGroupStarted,this),e.removeEventListener(w.ModelReset,this._reset,this)}_nodeChanged(){for(const e of this._nodesMap.values())e._nodeChanged()}_createScrubber(){return this._timelineScrubber=document.createElement("div"),this._timelineScrubber.classList.add("animation-scrubber"),this._timelineScrubber.classList.add("hidden"),this._timelineScrubberLine=this._timelineScrubber.createChild("div","animation-scrubber-line"),this._timelineScrubberLine.createChild("div","animation-scrubber-head"),this._timelineScrubber.createChild("div","animation-time-overlay"),this._timelineScrubber}_createHeader(){const e=this.contentElement.createChild("div","animation-timeline-toolbar-container"),t=new r.Toolbar("animation-timeline-toolbar",e);this._clearButton=new r.ToolbarButton(ls`Clear all`,"largeicon-clear"),this._clearButton.addEventListener(r.ToolbarButton.Events.Click,this._reset.bind(this)),t.appendToolbarItem(this._clearButton),t.appendSeparator(),this._pauseButton=new r.ToolbarToggle(ls`Pause all`,"largeicon-pause","largeicon-resume"),this._pauseButton.addEventListener(r.ToolbarButton.Events.Click,this._togglePauseAll.bind(this)),t.appendToolbarItem(this._pauseButton);const i=e.createChild("div","animation-playback-rate-control");i.addEventListener("keydown",this._handlePlaybackRateControlKeyDown.bind(this)),o.markAsListBox(i),o.setAccessibleName(i,ls`Playback rates`),this._playbackRateButtons=[];for(const e of D){const t=i.createChild("button","animation-playback-rate-button");t.textContent=e?ls`${100*e}%`:ls`Pause`,L.set(t,e),t.addEventListener("click",this._setPlaybackRate.bind(this,e)),o.markAsOption(t),t.title=ls`Set speed to ${t.textContent}`,t.tabIndex=-1,this._playbackRateButtons.push(t)}this._updatePlaybackControls(),this._previewContainer=this.contentElement.createChild("div","animation-timeline-buffer"),o.markAsListBox(this._previewContainer),o.setAccessibleName(this._previewContainer,ls`Animation previews`),this._popoverHelper=new h.PopoverHelper(this._previewContainer,this._getPopoverRequest.bind(this)),this._popoverHelper.setDisableOnClick(!0),this._popoverHelper.setTimeout(0);this.contentElement.createChild("div","animation-timeline-buffer-hint").textContent=ls`Listening for animations...`;const s=this.contentElement.createChild("div","animation-timeline-header"),n=s.createChild("div","animation-controls");this._currentTime=n.createChild("div","animation-timeline-current-time monospace");const a=new r.Toolbar("animation-controls-toolbar",n);this._controlButton=new r.ToolbarToggle(ls`Replay timeline`,"largeicon-replay-animation"),this._controlState=F.Replay,this._controlButton.setToggled(!0),this._controlButton.addEventListener(r.ToolbarButton.Events.Click,this._controlButtonToggle.bind(this)),a.appendToolbarItem(this._controlButton);const d=s.createChild("div","animation-grid-header");return l.installDragHandle(d,this._repositionScrubber.bind(this),this._scrubberDragMove.bind(this),this._scrubberDragEnd.bind(this),"text"),s.appendChild(this._createScrubber()),this._timelineScrubberLine&&l.installDragHandle(this._timelineScrubberLine,this._scrubberDragStart.bind(this),this._scrubberDragMove.bind(this),this._scrubberDragEnd.bind(this),"col-resize"),this._currentTime.textContent="",s}_handlePlaybackRateControlKeyDown(e){switch(e.key){case"ArrowLeft":case"ArrowUp":this._focusNextPlaybackRateButton(e.target,!0);break;case"ArrowRight":case"ArrowDown":this._focusNextPlaybackRateButton(e.target)}}_focusNextPlaybackRateButton(e,t){const i=e,s=this._playbackRateButtons.indexOf(i),n=t?s-1:s+1;if(n<0||n>=this._playbackRateButtons.length)return;const a=this._playbackRateButtons[n];a.tabIndex=0,a.focus(),e&&(e.tabIndex=-1)}_getPopoverRequest(e){const t=e.target;return t&&t.isDescendant(this._previewContainer)?{box:t.boxInWindow(),show:e=>{let i;for(const[e,s]of this._previewMap)s.element===t.parentElement&&(i=e);if(console.assert(void 0!==i),!i)return Promise.resolve(!1);const s=i.screenshots();if(!s.length)return Promise.resolve(!1);let n;const a=new Promise(e=>{n=e});return s[0].complete?r(s):s[0].onload=r.bind(null,s),a;function r(t){new E(t).show(e.contentElement),n(!0)}},hide:void 0}:null}_togglePauseAll(){this._allPaused=!this._allPaused,this._pauseButton&&this._pauseButton.setToggled(this._allPaused),this._setPlaybackRate(this._playbackRate),this._pauseButton&&this._pauseButton.setTitle(this._allPaused?ls`Resume all`:ls`Pause all`)}_setPlaybackRate(e){this._playbackRate=e;for(const e of p.TargetManager.instance().models(v))e.setPlaybackRate(this._allPaused?0:this._playbackRate);m.actionTaken(c.Action.AnimationsPlaybackRateChanged),this._scrubberPlayer&&(this._scrubberPlayer.playbackRate=this._effectivePlaybackRate()),this._updatePlaybackControls()}_updatePlaybackControls(){for(const e of this._playbackRateButtons){const t=this._playbackRate===L.get(e);e.classList.toggle("selected",t),e.tabIndex=t?0:-1}}_controlButtonToggle(){this._controlState===F.Play?this._togglePause(!1):this._controlState===F.Replay?this._replay():this._togglePause(!0)}_updateControlButton(){this._controlButton&&(this._controlButton.setEnabled(!!this._selectedGroup),this._selectedGroup&&this._selectedGroup.paused()?(this._controlState=F.Play,this._controlButton.setToggled(!0),this._controlButton.setTitle(ls`Play timeline`),this._controlButton.setGlyph("largeicon-play-animation")):!this._scrubberPlayer||!this._scrubberPlayer.currentTime||this._scrubberPlayer.currentTime>=this.duration()?(this._controlState=F.Replay,this._controlButton.setToggled(!0),this._controlButton.setTitle(ls`Replay timeline`),this._controlButton.setGlyph("largeicon-replay-animation")):(this._controlState=F.Pause,this._controlButton.setToggled(!1),this._controlButton.setTitle(ls`Pause timeline`),this._controlButton.setGlyph("largeicon-pause-animation")))}_effectivePlaybackRate(){return this._allPaused||this._selectedGroup&&this._selectedGroup.paused()?0:this._playbackRate}_togglePause(e){if(this._scrubberPlayer&&(this._scrubberPlayer.playbackRate=this._effectivePlaybackRate()),this._selectedGroup){this._selectedGroup.togglePause(e);const t=this._previewMap.get(this._selectedGroup);t&&t.element.classList.toggle("paused",e)}this._updateControlButton()}_replay(){this._selectedGroup&&(this._selectedGroup.seekTo(0),this._animateTime(0),this._updateControlButton())}duration(){return this._duration}setDuration(e){this._duration=e,this.scheduleRedraw()}_clearTimeline(){this._uiAnimations=[],this._nodesMap.clear(),this._animationsMap.clear(),this._animationsContainer.removeChildren(),this._duration=this._defaultDuration,this._timelineScrubber.classList.add("hidden"),this._selectedGroup=null,this._scrubberPlayer&&this._scrubberPlayer.cancel(),delete this._scrubberPlayer,this._currentTime.textContent="",this._updateControlButton()}_reset(){this._clearTimeline(),this._allPaused?this._togglePauseAll():this._setPlaybackRate(this._playbackRate);for(const e of this._groupBuffer)e.release();this._groupBuffer=[],this._previewMap.clear(),this._previewContainer.removeChildren(),this._popoverHelper.hidePopover(),this._renderGrid()}_animationGroupStarted(e){this._addAnimationGroup(e.data)}_addAnimationGroup(e){const t=this._previewMap.get(e);if(t)return void(this._selectedGroup===e?this._syncScrubber():t.replay());this._groupBuffer.sort((function(e,t){return e.startTime()===t.startTime()?0:e.startTime()>t.startTime()?1:-1}));const i=[],s=this.width()/50;for(;this._groupBuffer.length>s;){const e=this._groupBuffer.splice(this._groupBuffer[0]===this._selectedGroup?1:0,1);i.push(e[0])}for(const e of i){const t=this._previewMap.get(e);t&&(t.element.remove(),this._previewMap.delete(e),e.release())}const n=new z(e);if(this._groupBuffer.push(e),this._previewMap.set(e,n),this._previewContainer.appendChild(n.element),n.removeButton().addEventListener("click",this._removeAnimationGroup.bind(this,e)),n.element.addEventListener("click",this._selectAnimationGroup.bind(this,e)),n.element.addEventListener("keydown",this._handleAnimationGroupKeyDown.bind(this,e)),o.setAccessibleName(n.element,ls`Animation Preview ${this._groupBuffer.indexOf(e)+1}`),o.markAsOption(n.element),1===this._previewMap.size){const e=this._previewMap.get(this._groupBuffer[0]);e&&(e.element.tabIndex=0)}}_handleAnimationGroupKeyDown(e,t){switch(t.key){case" ":case"Enter":this._selectAnimationGroup(e);break;case"Backspace":case"Delete":this._removeAnimationGroup(e,t);break;case"ArrowLeft":case"ArrowUp":this._focusNextGroup(e,t.target,!0);break;case"ArrowRight":case"ArrowDown":this._focusNextGroup(e,t.target)}}_focusNextGroup(e,t,i){const s=this._groupBuffer.indexOf(e),n=i?s-1:s+1;if(n<0||n>=this._groupBuffer.length)return;const a=this._previewMap.get(this._groupBuffer[n]);a&&(a.element.tabIndex=0,a.element.focus()),t&&(t.tabIndex=-1)}_removeAnimationGroup(e,t){const i=this._groupBuffer.indexOf(e);u.removeElement(this._groupBuffer,e);const s=this._previewMap.get(e);s&&s.element.remove(),this._previewMap.delete(e),e.release(),t.consume(!0),this._selectedGroup===e&&(this._clearTimeline(),this._renderGrid());if(0===this._groupBuffer.length)return void this._clearButton.element.focus();const n=i>=this._groupBuffer.length?this._previewMap.get(this._groupBuffer[this._groupBuffer.length-1]):this._previewMap.get(this._groupBuffer[i]);n&&(n.element.tabIndex=0,n.element.focus())}_selectAnimationGroup(e){if(this._selectedGroup===e)return this._togglePause(!1),void this._replay();this._clearTimeline(),this._selectedGroup=e,this._previewMap.forEach((function(e,t){e.element.classList.toggle("selected",this._selectedGroup===t)}),this),this.setDuration(Math.max(500,e.finiteDuration()+100));for(const t of e.animations())this._addAnimation(t);this.scheduleRedraw(),this._timelineScrubber.classList.remove("hidden"),this._togglePause(!1),this._replay()}_addAnimation(e){let t=this._nodesMap.get(e.source().backendNodeId());t||(t=new N(e.source()),this._animationsContainer.appendChild(t.element),this._nodesMap.set(e.source().backendNodeId(),t));const i=t.createNewRow(),s=new K(e,this,i);e.source().deferredNode().resolve(function(e){s.setNode(e),e&&t&&(t.nodeResolved(e),G.set(e,t))}.bind(this)),this._uiAnimations.push(s),this._animationsMap.set(e.id(),e)}_nodeRemoved(e){const t=e.data.node,i=G.get(t);i&&i.nodeRemoved()}_renderGrid(){this._grid.setAttribute("width",(this.width()+10).toString()),this._grid.setAttribute("height",((this._cachedTimelineHeight||0)+30).toString()),this._grid.setAttribute("shape-rendering","crispEdges"),this._grid.removeChildren();let e=void 0;for(let e=0;e<this.duration();e+=250){const t=this._grid.createSVGChild("rect","animation-timeline-grid-line");t.setAttribute("x",(e*this.pixelMsRatio()+10).toString()),t.setAttribute("y","23"),t.setAttribute("height","100%"),t.setAttribute("width","1")}for(let t=0;t<this.duration();t+=250){const i=t*this.pixelMsRatio();if(void 0===e||i-e>50){e=i;const s=this._grid.createSVGChild("text","animation-timeline-grid-label");s.textContent=Number.millisToString(t),s.setAttribute("x",(i+10).toString()),s.setAttribute("y","16")}}}scheduleRedraw(){this._renderQueue=[];for(const e of this._uiAnimations)this._renderQueue.push(e);this._redrawing||(this._redrawing=!0,this._renderGrid(),this._animationsContainer.window().requestAnimationFrame(this._render.bind(this)))}_render(e){for(;this._renderQueue.length&&(!e||window.performance.now()-e<50);){const e=this._renderQueue.shift();e&&e.redraw()}this._renderQueue.length?this._animationsContainer.window().requestAnimationFrame(this._render.bind(this)):delete this._redrawing}onResize(){this._cachedTimelineWidth=Math.max(0,this._animationsContainer.offsetWidth-this._timelineControlsWidth)||0,this._cachedTimelineHeight=this._animationsContainer.offsetHeight,this.scheduleRedraw(),this._scrubberPlayer&&this._syncScrubber(),delete this._gridOffsetLeft}width(){return this._cachedTimelineWidth||0}_resizeWindow(e){let t=!1;const i=e.source().duration()*Math.min(2,e.source().iterations()),s=e.source().delay()+i+e.source().endDelay();return s>this._duration&&(t=!0,this._duration=s+200),t}_syncScrubber(){this._selectedGroup&&this._selectedGroup.currentTimePromise().then(this._animateTime.bind(this)).then(this._updateControlButton.bind(this))}_animateTime(e){this._scrubberPlayer&&this._scrubberPlayer.cancel(),this._scrubberPlayer=this._timelineScrubber.animate([{transform:"translateX(0px)"},{transform:"translateX("+this.width()+"px)"}],{duration:this.duration(),fill:"forwards"}),this._scrubberPlayer.playbackRate=this._effectivePlaybackRate(),this._scrubberPlayer.onfinish=this._updateControlButton.bind(this),this._scrubberPlayer.currentTime=e,this.element.window().requestAnimationFrame(this._updateScrubber.bind(this))}pixelMsRatio(){return this.width()/this.duration()||0}_updateScrubber(e){this._scrubberPlayer&&(this._currentTime.textContent=Number.millisToString(this._scrubberPlayer.currentTime||0),"pending"===this._scrubberPlayer.playState.toString()||"running"===this._scrubberPlayer.playState?this.element.window().requestAnimationFrame(this._updateScrubber.bind(this)):"finished"===this._scrubberPlayer.playState&&(this._currentTime.textContent=""))}_repositionScrubber(e){if(!this._selectedGroup)return!1;this._gridOffsetLeft||(this._gridOffsetLeft=this._grid.totalOffsetLeft()+10);const{x:t}=e,i=Math.max(0,t-this._gridOffsetLeft)/this.pixelMsRatio();return this._selectedGroup.seekTo(i),this._togglePause(!0),this._animateTime(i),this._originalScrubberTime=i,this._originalMousePosition=t,!0}_scrubberDragStart(e){if(!this._scrubberPlayer||!this._selectedGroup)return!1;this._originalScrubberTime=this._scrubberPlayer.currentTime,this._timelineScrubber.classList.remove("animation-timeline-end"),this._scrubberPlayer.pause();const{x:t}=e;return this._originalMousePosition=t,this._togglePause(!0),!0}_scrubberDragMove(e){const{x:t}=e,i=t-this._originalMousePosition,s=Math.max(0,Math.min((this._originalScrubberTime||0)+i/this.pixelMsRatio(),this.duration()));this._scrubberPlayer&&(this._scrubberPlayer.currentTime=s),this._currentTime.textContent=Number.millisToString(Math.round(s)),this._selectedGroup&&this._selectedGroup.seekTo(s)}_scrubberDragEnd(e){if(this._scrubberPlayer){const e=Math.max(0,this._scrubberPlayer.currentTime||0);this._scrubberPlayer.play(),this._scrubberPlayer.currentTime=e}this._currentTime.window().requestAnimationFrame(this._updateScrubber.bind(this))}}const D=[1,.25,.1],F={Play:"play-outline",Replay:"replay-outline",Pause:"pause-outline"};class N{constructor(e){this.element=document.createElement("div"),this.element.classList.add("animation-node-row"),this._description=this.element.createChild("div","animation-node-description"),this._description.tabIndex=0,this._timelineElement=this.element.createChild("div","animation-node-timeline"),o.markAsApplication(this._timelineElement)}nodeResolved(i){i?(this._node=i,this._nodeChanged(),e.Linkifier.linkify(i,{tooltip:void 0,preventKeyboardFocus:!0}).then(e=>{this._description.appendChild(e),this._description.addEventListener("keydown",e=>{isEnterOrSpaceKey(e)&&this._node&&(t.reveal(i,!1),e.consume(!0))})}),i.ownerDocument||this.nodeRemoved()):l.createTextChild(this._description,"<node>")}createNewRow(){return this._timelineElement.createChild("div","animation-timeline-row")}nodeRemoved(){this.element.classList.add("animation-node-removed"),this._node=null}_nodeChanged(){let e=!1;this._node&&(e=this._node===a.Context.instance().flavor(g.DOMNode)),this.element.classList.toggle("animation-node-selected",e)}}class O{constructor(e,t){this.steps=e,this.stepAtPosition=t}static parse(e){let t=e.match(/^steps\((\d+), (start|middle)\)$/);return t?new O(parseInt(t[1],10),t[2]):(t=e.match(/^steps\((\d+)\)$/),t?new O(parseInt(t[1],10),"end"):null)}}var H=Object.freeze({__proto__:null,AnimationTimeline:I,GlobalPlaybackRates:D,_ControlState:F,NodeUI:N,StepTimingFunction:O});class K{constructor(e,t,i){this._animation=e,this._timeline=t,this._parentElement=i,this._animation.source().keyframesRule()&&(this._keyframes=this._animation.source().keyframesRule().keyframes()),this._nameElement=i.createChild("div","animation-name"),this._nameElement.textContent=this._animation.name(),this._svg=i.createSVGChild("svg","animation-ui"),this._svg.setAttribute("height",j.AnimationSVGHeight),this._svg.style.marginLeft="-"+j.AnimationMargin+"px",this._svg.addEventListener("contextmenu",this._onContextMenu.bind(this)),this._activeIntervalGroup=this._svg.createSVGChild("g"),l.installDragHandle(this._activeIntervalGroup,this._mouseDown.bind(this,V.AnimationDrag,null),this._mouseMove.bind(this),this._mouseUp.bind(this),"-webkit-grabbing","-webkit-grab"),Animation.AnimationUI.installDragHandleKeyboard(this._activeIntervalGroup,this._keydownMove.bind(this,Animation.AnimationUI.Events.AnimationDrag,null)),this._cachedElements=[],this._movementInMs=0,this._keyboardMovementRateMs=50,this._color=K.Color(this._animation)}static Color(e){const t=Object.keys(q);return q[t[String.hashCode(e.name()||e.id())%t.length]].asString(i.Format.RGB)}static installDragHandleKeyboard(e,t){e.addEventListener("keydown",t,!1)}animation(){return this._animation}setNode(e){this._node=e}_createLine(e,t){const i=e.createSVGChild("line",t);return i.setAttribute("x1",j.AnimationMargin),i.setAttribute("y1",j.AnimationHeight),i.setAttribute("y2",j.AnimationHeight),i.style.stroke=this._color,i}_drawAnimationLine(e,t){const i=this._cachedElements[e];i.animationLine||(i.animationLine=this._createLine(t,"animation-line")),i.animationLine.setAttribute("x2",(this._duration()*this._timeline.pixelMsRatio()+j.AnimationMargin).toFixed(2))}_drawDelayLine(e){this._delayLine||(this._delayLine=this._createLine(e,"animation-delay-line"),this._endDelayLine=this._createLine(e,"animation-delay-line"));const t=this._animation.source().fill();this._delayLine.classList.toggle("animation-fill","backwards"===t||"both"===t);const i=j.AnimationMargin;this._delayLine.setAttribute("x1",i),this._delayLine.setAttribute("x2",(this._delay()*this._timeline.pixelMsRatio()+i).toFixed(2));const s="forwards"===t||"both"===t;this._endDelayLine.classList.toggle("animation-fill",s);const n=Math.min(this._timeline.width(),(this._delay()+this._duration()*this._animation.source().iterations())*this._timeline.pixelMsRatio());this._endDelayLine.style.transform="translateX("+n.toFixed(2)+"px)",this._endDelayLine.setAttribute("x1",i),this._endDelayLine.setAttribute("x2",s?(this._timeline.width()-n+i).toFixed(2):(this._animation.source().endDelay()*this._timeline.pixelMsRatio()+i).toFixed(2))}_drawPoint(e,t,i,s,n){if(this._cachedElements[e].keyframePoints[s])return void this._cachedElements[e].keyframePoints[s].setAttribute("cx",i.toFixed(2));const a=t.createSVGChild("circle",s<=0?"animation-endpoint":"animation-keyframe-point");if(a.setAttribute("cx",i.toFixed(2)),a.setAttribute("cy",j.AnimationHeight),a.style.stroke=this._color,a.setAttribute("r",j.AnimationMargin/2),a.tabIndex=0,o.setAccessibleName(a,s<=0?ls`Animation Endpoint slider`:ls`Animation Keyframe slider`),s<=0&&(a.style.fill=this._color),this._cachedElements[e].keyframePoints[s]=a,!n)return;let r;r=0===s?V.StartEndpointMove:-1===s?V.FinishEndpointMove:V.KeyframeMove,l.installDragHandle(a,this._mouseDown.bind(this,r,s),this._mouseMove.bind(this),this._mouseUp.bind(this),"ew-resize"),Animation.AnimationUI.installDragHandleKeyboard(a,this._keydownMove.bind(this,r,s))}_renderKeyframe(e,t,i,n,a,r){function h(e,t,i){const s=e.createSVGChild("line");s.setAttribute("x1",t),s.setAttribute("x2",t),s.setAttribute("y1",j.AnimationMargin),s.setAttribute("y2",j.AnimationHeight),s.style.stroke=i}const l=d.CubicBezier.parse(r),_=this._cachedElements[e].keyframeRender;_[t]||(_[t]=l?i.createSVGChild("path","animation-keyframe"):i.createSVGChild("g","animation-keyframe-step"));const m=_[t];if(m.tabIndex=0,o.setAccessibleName(m,ls`${this._animation.name()} slider`),m.style.transform="translateX("+n.toFixed(2)+"px)","linear"===r){m.style.fill=this._color;const e=s.Height;m.setAttribute("d",["M",0,e,"L",0,5,"L",a.toFixed(2),5,"L",a.toFixed(2),e,"Z"].join(" "))}else if(l)m.style.fill=this._color,s.BezierUI.drawVelocityChart(l,m,a);else{const e=O.parse(r);m.removeChildren();const t={start:0,middle:.5,end:1}[e.stepAtPosition];for(let i=0;i<e.steps;i++)h(m,(i+t)*a/e.steps,this._color)}}redraw(){const e=this._timeline.width()-j.AnimationMargin;if(this._svg.setAttribute("width",(e+2*j.AnimationMargin).toFixed(2)),this._activeIntervalGroup.style.transform="translateX("+(this._delay()*this._timeline.pixelMsRatio()).toFixed(2)+"px)",this._nameElement.style.transform="translateX("+(this._delay()*this._timeline.pixelMsRatio()+j.AnimationMargin).toFixed(2)+"px)",this._nameElement.style.width=(this._duration()*this._timeline.pixelMsRatio()).toFixed(2)+"px",this._drawDelayLine(this._svg),"CSSTransition"===this._animation.type())return void this._renderTransition();this._renderIteration(this._activeIntervalGroup,0),this._tailGroup||(this._tailGroup=this._activeIntervalGroup.createSVGChild("g","animation-tail-iterations"));const t=this._duration()*this._timeline.pixelMsRatio();let i;for(i=1;i<this._animation.source().iterations()&&t*(i-1)<this._timeline.width();i++)this._renderIteration(this._tailGroup,i);for(;i<this._cachedElements.length;)this._cachedElements.pop().group.remove()}_renderTransition(){this._cachedElements[0]||(this._cachedElements[0]={animationLine:null,keyframePoints:{},keyframeRender:{},group:null}),this._drawAnimationLine(0,this._activeIntervalGroup),this._renderKeyframe(0,0,this._activeIntervalGroup,j.AnimationMargin,this._duration()*this._timeline.pixelMsRatio(),this._animation.source().easing()),this._drawPoint(0,this._activeIntervalGroup,j.AnimationMargin,0,!0),this._drawPoint(0,this._activeIntervalGroup,this._duration()*this._timeline.pixelMsRatio()+j.AnimationMargin,-1,!0)}_renderIteration(e,t){this._cachedElements[t]||(this._cachedElements[t]={animationLine:null,keyframePoints:{},keyframeRender:{},group:e.createSVGChild("g")});const i=this._cachedElements[t].group;i.style.transform="translateX("+(t*this._duration()*this._timeline.pixelMsRatio()).toFixed(2)+"px)",this._drawAnimationLine(t,i),console.assert(this._keyframes.length>1);for(let e=0;e<this._keyframes.length-1;e++){const s=this._offset(e)*this._duration()*this._timeline.pixelMsRatio()+j.AnimationMargin,n=this._duration()*(this._offset(e+1)-this._offset(e))*this._timeline.pixelMsRatio();this._renderKeyframe(t,e,i,s,n,this._keyframes[e].easing()),(e||!e&&0===t)&&this._drawPoint(t,i,s,e,0===t)}this._drawPoint(t,i,this._duration()*this._timeline.pixelMsRatio()+j.AnimationMargin,-1,0===t)}_delay(){let e=this._animation.source().delay();return this._mouseEventType!==V.AnimationDrag&&this._mouseEventType!==V.StartEndpointMove||(e+=this._movementInMs),Math.max(0,e)}_duration(){let e=this._animation.source().duration();return this._mouseEventType===V.FinishEndpointMove?e+=this._movementInMs:this._mouseEventType===V.StartEndpointMove&&(e-=Math.max(this._movementInMs,-this._animation.source().delay())),Math.max(0,e)}_offset(e){let t=this._keyframes[e].offsetAsNumber();return this._mouseEventType===V.KeyframeMove&&e===this._keyframeMoved&&(console.assert(e>0&&e<this._keyframes.length-1,"First and last keyframe cannot be moved"),t+=this._movementInMs/this._animation.source().duration(),t=Math.max(t,this._keyframes[e-1].offsetAsNumber()),t=Math.min(t,this._keyframes[e+1].offsetAsNumber())),t}_mouseDown(e,i,s){return 2!==s.buttons&&(!this._svg.enclosingNodeOrSelfWithClass("animation-node-removed")&&(this._mouseEventType=e,this._keyframeMoved=i,this._downMouseX=s.clientX,s.consume(!0),this._node&&t.reveal(this._node),!0))}_mouseMove(e){this._setMovementAndRedraw((e.clientX-this._downMouseX)/this._timeline.pixelMsRatio())}_setMovementAndRedraw(e){this._movementInMs=e,this._delay()+this._duration()>.8*this._timeline.duration()&&this._timeline.setDuration(1.2*this._timeline.duration()),this.redraw()}_mouseUp(e){this._movementInMs=(e.clientX-this._downMouseX)/this._timeline.pixelMsRatio(),this._mouseEventType===V.KeyframeMove?this._keyframes[this._keyframeMoved].setOffset(this._offset(this._keyframeMoved)):this._animation.setTiming(this._duration(),this._delay()),this._movementInMs=0,this.redraw(),delete this._mouseEventType,delete this._downMouseX,delete this._keyframeMoved}_keydownMove(e,t,i){switch(this._mouseEventType=e,this._keyframeMoved=t,i.key){case"ArrowLeft":case"ArrowUp":this._movementInMs=-this._keyboardMovementRateMs;break;case"ArrowRight":case"ArrowDown":this._movementInMs=this._keyboardMovementRateMs;break;default:return}this._mouseEventType===Animation.AnimationUI.Events.KeyframeMove?this._keyframes[this._keyframeMoved].setOffset(this._offset(this._keyframeMoved)):this._animation.setTiming(this._duration(),this._delay()),this._setMovementAndRedraw(0),delete this._mouseEventType,delete this._keyframeMoved,i.consume(!0)}_onContextMenu(e){this._animation.remoteObjectPromise().then((function(t){if(!t)return;const i=new _.ContextMenu(e);i.appendApplicableItems(t),i.show()})),e.consume(!0)}}const V={AnimationDrag:"AnimationDrag",KeyframeMove:"KeyframeMove",StartEndpointMove:"StartEndpointMove",FinishEndpointMove:"FinishEndpointMove"},j={AnimationHeight:26,AnimationSVGHeight:50,AnimationMargin:7,EndpointsClickRegionSize:10,GridCanvasHeight:40},q={Purple:i.Color.parse("#9C27B0"),"Light Blue":i.Color.parse("#03A9F4"),"Deep Orange":i.Color.parse("#FF5722"),Blue:i.Color.parse("#5677FC"),Lime:i.Color.parse("#CDDC39"),"Blue Grey":i.Color.parse("#607D8B"),Pink:i.Color.parse("#E91E63"),Green:i.Color.parse("#0F9D58"),Brown:i.Color.parse("#795548"),Cyan:i.Color.parse("#00BCD4")};var U=Object.freeze({__proto__:null,AnimationUI:K,Events:V,Options:j,Colors:q});class z{constructor(e){this._model=e,this.element=document.createElement("div"),this.element.classList.add("animation-buffer-preview"),this.element.createChild("div","animation-paused fill"),this._removeButton=this.element.createChild("div","animation-remove-button"),this._removeButton.textContent="✕",this._replayOverlayElement=this.element.createChild("div","animation-buffer-preview-animation"),this._svg=this.element.createSVGChild("svg"),this._svg.setAttribute("width","100%"),this._svg.setAttribute("preserveAspectRatio","none"),this._svg.setAttribute("height","100%"),this._viewBoxHeight=32,this._svg.setAttribute("viewBox","0 0 100 "+this._viewBoxHeight),this._svg.setAttribute("shape-rendering","crispEdges"),this._render()}_groupDuration(){let e=0;for(const t of this._model.animations()){const i=t.source().delay()+t.source().duration();i>e&&(e=i)}return e}removeButton(){return this._removeButton}replay(){this._replayOverlayElement.animate([{offset:0,width:"0%",opacity:1},{offset:.9,width:"100%",opacity:1},{offset:1,width:"100%",opacity:0}],{duration:200,easing:"cubic-bezier(0, 0, 0.2, 1)"})}_render(){this._svg.removeChildren();const e=Math.min(this._model.animations().length,10),t=100/Math.max(this._groupDuration(),750);for(let i=0;i<e;i++){const s=this._model.animations()[i].source(),n=this._svg.createSVGChild("line");n.setAttribute("x1",s.delay()*t),n.setAttribute("x2",(s.delay()+s.duration())*t);const a=Math.floor(this._viewBoxHeight/Math.max(6,e)*i+1);n.setAttribute("y1",a),n.setAttribute("y2",a),n.style.stroke=K.Color(this._model.animations()[i])}}}var W=Object.freeze({__proto__:null,AnimationGroupPreviewUI:z});export{W as AnimationGroupPreviewUI,R as AnimationModel,B as AnimationScreenshotPopover,H as AnimationTimeline,U as AnimationUI};
